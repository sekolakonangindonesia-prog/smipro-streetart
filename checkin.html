<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-In Meja - SMIPRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS GAYA HITAM MERAH (SAMA SEPERTI ASLINYA) */
        body { background: #050505; color: white; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        .checkin-card {
            background: #111; border: 1px solid #333; padding: 30px; border-radius: 15px; width: 100%; max-width: 400px;
            text-align: center; box-shadow: 0 0 30px rgba(229, 9, 20, 0.2); position: relative;
            <!-- LOGO KECIL POJOK KIRI -->
            <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/Logo_Stretart.png" class="corner-logo">
            }
        
        .warung-logo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #E50914; margin-bottom: 15px; }
        .table-number { font-size: 2.5rem; font-weight: 800; color: white; margin: 10px 0; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-bottom: 20px; }
        .status-free { background: #1a3320; color: #4ade80; border: 1px solid #4ade80; }
        .status-booked { background: #332b00; color: #ffeb3b; border: 1px solid #ffeb3b; }
        .status-active { background: #330000; color: #ff4444; border: 1px solid #ff4444; }

        .input-checkin { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 1rem; box-sizing:border-box; }
        
        .btn-checkin { width: 100%; padding: 12px; background: #E50914; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; margin-top: 10px; }
        .btn-checkin:hover { background: #b71c1c; }

        .suggestion-box { background: #222; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px dashed #555; text-align: left; }
        .free-table-badge { display: inline-block; background: #004d00; color: #00ff00; padding: 3px 8px; border-radius: 5px; margin: 3px; font-weight: bold; font-size: 0.8rem; border: 1px solid #00ff00; }

        /* LOGO POJOK KIRI ATAS */
        .corner-logo {
        position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; 
        border-radius: 50%; border: 2px solid #E50914; object-fit: cover;
        }
    </style>
</head>
<body>

    <div class="checkin-card">
        
        <!-- LOADING -->
        <div id="loading-state">
            <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:#E50914;"></i>
            <p style="color:#888; margin-top:15px;">Mendeteksi Status Meja...</p>
        </div>

        <!-- CONTENT UTAMA -->
        <div id="content-area" style="display:none;">
            <img src="https://via.placeholder.com/100" class="warung-logo" id="warung-img">
            <h3 style="margin:0; color:#ddd;" id="warung-name">Nama Warung</h3>
            
            <div class="table-number" id="table-display">MEJA -</div>
            <div id="status-badge-area"></div>

            <!-- 1. FORM MEJA KOSONG (WALK-IN) -->
            <div id="form-free" style="display:none;">
                <p style="color:#aaa; font-size:0.9rem;">Meja Kosong. Silakan Check-In.</p>
                
                <input type="text" id="walkin-name" class="input-checkin" placeholder="Nama Anda">
                <input type="number" id="walkin-pax" class="input-checkin" placeholder="Jumlah Orang">
                
                <button class="btn-checkin" onclick="window.submitWalkIn()" style="background:#00ff00; color:black;">
                    CHECK-IN SEKARANG
                </button>
            </div>

            <!-- 2. FORM MEJA SUDAH DIBOOKING (PERINGATAN) -->
            <div id="form-booked" style="display:none;">
                <div style="background:#332b00; padding:15px; border-radius:10px; border:1px solid #ffeb3b; margin-bottom:15px;">
                    <i class="fa-solid fa-triangle-exclamation" style="color:#ffeb3b; font-size:2rem; margin-bottom:10px;"></i>
                    <p style="color:#ffeb3b; margin:0; font-size:0.9rem;">
                        Maaf, Meja ini sudah dipesan oleh:<br>
                        <b style="font-size:1.2rem; color:white;" id="booker-name">...</b>
                    </p>
                </div>

                <p style="color:#aaa; font-size:0.8rem; text-align:left;">Apakah ini pesanan Anda?</p>
                <input type="text" id="ticket-code" class="input-checkin" placeholder="MASUKKAN KODE TIKET" style="text-transform:uppercase; letter-spacing:1px; border-color:#E50914;">
                <button class="btn-checkin" onclick="window.verifyTicket()">YA, SAYA PEMESANNYA</button>

                <!-- SARAN MEJA KOSONG -->
                <div class="suggestion-box">
                    <p style="color:#ccc; font-size:0.8rem; margin-top:0;">
                        <i class="fa-solid fa-arrow-right"></i> Bukan Anda? Silakan pindah ke:
                    </p>
                    <div id="suggestion-list">Loading...</div>
                </div>
            </div>

            <!-- 3. FORM MEJA SEDANG DIPAKAI (ACTIVE) -->
            <div id="state-occupied" style="display:none;">
                <div style="padding:20px; border:1px solid #ff4444; border-radius:10px; background:#2a0000;">
                    <h3 style="color:#ff4444; margin:0;">MEJA SEDANG DIGUNAKAN</h3>
                    <p style="color:#ccc;">Silakan cari meja lain.</p>
                </div>
                <div class="suggestion-box">
                    <p style="color:#ccc; font-size:0.8rem; margin-top:0;">Meja yang tersedia:</p>
                    <div id="occupied-suggestion-list"></div>
                </div>
            </div>

            <!-- 4. SUKSES CHECK-IN -->
            <div id="state-success" style="display:none;">
                <i class="fa-solid fa-circle-check" style="color:#00ff00; font-size:4rem; margin-bottom:15px;"></i>
                <h2 style="color:white; margin:0;">SELAMAT DATANG!</h2>
                <p style="color:#ccc;">Pesanan Anda sudah dikonfirmasi.<br>Selamat menikmati.</p>
                <button class="btn-checkin" onclick="location.href='index.html'" style="background:#333; margin-top:20px;">Kembali ke Menu Utama</button>
            </div>

        </div>
    </div>

    <!-- SCRIPT CERDAS (MODULAR) -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { 
            doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, increment 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. AMBIL PARAMETER (checkin.html?w=ID_WARUNG&t=NOMOR_MEJA)
        const params = new URLSearchParams(window.location.search);
        const warungId = params.get('w');
        const tableNum = parseInt(params.get('t'));

        // Variabel Global
        let warungData = null;
        let existingBooking = null; // Data booking orang yang menguasai meja ini

        // 2. INIT SISTEM
        async function initCheckIn() {
            if(!warungId || !tableNum) {
                document.getElementById('loading-state').innerHTML = "<h3 style='color:red'>QR Code Error / Tidak Lengkap</h3>";
                return;
            }

            try {
                // A. Ambil Data Warung
                const wSnap = await getDoc(doc(db, "warungs", warungId));
                if (!wSnap.exists()) { alert("Warung tidak ditemukan!"); return; }
                
                warungData = wSnap.data();
                
                // Update UI Header
                document.getElementById('warung-name').innerText = warungData.name;
                document.getElementById('table-display').innerText = "MEJA " + tableNum;
                if(warungData.img) document.getElementById('warung-img').src = warungData.img;

                // B. CEK STATUS MEJA DI DATABASE
                // Cari booking yang statusnya 'booked' atau 'active' DAN punya nomor meja ini
                const q = query(collection(db, "bookings"), 
                    where("warungName", "==", warungData.name),
                    where("status", "in", ["booked", "active"]),
                    where("tableNum", "array-contains", tableNum) // Cek apakah meja ini ada di dalam array
                );

                const bSnap = await getDocs(q);

                if (!bSnap.empty) {
                    // KASUS 1: MEJA SUDAH ADA YANG PUNYA
                    existingBooking = bSnap.docs[0].data();
                    existingBooking.id = bSnap.docs[0].id; // Simpan ID Dokumen
                    
                    if (existingBooking.status === 'active') {
                        // Sedang Makan (Merah)
                        renderView('occupied');
                    } else {
                        // Sudah Booking tapi Belum Checkin (Kuning)
                        renderView('booked');
                    }
                } else {
                    // KASUS 2: MEJA KOSONG (Hijau)
                    renderView('free');
                }

                // Matikan Loading
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-area').style.display = 'block';

            } catch (e) {
                console.error(e);
                alert("Error Memuat Data: " + e.message);
            }
        }

        // 3. FUNGSI GANTI TAMPILAN
        async function renderView(state) {
            // Sembunyikan semua
            ['form-free', 'form-booked', 'state-occupied', 'state-success'].forEach(id => 
                document.getElementById(id).style.display = 'none'
            );

            const badgeArea = document.getElementById('status-badge-area');

            if (state === 'free') {
                badgeArea.innerHTML = `<span class="status-badge status-free">TERSEDIA (KOSONG)</span>`;
                document.getElementById('form-free').style.display = 'block';
            } 
            else if (state === 'booked') {
                badgeArea.innerHTML = `<span class="status-badge status-booked">SUDAH DI-BOOKING</span>`;
                document.getElementById('booker-name').innerText = existingBooking.customerName;
                document.getElementById('form-booked').style.display = 'block';
                
                // Cari meja kosong untuk rekomendasi
                findEmptyTables('suggestion-list');
            }
            else if (state === 'occupied') {
                badgeArea.innerHTML = `<span class="status-badge status-active">SEDANG DIGUNAKAN</span>`;
                document.getElementById('state-occupied').style.display = 'block';
                findEmptyTables('occupied-suggestion-list');
            }
        }

        // 4. LOGIKA CARI MEJA KOSONG (UNTUK SARAN)
        async function findEmptyTables(targetElementId) {
            const el = document.getElementById(targetElementId);
            el.innerHTML = "Mencari meja kosong...";

            // Ambil semua booking aktif
            const q = query(collection(db, "bookings"), 
                where("warungName", "==", warungData.name),
                where("status", "in", ["booked", "active"])
            );
            const snap = await getDocs(q);
            
            let usedTables = [];
            snap.forEach(d => {
                const nums = d.data().tableNum;
                if(Array.isArray(nums)) usedTables.push(...nums); 
                else usedTables.push(nums);
            });

            // Cari yg tidak dipakai (Max 15)
            let html = "";
            for(let i=1; i<=15; i++) {
                if(!usedTables.includes(i)) {
                    html += `<span class="free-table-badge">Meja ${i}</span>`;
                }
            }
            
            el.innerHTML = html || "<span style='color:red'>Penuh Semua</span>";
        }

        // 5. AKSI: WALK-IN (ORANG DATANG LANGSUNG)
        window.submitWalkIn = async function() {
            const name = document.getElementById('walkin-name').value;
            const pax = document.getElementById('walkin-pax').value;

            if(!name || !pax) return alert("Isi nama dan jumlah orang!");

            const btn = document.querySelector('#form-free button');
            btn.innerText = "Memproses..."; btn.disabled = true;

            try {
                // Simpan Booking Baru (Langsung Active)
                await addDoc(collection(db, "bookings"), {
                    warungName: warungData.name,
                    venueName: warungData.venueName || "", // Penting untuk Laporan Venue
                    customerName: name,
                    pax: parseInt(pax),
                    tablesNeeded: 1,
                    tableNum: [tableNum], // Meja ini saja
                    bookingCode: "WALK-IN",
                    status: 'active', // Langsung makan
                    revenue: 0, // Belum bayar
                    timestamp: new Date(),
                    checkInTime: new Date()
                });

                // Update Stok Warung (+1 Terpakai)
                await updateDoc(doc(db, "warungs", warungId), {
                    bookedCount: increment(1)
                });

                // Tampilkan Sukses
                document.getElementById('form-free').style.display = 'none';
                document.getElementById('state-success').style.display = 'block';
                document.getElementById('status-badge-area').innerHTML = "";

            } catch(e) {
                console.error(e);
                alert("Gagal Check-In: " + e.message);
                btn.innerText = "CHECK-IN SEKARANG"; btn.disabled = false;
            }
        }

        // 6. AKSI: VERIFIKASI TIKET (ORANG YANG BOOKING DATANG)
        window.verifyTicket = async function() {
            const inputCode = document.getElementById('ticket-code').value.trim().toUpperCase();
            
            if(!inputCode) return alert("Masukkan Kode Tiket!");

            // Cek Kesesuaian Kode
            // Kode tiket di input HARUS SAMA dengan kode tiket di database (existingBooking)
            if (!inputCode.startsWith("TIKET-")) {
                inputCode = "TIKET-" + inputCode;
            }

            // Validasi
            if (inputCode !== existingBooking.bookingCode) {
                alert("KODE SALAH!\n\nKode yang anda masukkan: " + inputCode + "\nCek kembali WhatsApp Anda.");
                return;
            }
            
            if(confirm("Kode Benar! Check-In sekarang?")) {
                try {
                    // Update Status jadi 'active'
                    await updateDoc(doc(db, "bookings", existingBooking.id), {
                        status: 'active',
                        checkInTime: new Date()
                    });

                    // Tampilkan Sukses
                    document.getElementById('form-booked').style.display = 'none';
                    document.getElementById('state-success').style.display = 'block';
                    document.getElementById('status-badge-area').innerHTML = "";

                } catch(e) {
                    console.error(e);
                    alert("Gagal Validasi: " + e.message);
                }
            }
        }

        // Jalankan
        initCheckIn();
    </script>
</body>
</html>
