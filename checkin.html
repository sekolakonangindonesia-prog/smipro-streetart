<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-In Meja - SMIPRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }
        .checkin-card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 0 30px rgba(229, 9, 20, 0.2);
        }
        .warung-logo {
            width: 80px; height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            margin-bottom: 15px;
        }
        .table-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .status-free { background: #1a3320; color: #4ade80; border: 1px solid #4ade80; }
        .status-booked { background: #332b00; color: #ffeb3b; border: 1px solid #ffeb3b; }
        .status-active { background: #330000; color: #ff4444; border: 1px solid #ff4444; }

        .input-checkin {
            width: 100%; padding: 12px;
            background: #222; border: 1px solid #444;
            color: white; border-radius: 8px;
            margin-bottom: 10px; text-align: center;
            font-size: 1rem;
        }
        .btn-checkin {
            width: 100%; padding: 12px;
            background: var(--primary); color: white;
            border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer;
            font-size: 1rem; transition: 0.3s;
        }
        .btn-checkin:hover { background: #b71c1c; }

        /* Saran Meja Kosong */
        .suggestion-box {
            margin-top: 15px; padding-top: 15px; border-top: 1px dashed #444;
            display: none;
        }
        .table-chip {
            display: inline-block; background: #333; color: #00ff00;
            padding: 5px 10px; border-radius: 5px; margin: 3px; border: 1px solid #00ff00;
            cursor: pointer;
        }

        /* Menu Preview (Upselling) */
        .menu-preview {
            margin-top: 20px; border-top: 1px dashed #444; padding-top: 20px; display: none;
        }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .menu-item-mini { background: #222; padding: 10px; border-radius: 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="checkin-card">
        
        <!-- LOADING STATE -->
        <div id="loading-state">
            <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--primary);"></i>
            <p style="color:#888; margin-top:15px;">Mendeteksi Meja...</p>
        </div>

        <!-- CONTENT AREA -->
        <div id="content-area" style="display:none;">
            <img src="https://images.unsplash.com/photo-1541544744-5e3a01998cd1?q=80&w=200" class="warung-logo" id="warung-img">
            <h3 style="margin:0; color:#ddd;" id="warung-name">Nama Warung</h3>
            
            <div class="table-number" id="table-display">MEJA -</div>
            <div id="status-badge-area"></div>

            <!-- FORM 1: MEJA KOSONG (WALK-IN) -->
            <div id="form-walkin" style="display:none;">
                <p style="color:#aaa; font-size:0.9rem;">Meja Kosong. Silakan Check-In.</p>
                <input type="text" id="walkin-name" class="input-checkin" placeholder="Nama Anda">
                <input type="number" id="walkin-pax" class="input-checkin" placeholder="Jumlah Orang">
                <button class="btn-checkin" onclick="processWalkIn()">MULAI PESAN</button>
            </div>

            <!-- FORM 2: MEJA DIBOOKING (VERIFIKASI) -->
            <div id="form-verify" style="display:none;">
                <p style="color:#ffeb3b; font-size:0.9rem;">
                    <i class="fa-solid fa-lock"></i> Dipesan oleh: <b id="booker-name">...</b>
                </p>
                
                <input type="text" id="verify-code" class="input-checkin" placeholder="KODE TIKET (Dari WA)" style="letter-spacing: 2px; text-transform:uppercase;">
                <button class="btn-checkin" onclick="processVerification()">VERIFIKASI & DUDUK</button>

                <!-- SARAN MEJA LAIN -->
                <div class="suggestion-box" id="suggestion-area">
                    <p style="color:#ccc; font-size:0.8rem;">Bukan pesanan Anda?<br>Gunakan meja kosong ini:</p>
                    <div id="free-tables-list">
                        <!-- List meja kosong di sini -->
                    </div>
                </div>
            </div>

            <!-- FORM 3: MEJA SEDANG DIPAKAI -->
            <div id="state-occupied" style="display:none;">
                <p style="color:#ff4444; font-weight:bold;">MEJA SEDANG DIGUNAKAN</p>
                <p style="color:#888; font-size:0.9rem;">Silakan cari meja lain.</p>
                <button class="btn-checkin" style="background:#333;" onclick="location.reload()">Refresh Status</button>
            </div>

            <!-- SUKSES CHECKIN -->
            <div id="state-success" style="display:none;">
                <i class="fa-solid fa-circle-check" style="color:#00ff00; font-size:3rem; margin-bottom:10px;"></i>
                <h3 style="color:white; margin:0;">Check-In Berhasil!</h3>
                <p style="color:#ccc;">Silakan pesan menu ke pelayan.</p>
                
                <!-- MENU DIGITAL -->
                <div class="menu-preview" style="display:block;">
                    <h4 style="color:var(--accent); margin-top:0;">Menu Favorit</h4>
                    <div class="menu-grid">
                        <div class="menu-item-mini">Nasi Kucing<br><b style="color:gold;">Rp 3.000</b></div>
                        <div class="menu-item-mini">Sate Usus<br><b style="color:gold;">Rp 2.000</b></div>
                        <div class="menu-item-mini">Kopi Joss<br><b style="color:gold;">Rp 5.000</b></div>
                        <div class="menu-item-mini">Wedang Jahe<br><b style="color:gold;">Rp 4.000</b></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- SCRIPT FIREBASE COMPAT (NO MODULE ERROR) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBZcysu-eljECIpQCG7tBKowuN-H8hIRFk",
            authDomain: "smipro-app.firebaseapp.com",
            projectId: "smipro-app",
            storageBucket: "smipro-app.firebasestorage.app",
            messagingSenderId: "1052427998270",
            appId: "1:1052427998270:web:5f70ea06e4b10b50fe2d6f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // AMBIL PARAMETER URL (QR CODE)
        // Contoh URL: checkin.html?w=warung_bu_sri&t=5
        const params = new URLSearchParams(window.location.search);
        const warungId = params.get('w');
        const tableNum = parseInt(params.get('t'));

        let currentBookingId = null; 

        // --- 1. INISIALISASI ---
        async function initCheckIn() {
            if(!warungId || !tableNum) {
                document.getElementById('loading-state').innerHTML = "<h3 style='color:red'>QR Code Tidak Valid</h3><p>Pastikan Anda scan QR yang benar.</p>";
                return;
            }

            // Ambil Info Warung
            const docRef = db.collection("warungs").doc(warungId);
            const docSnap = await docRef.get();
            
            if(docSnap.exists) {
                const wData = docSnap.data();
                document.getElementById('warung-name').innerText = wData.name;
                document.getElementById('table-display').innerText = "MEJA " + tableNum;
                if(wData.img) document.getElementById('warung-img').src = wData.img;
            }

            // JALANKAN PROSES
            await checkExpiredBookings(); // Bersihkan yang expired
            await checkTableStatus();     // Cek status meja ini
            
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('content-area').style.display = 'block';
        }

        // --- 2. HAPUS BOOKING BASI (LEWAT 30 MENIT) ---
        async function checkExpiredBookings() {
            const now = new Date();
            // Ambil format jam menit sekarang HH:MM
            const currentHours = String(now.getHours()).padStart(2, '0');
            const currentMinutes = String(now.getMinutes()).padStart(2, '0');
            const currentTimeStr = `${currentHours}:${currentMinutes}`;

            // Logic: Ambil semua booking yang statusnya 'booked'
            // Kita filter manual di client side untuk jam expirednya
            const snapshot = await db.collection("bookings")
                .where("warungName", "==", document.getElementById('warung-name').innerText) // Filter nama warung (atau ID lebih baik)
                .where("status", "==", "booked")
                .get();

            const batch = db.batch();
            let hasExpired = false;

            snapshot.forEach((doc) => {
                const data = doc.data();
                // Jika expiredTime ada dan waktu sekarang sudah melewatinya
                if (data.expiredTime && currentTimeStr > data.expiredTime) {
                    console.log(`Booking ${doc.id} expired (${data.expiredTime}). Menghapus...`);
                    batch.delete(doc.ref);
                    hasExpired = true;
                }
            });

            if(hasExpired) await batch.commit();
        }

        // --- 3. CEK STATUS MEJA ---
        async function checkTableStatus() {
            // Cari apakah meja ini ada di booking list
            const snapshot = await db.collection("bookings")
                .where("warungName", "==", document.getElementById('warung-name').innerText)
                // Catatan: Idealnya pakai warungId, tapi di kode sebelumnya kita simpan warungName. 
                // Untuk konsistensi prototype, kita pakai logika filter manual tableNum di client side 
                // jika struktur DB belum support query complex.
                .get();

            let status = 'free';
            let bookingData = null;

            // Filter manual untuk TableNum (Karena di venue-stadion kita simpan 'tablesNeeded' bukan spesifik meja)
            // TAPI: Untuk sistem QR Meja, kita asumsikan Mitra sudah assign meja di dashboard 
            // ATAU sistem ini yang assign meja.
            
            // LOGIKA CHECKIN STANDAR:
            // Kita cari dokumen booking yang tableNum-nya sama dengan QR.
            // (Field tableNum di-update saat check-in, atau saat booking jika pilih meja)
            
            // Revisi Logika Sesuai Diskusi:
            // 1. Cari booking 'active' di meja ini -> OCCUPIED
            // 2. Cari booking 'booked' yang belum punya meja -> INI KASUS KHUSUS (User belum dapat nomor meja saat booking online)
            
            // KITA SIMPLIFIKASI UNTUK DEMO:
            // Kita anggap booking online BELUM punya nomor meja. 
            // Jadi saat scan QR, User memasukkan kode -> Jika valid, booking tsb di-assign ke meja ini.
            
            // Cek apakah meja ini SUDAH DIPAKAI orang lain (Active)
            const activeSnap = await db.collection("bookings")
                .where("status", "==", "active")
                .where("tableNum", "==", tableNum)
                .get();

            if(!activeSnap.empty) {
                status = 'active'; // Meja sedang dipakai makan
            } else {
                // Cek apakah meja ini DIBOOKING SPESIFIK? (Fitur Advance)
                // Jika tidak, berarti meja ini FREE, tapi bisa diklaim oleh Walk-in atau Online Booker.
                status = 'free'; 
            }

            renderForm(status);
        }

        async function renderForm(status) {
            document.getElementById('form-walkin').style.display = 'none';
            document.getElementById('form-verify').style.display = 'none';
            document.getElementById('state-occupied').style.display = 'none';

            if(status === 'active') {
                document.getElementById('status-badge-area').innerHTML = `<span class="status-badge status-active">SEDANG DIGUNAKAN</span>`;
                document.getElementById('state-occupied').style.display = 'block';
            } else {
                // Status FREE: Bisa untuk Walk-in ATAU Verifikasi Booking Online
                document.getElementById('status-badge-area').innerHTML = `<span class="status-badge status-free">TERSEDIA</span>`;
                
                // Tampilkan DUA OPSI sekaligus (Tab-like atau Atas Bawah)
                // Sesuai request: "Scant QR -> Masukkan Kode (Jika Booking) ATAU Isi Nama (Jika Walkin)"
                
                // Kita modifikasi tampilan agar user memilih
                document.getElementById('form-verify').style.display = 'block'; // Default Verifikasi dulu
                document.getElementById('booker-name').innerText = "-"; // Reset
                
                // Modifikasi UI Form Verify agar juga melayani Walk-in
                const verifyDiv = document.getElementById('form-verify');
                verifyDiv.innerHTML = `
                    <p style="color:#aaa;">Punya Kode Booking?</p>
                    <input type="text" id="verify-code" class="input-checkin" placeholder="Masukkan Kode Tiket" style="letter-spacing:2px; text-transform:uppercase;">
                    <button class="btn-checkin" onclick="processVerification()">VERIFIKASI TIKET</button>
                    
                    <hr style="border:0; border-top:1px dashed #444; margin:20px 0;">
                    
                    <p style="color:#aaa;">Belum Booking? (Tamu Langsung)</p>
                    <input type="text" id="walkin-name" class="input-checkin" placeholder="Nama Anda">
                    <input type="number" id="walkin-pax" class="input-checkin" placeholder="Jumlah Orang">
                    <button class="btn-checkin" style="background:#333; border:1px solid #555;" onclick="processWalkIn()">CHECK-IN LANGSUNG</button>
                `;
            }
        }

        // --- 4. PROSES CHECK-IN (WALK-IN) ---
        window.processWalkIn = async function() {
            const name = document.getElementById('walkin-name').value;
            const pax = document.getElementById('walkin-pax').value;
            const warungName = document.getElementById('warung-name').innerText;

            if(!name || !pax) return alert("Mohon isi data tamu!");

            await db.collection("bookings").add({
                warungName: warungName, // Simpan nama warung agar sinkron
                // warungId: warungId, // Idealnya simpan ID juga
                tableNum: tableNum, // Assign Meja ini
                customerName: name,
                pax: pax,
                status: 'active',
                timestamp: new Date(),
                isWalkIn: true
            });
            
            showSuccess();
        }

        // --- 5. PROSES VERIFIKASI (BOOKING ONLINE) ---
        window.processVerification = async function() {
            const code = document.getElementById('verify-code').value.toUpperCase();
            if(!code) return alert("Masukkan Kode Tiket!");

            // Cari booking dengan kode tersebut
            const snapshot = await db.collection("bookings")
                .where("bookingCode", "==", code)
                .where("status", "==", "booked") // Harus yang belum check-in
                .get();

            if(snapshot.empty) {
                alert("Kode Tiket Tidak Ditemukan atau Sudah Terpakai!");
                return;
            }

            // Ambil Dokumen Pertama
            const docSnap = snapshot.docs[0];
            const data = docSnap.data();

            // Cek apakah warungnya benar?
            // (Opsional, tapi bagus untuk keamanan)
            // if(data.warungName !== document.getElementById('warung-name').innerText) ...

            // UPDATE STATUS JADI ACTIVE & ASSIGN MEJA
            await db.collection("bookings").doc(docSnap.id).update({
                status: 'active',
                tableNum: tableNum, // Meja tempat dia scan QR
                checkInTime: new Date()
            });

            showSuccess();
        }

        function showSuccess() {
            document.getElementById('form-verify').style.display = 'none';
            document.getElementById('status-badge-area').innerHTML = `<span class="status-badge status-active">CHECK-IN SUKSES</span>`;
            document.getElementById('state-success').style.display = 'block';
        }

        // AUTO RUN
        initCheckIn();
    </script>
</body>
</html>
