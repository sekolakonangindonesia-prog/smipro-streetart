<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Performer - SMIPRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* HEADER PROFIL */
        .perf-header { 
            height: 220px; 
            background: linear-gradient(to bottom, #333, #121212), url('https://images.unsplash.com/photo-1501612780327-450456b106f8?q=80&w=1000');
            background-size: cover;
            background-blend-mode: multiply;
            position: relative; 
            display: flex; 
            align-items: end; 
            padding: 20px; 
        }
        
        .perf-pic-container {
            width: 100px; height: 100px;
            margin-right: 20px;
            position: relative;
            z-index: 5;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .perf-pic { 
            width: 100%; height: 100%; 
            border-radius: 50%; object-fit: cover; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            border: 4px solid var(--accent); 
            background:#000; 
        }
        .edit-badge {
            position: absolute; bottom: 5px; right: 5px;
            background: var(--primary); color: white;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white; font-size: 0.8rem;
            transition: 0.3s;
        }
        .perf-pic-container:hover .edit-badge { transform: scale(1.1); background: var(--accent); color: black; }

        .perf-info { z-index: 2; }
        .perf-info h1 { margin: 0; font-size: 1.8rem; color: white; }
        .perf-info p { color: #ccc; margin: 5px 0; font-size:0.9rem; }
        .verified-badge { background: #1a3320; color: #4ade80; padding: 4px 10px; border-radius: 15px; font-size: 0.7rem; display: inline-flex; align-items: center; gap: 5px; border: 1px solid #4ade80; margin-bottom:5px; }

        .header-logo-corner { position: absolute; top: 15px; left: 15px; width: 50px; z-index: 10; filter: drop-shadow(0 0 5px rgba(0,0,0,0.8)); }
        .header-nav-corner { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; z-index: 10; }
        .btn-nav-header { background: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        .btn-nav-header:hover { background: rgba(255,255,255,0.2); }
        .btn-logout { background: rgba(229, 9, 20, 0.8); border: none; }
        .btn-logout:hover { background: #E50914; }

        .mitra-tabs { display: flex; justify-content: space-around; background: #111; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; background: none; border: none; color: #888; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: var(--accent); }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .track-card { background: #181818; padding: 15px; border-radius: 8px; transition: 0.3s; cursor: pointer; border: 1px solid transparent; position: relative; }
        .track-card:hover { background: #282828; border-color: #444; }
        .track-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 5px; margin-bottom: 10px; background: #333; }
        .track-title { font-weight: bold; color: white; font-size: 0.9rem; margin-bottom: 5px; display: block; }
        .track-type { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #aaa; }
        .play-icon { position: absolute; bottom: 80px; right: 20px; background: var(--green); color: black; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; box-shadow: 0 5px 10px rgba(0,0,0,0.5); }
        .track-card:hover .play-icon { opacity: 1; bottom: 90px; }

        .doc-item { display: flex; align-items: center; background: #222; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #444; }
        .doc-icon { font-size: 2rem; color: var(--primary); margin-right: 15px; }
        .btn-action-doc { background: #333; border: 1px solid #555; color: white; padding: 5px 15px; border-radius: 20px; cursor: pointer; margin-left: 5px; font-size:0.8rem; }
        .btn-action-doc:hover { background: var(--accent); color: black; border-color:var(--accent); }

        .rating-summary { background: linear-gradient(135deg, #1a1a1a 0%, #000 100%); padding: 20px; border-radius: 15px; border: 1px solid var(--accent); text-align: center; margin-bottom: 20px; }
        .rating-big { font-size: 3rem; font-weight: 800; color: var(--accent); line-height: 1; }
        .review-card { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #444; }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; color: #ccc; }
        .review-text { font-style: italic; color: white; font-size: 0.95rem; }
    </style>
    <!-- Library untuk Cetak PDF Otomatis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <!-- 1. HEADER PROFIL -->
    <div class="perf-header">
        <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/Logo_Stretart.png" class="header-logo-corner" alt="Logo">

        <div class="header-nav-corner">
            <button onclick="location.href='index.html'" class="btn-nav-header" id="nav-home-btn"><i class="fa-solid fa-house"></i> Home</button>
            <button onclick="prosesLogout()" class="btn-nav-header btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>

        <div class="perf-pic-container" onclick="triggerUpload()">
            <img src="https://images.unsplash.com/photo-1570295999919-56ceb5ecca61?q=80&w=300" class="perf-pic" id="header-profile-img">
            <div class="edit-badge"><i class="fa-solid fa-camera"></i></div>
        </div>

        <div class="perf-info">
            <div class="verified-badge"><i class="fa-solid fa-circle-check"></i> Certified Performer</div>
            <h1>The Acoustic Boys</h1>
            <p>ID: SMIPRO-024 ‚Ä¢ Pop Jawa & Koplo</p>
        </div>
    </div>

    <!-- 2. TAB MENU -->
    <div class="mitra-tabs">
        <button class="tab-btn active" onclick="switchTab('galeri')">üéµ Galeri</button>
        <button class="tab-btn" onclick="switchTab('dokumen')">üìÑ Dokumen</button>
        <button class="tab-btn" onclick="switchTab('ulasan')">‚≠ê Ulasan</button>
        <button class="tab-btn" onclick="switchTab('profil')">‚öôÔ∏è Profil</button>
    </div>

    <div class="container">
        <input type="file" id="file-input" style="display:none;" accept="image/*" onchange="previewImage(this)">

        <!-- TAB 1: GALERI (BARU) -->
        <div id="tab-galeri" class="tab-content active">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="color:var(--accent); margin-top:0;">Rekaman Performance</h3>
                    <p style="color:#888; font-size:0.9rem; margin-top:-5px;">Dokumentasi hasil editing.</p>
                </div>
                <!-- TOMBOL KHUSUS ADMIN/MENTOR -->
                <button id="btn-add-gallery" onclick="openAddModal()" style="display:none; background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">
                    <i class="fa-solid fa-plus"></i> Tambah Konten
                </button>
            </div>

            <!-- Grid Galeri Dinamis -->
            <div class="track-grid" id="gallery-container">
                <p style="color:#666;">Memuat galeri...</p>
            </div>
        </div>

        <!-- TAB 2: DOKUMEN (FIXED BUTTONS) -->
        <div id="tab-dokumen" class="tab-content">
            <h3>Dokumen Legalitas</h3>
            
            <!-- DOKUMEN 1: SERTIFIKAT -->
            <div class="doc-item">
                <i class="fa-solid fa-certificate doc-icon"></i>
                <div style="flex:1;">
                    <b>Sertifikat Kompetensi</b><br>
                    <small id="cert-status" style="color:#aaa;">Menunggu Verifikasi Admin</small>
                </div>
                <!-- Tombol LIHAT (Mata) -->
                <button id="btn-view-cert" class="btn-action-doc" onclick="generatePDF('sertifikat', 'view')" disabled style="opacity:0.5; margin-right:5px; background:#00d2ff; border-color:#00d2ff; color:black;">
                    <i class="fa-solid fa-eye"></i> Lihat
                </button>
                <!-- Tombol UNDUH (Download) -->
                <button id="btn-dl-cert" class="btn-action-doc" onclick="generatePDF('sertifikat', 'download')" disabled style="opacity:0.5;">
                    <i class="fa-solid fa-download"></i> Unduh
                </button>
            </div>

            <!-- DOKUMEN 2: MOU -->
            <div class="doc-item" style="border-color:var(--primary);">
                <i class="fa-solid fa-file-contract doc-icon"></i>
                <div style="flex:1;">
                    <b>MOU Kontrak Management</b><br>
                    <small id="mou-status" style="color:var(--primary);">Menunggu Tanda Tangan</small>
                </div>
                <!-- Tombol LIHAT (Mata) -->
                <button id="btn-view-mou" class="btn-action-doc" onclick="generatePDF('mou', 'view')" disabled style="opacity:0.5; margin-right:5px; background:#00d2ff; border-color:#00d2ff; color:black;">
                    <i class="fa-solid fa-eye"></i> Lihat
                </button>
                <!-- Tombol UNDUH (Download) -->
                <button id="btn-dl-mou" class="btn-action-doc" onclick="generatePDF('mou', 'download')" disabled style="opacity:0.5;">
                    <i class="fa-solid fa-download"></i> Unduh
                </button>
            </div>
        </div>

        <!-- TAB 3: ULASAN -->
        <div id="tab-ulasan" class="tab-content">
            <div class="rating-summary">
                <div class="rating-big">4.8</div>
                <div style="color:gold; margin:5px 0;"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half-stroke"></i></div>
                <small style="color:#aaa;">Berdasarkan 128 Ulasan Penonton</small>
            </div>
            <h3 style="margin-bottom:15px;">Komentar Terbaru</h3>
            <div class="review-card">
                <div class="review-header"><span><i class="fa-solid fa-user"></i> Budi Santoso</span><span style="color:gold;">‚òÖ 5.0</span></div>
                <div class="review-text">"Gokil suaranya! Lagu Nemen-nya bikin ambyar. Sukses terus mas!"</div>
            </div>
        </div>

        <!-- TAB 4: PROFIL (FIXED EDIT NAME) -->
        <div id="tab-profil" class="tab-content">
            <div style="background:#222; padding:20px; border-radius:10px; border:1px solid #333;">
                <h3 style="margin-top:0; color:#E50914;">Edit Profil & Sosmed</h3>
                
                <!-- FOTO -->
                <div style="text-align:center; margin-bottom:20px; padding:15px; border:1px dashed #444; border-radius:10px;">
                    <img src="" id="preview-profile-img" style="width:80px; height:80px; border-radius:50%; object-fit:cover; margin-bottom:10px; border:2px solid #555;">
                    <br>
                    <button class="btn-nav-header" onclick="triggerUpload()" style="margin:0 auto; background:#333;">
                        <i class="fa-solid fa-camera"></i> Ganti Foto Profil
                    </button>
                </div>

                <!-- INFO DASAR (SUDAH BISA DIEDIT) -->
                <label style="color:#aaa; font-size:0.8rem;">Nama Panggung</label>
                <input type="text" id="edit-name" style="width:100%; padding:10px; background:#111; border:1px solid #444; color:white; margin-bottom:15px; border-radius:5px;" placeholder="Ganti nama panggung...">
                
                <label style="color:#aaa; font-size:0.8rem;">Bio Singkat</label>
                <textarea id="edit-bio" style="width:100%; padding:10px; background:#111; border:1px solid #444; color:white; margin-bottom:15px; border-radius:5px; height:80px;" placeholder="Deskripsikan gaya musikmu..."></textarea>

                <!-- SOSIAL MEDIA -->
                <h4 style="color:#888; border-bottom:1px solid #444; padding-bottom:5px;">Tautan Sosial Media</h4>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <i class="fa-brands fa-instagram" style="color:#C13584; width:20px;"></i>
                    <input type="text" id="edit-ig" placeholder="Link Instagram (https://...)" style="flex:1; padding:10px; background:#111; border:1px solid #444; color:white; border-radius:5px;">
                </div>

                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <i class="fa-brands fa-tiktok" style="color:#00f2ea; width:20px;"></i>
                    <input type="text" id="edit-tiktok" placeholder="Link TikTok" style="flex:1; padding:10px; background:#111; border:1px solid #444; color:white; border-radius:5px;">
                </div>

                <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                    <i class="fa-brands fa-youtube" style="color:#ff0000; width:20px;"></i>
                    <input type="text" id="edit-yt" placeholder="Link Channel YouTube" style="flex:1; padding:10px; background:#111; border:1px solid #444; color:white; border-radius:5px;">
                </div>

                <button style="background:var(--primary); color:white; border:none; padding:12px; width:100%; border-radius:5px; font-weight:bold; cursor:pointer; font-size:1rem;" onclick="saveProfileData()">
                    <i class="fa-solid fa-floppy-disk"></i> SIMPAN PERUBAHAN
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL PREVIEW PDF -->
    <div id="pdf-preview-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:6000; align-items:center; justify-content:center; flex-direction:column; padding:10px;">
        <div style="width:100%; max-width:800px; display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 style="color:white; margin:0;">Pratinjau Dokumen</h3>
            <button onclick="closePdfPreview()" style="background:red; color:white; border:none; padding:5px 15px; cursor:pointer; font-weight:bold; border-radius:5px;">TUTUP X</button>
        </div>
        <iframe id="pdf-frame" style="width:100%; height:80vh; border:none; background:white; border-radius:10px;"></iframe>
    </div>

    <!-- === TOMBOL KHUSUS ADMIN === -->
    <div id="admin-floating-btn" style="display:none; position:fixed; bottom:20px; right:20px; z-index:9999;">
        <button onclick="backToAdminDashboard()" style="background:#E50914; color:white; padding:12px 20px; border:2px solid white; border-radius:30px; font-weight:bold; cursor:pointer; box-shadow:0 5px 20px rgba(0,0,0,0.8); display:flex; align-items:center; gap:10px;">
            <i class="fa-solid fa-user-shield"></i> KEMBALI KE ADMIN
        </button>
    </div>

    <!-- MODAL INPUT GALERI (ADMIN ONLY) -->
    <div id="modal-add-gallery" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center; padding:20px;">
        <div style="background:#222; width:100%; max-width:400px; padding:20px; border-radius:10px; border:1px solid #444;">
            <h3 style="margin-top:0; color:white;">Tambah Galeri</h3>
            
            <label style="color:#aaa; font-size:0.8rem;">Judul Lagu/Video</label>
            <input type="text" id="add-title" style="width:100%; padding:10px; background:#111; border:1px solid #444; color:white; margin-bottom:10px; border-radius:5px;">

            <label style="color:#aaa; font-size:0.8rem;">Tipe Konten</label>
            <select id="add-type" style="width:100%; padding:10px; background:#111; border:1px solid #444; color:white; margin-bottom:10px; border-radius:5px;">
                <option value="video">Video (YouTube)</option>
                <option value="audio">Audio (MP3 Link)</option>
            </select>

            <label style="color:#aaa; font-size:0.8rem;">Link URL</label>
            <input type="text" id="add-url" placeholder="YouTube / MP3 Link" style="width:100%; padding:10px; background:#111; border:1px solid #444; color:white; margin-bottom:10px; border-radius:5px;">

            <label style="color:#aaa; font-size:0.8rem;">Link Thumbnail (Opsional)</label>
            <input type="text" id="add-thumb" placeholder="https://..." style="width:100%; padding:10px; background:#111; border:1px solid #444; color:white; margin-bottom:20px; border-radius:5px;">

            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('modal-add-gallery').style.display='none'" style="flex:1; padding:10px; background:#444; border:none; color:white; border-radius:5px; cursor:pointer;">Batal</button>
                <button onclick="saveGalleryItem()" style="flex:1; padding:10px; background:var(--primary); border:none; color:white; border-radius:5px; cursor:pointer;">Simpan</button>
            </div>
        </div>
    </div>

    <!-- MODAL PLAYER -->
    <div id="modal-player" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:4000; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
        <button onclick="closePlayer()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:2rem; cursor:pointer;">&times;</button>
        <div id="player-content" style="width:100%; max-width:800px; text-align:center;"></div>
    </div>

    <!-- SCRIPT TUNGGAL DAN LENGKAP -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // --- IMPORT JSPDF ---
        const { jsPDF } = window.jspdf;

        // ID Performer yang sedang login/diedit
        const PERF_ID = localStorage.getItem('performerId');
        
        // Cek Hak Akses (Privilege)
        const userRole = localStorage.getItem('userRole');
        const isAdmin = localStorage.getItem('adminOrigin') === 'true';
        // Hanya Admin atau Mentor yang boleh Edit (Tambah/Hapus)
        const canEdit = isAdmin || userRole === 'mentor';

        // --- 1. LOGIKA UTAMA SAAT LOAD ---
        window.onload = function() {
            // Validasi Login
            if(!localStorage.getItem('userLoggedIn')) {
                window.location.href = 'index.html';
                return;
            }

            const navBtn = document.getElementById('nav-home-btn');

            // Load Data Profil dari Firebase
            if(PERF_ID) {
                loadProfileData();
            } else {
                alert("Error: ID Performer tidak ditemukan. Silakan login ulang.");
            }

            // A. LOGIKA TAMPILAN SESUAI HAK AKSES
            if (canEdit) {
                // Tampilkan Tombol Tambah Galeri HANYA untuk Admin/Mentor
                document.getElementById('btn-add-gallery').style.display = 'block';
            }

            // B. NAVIGASI KHUSUS MENTOR
            if(userRole === 'mentor') {
                navBtn.innerHTML = '<i class="fa-solid fa-arrow-left"></i> Kembali ke Mentor';
                navBtn.onclick = function(e) { e.preventDefault(); window.location.href = 'mentor-dashboard.html'; };
            }

            // C. NAVIGASI KHUSUS ADMIN
            if (isAdmin) {
                document.getElementById('admin-floating-btn').style.display = 'block';
                setTimeout(() => {
                    const oldBtn = document.getElementById('nav-home-btn');
                    if (oldBtn && userRole !== 'mentor') { 
                        const newBtn = oldBtn.cloneNode(true);
                        newBtn.innerHTML = '<i class="fa-solid fa-house"></i> Home (Super Admin)';
                        newBtn.onclick = function(e) {
                            e.preventDefault(); e.stopPropagation();
                            if(confirm("Kembali ke Home sebagai SUPER ADMIN?")) {
                                localStorage.setItem('userRole', 'admin');
                                localStorage.setItem('userName', 'Super Admin');
                                localStorage.setItem('userLink', 'admin-dashboard.html'); 
                                window.location.href = 'index.html';
                            }
                        };
                        oldBtn.parentNode.replaceChild(newBtn, oldBtn);
                    }
                }, 500);
            }

            // D. LOAD GALERI
            loadGallery();
        };

        // --- 2. FUNGSI LOAD DATA ---
        async function loadProfileData() {
            try {
                const docRef = doc(db, "performers", PERF_ID);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Header
                    document.querySelector('.perf-info h1').innerText = data.name;
                    document.querySelector('.perf-info p').innerText = `Genre: ${data.genre} ‚Ä¢ Rating: ${data.rating || '-'}`;
                    if(data.img) {
                        document.getElementById('header-profile-img').src = data.img;
                        document.getElementById('preview-profile-img').src = data.img;
                    }

                    // Form Edit
                    document.getElementById('edit-name').value = data.name;
                    document.getElementById('edit-bio').value = data.bio || "";
                    document.getElementById('edit-ig').value = data.link_ig || "";
                    document.getElementById('edit-tiktok').value = data.link_tiktok || "";
                    document.getElementById('edit-yt').value = data.link_yt || "";

                    // Cek Status Dokumen
                    checkDocStatus(data);

                } else {
                    console.log("No such document!");
                }
            } catch (e) {
                console.error("Error loading profile:", e);
            }
        }

        function checkDocStatus(data) {
            const btnCert = document.getElementById('btn-dl-cert');
            const btnViewCert = document.getElementById('btn-view-cert'); 
            const txtCert = document.getElementById('cert-status');
            const btnMou = document.getElementById('btn-dl-mou');
            const btnViewMou = document.getElementById('btn-view-mou'); 
            const txtMou = document.getElementById('mou-status');

            if (data.verified) {
                if(btnCert) { btnCert.disabled = false; btnCert.style.opacity = "1"; }
                if(btnViewCert) { btnViewCert.disabled = false; btnViewCert.style.opacity = "1"; }
                if(txtCert) txtCert.innerHTML = "<span style='color:#00ff00'>Terverifikasi & Lulus</span>";
                if(btnMou) { btnMou.disabled = false; btnMou.style.opacity = "1"; }
                if(btnViewMou) { btnViewMou.disabled = false; btnViewMou.style.opacity = "1"; }
                if(txtMou) txtMou.innerHTML = "<span style='color:#00ff00'>Kontrak Aktif</span>";
            } else {
                if(txtCert) txtCert.innerHTML = "<span style='color:orange'>Belum Verifikasi Admin</span>";
            }
        }

        // --- 3. GALERI (LOGIKA BARU: DELETE HANYA UNTUK ADMIN/MENTOR) ---
        let galleryData = [];

        function loadGallery() {
            // Gunakan onSnapshot agar realtime
            const docRef = doc(db, "performers", PERF_ID);
            // Kita panggil getDoc atau listener terpisah jika mau realtime update
            // Untuk simplifikasi, kita pakai getDoc lagi di sini khusus galeri saat load
            getDoc(docRef).then((snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    renderGallery(d.gallery || []);
                }
            });
        }

        function renderGallery(data) {
            galleryData = data;
            const container = document.getElementById('gallery-container');
            container.innerHTML = '';

            if(galleryData.length === 0) {
                container.innerHTML = '<p style="color:#666;">Belum ada konten.</p>';
                return;
            }

            galleryData.forEach((item, index) => {
                let icon = item.type === 'video' ? 'fa-video' : 'fa-music';
                let typeText = item.type === 'video' ? 'Video' : 'Audio';
                
                // Thumbnail Youtube
                let thumb = "https://via.placeholder.com/300x200?text=Audio"; 
                if (item.type === 'video' && item.url.includes('embed/')) {
                    const vidId = item.url.split('embed/')[1].split('?')[0];
                    thumb = `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`;
                }

                // SIAPKAN TOMBOL HAPUS (Hanya Jika Admin/Mentor)
                let deleteButtonHTML = '';
                if (canEdit) {
                    deleteButtonHTML = `
                    <button onclick="deleteGalleryItem(${index}); event.stopPropagation();" style="margin-top:5px; background:#b71c1c; color:white; border:none; width:100%; border-radius:3px; cursor:pointer; padding:5px;">
                        <i class="fa-solid fa-trash"></i> Hapus
                    </button>`;
                }

                container.innerHTML += `
                <div class="track-card" onclick="playMedia('${item.type}', '${item.url}')" style="cursor:pointer;">
                    <img src="${thumb}" class="track-img">
                    <div class="play-icon"><i class="fa-solid fa-play"></i></div>
                    <span class="track-title">${item.title}</span>
                    <span class="track-type"><i class="fa-solid ${icon}"></i> ${typeText}</span>
                    ${deleteButtonHTML}
                </div>`;
            });
        }

        window.saveGalleryItem = async function() {
            // Security Check
            if(!canEdit) return alert("Akses Ditolak! Hanya Admin/Mentor yang bisa menambah konten.");

            const title = document.getElementById('add-title').value;
            const type = document.getElementById('add-type').value;
            let url = document.getElementById('add-url').value;
            const thumb = document.getElementById('add-thumb').value;

            if(!title || !url) return alert("Isi data!");
            if(type === 'video' && url.includes('watch?v=')) url = url.replace('watch?v=', 'embed/');
            if(type === 'video' && url.includes('youtu.be/')) {
                const id = url.split('youtu.be/')[1];
                url = `https://www.youtube.com/embed/${id}`;
            }

            const newItem = { id: Date.now(), type, title, url, thumb: thumb || 'https://via.placeholder.com/300' };
            const newGallery = [...galleryData, newItem];
            
            await updateDoc(doc(db, "performers", PERF_ID), { gallery: newGallery });

            alert("Konten Ditambahkan!");
            document.getElementById('modal-add-gallery').style.display = 'none';
            loadGallery(); // Reload
        }

        window.deleteGalleryItem = async function(index) {
            // Security Check
            if(!canEdit) return alert("Akses Ditolak! Hanya Admin/Mentor yang bisa menghapus.");

            if(confirm("Hapus konten ini?")) {
                const newGallery = galleryData.filter((_, i) => i !== index);
                await updateDoc(doc(db, "performers", PERF_ID), { gallery: newGallery });
                loadGallery(); // Reload
            }
        }

        // --- FUNGSI LAIN (SAVE PROFIL, PDF, UPLOAD FOTO) ---
        window.saveProfileData = async function() {
            if(!PERF_ID) return;
            const newName = document.getElementById('edit-name').value;
            const bio = document.getElementById('edit-bio').value;
            const ig = document.getElementById('edit-ig').value;
            const tiktok = document.getElementById('edit-tiktok').value;
            const yt = document.getElementById('edit-yt').value;

            if(!newName) return alert("Nama Panggung tidak boleh kosong!");

            try {
                await updateDoc(doc(db, "performers", PERF_ID), {
                    name: newName, bio, link_ig: ig, link_tiktok: tiktok, link_yt: yt
                });
                document.querySelector('.perf-info h1').innerText = newName;
                alert("Profil Berhasil Diupdate!");
            } catch (e) {
                alert("Gagal menyimpan: " + e.message);
            }
        }

        window.triggerUpload = function() { document.getElementById('file-input').click(); }
        window.previewImage = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    if(confirm("Simpan foto profil baru?")) {
                        await updateDoc(doc(db, "performers", PERF_ID), { img: e.target.result });
                        document.getElementById('header-profile-img').src = e.target.result;
                        alert("Foto tersimpan!");
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // PDF GENERATOR
        window.generatePDF = async function(type, action) {
            const name = document.querySelector('.perf-info h1').innerText;
            const doc = new jsPDF({ orientation: "landscape", unit: "px", format: [800, 600] });
            let templateURL = type === 'sertifikat' ? "https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/cert_template_dummy.jpg" : "https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/mou_template_dummy.jpg";
            let fileName = type === 'sertifikat' ? "Sertifikat_SMIPRO.pdf" : "MOU_Kontrak.pdf";

            try {
                document.body.style.cursor = 'wait';
                const imgData = await getBase64ImageFromURL(templateURL);
                doc.addImage(imgData, 'JPEG', 0, 0, 800, 600);
                doc.setFontSize(40); doc.setTextColor(0, 0, 0); doc.setFont("helvetica", "bold");
                doc.text(name, 400, 300, { align: "center" });
                doc.setFontSize(15);
                doc.text("Probolinggo, " + new Date().toLocaleDateString('id-ID'), 400, 450, { align: "center" });

                if (action === 'download') { doc.save(fileName); } 
                else { 
                    const pdfBlob = doc.output('bloburl');
                    document.getElementById('pdf-frame').src = pdfBlob;
                    document.getElementById('pdf-preview-modal').style.display = 'flex';
                }
            } catch (e) { console.error(e); alert("Gagal proses PDF"); } 
            finally { document.body.style.cursor = 'default'; }
        }

        function getBase64ImageFromURL(url) {
            return new Promise((resolve, reject) => {
                var img = new Image();
                img.setAttribute("crossOrigin", "anonymous");
                img.onload = () => {
                    var canvas = document.createElement("canvas");
                    canvas.width = img.width; canvas.height = img.height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/jpeg"));
                };
                img.onerror = error => reject(error);
                img.src = url;
            });
        }

        // PLAYER & UI UTILS
        window.playMedia = function(type, url) {
            const modal = document.getElementById('modal-player');
            const content = document.getElementById('player-content');
            modal.style.display = 'flex';
            if(type === 'video') content.innerHTML = `<iframe width="100%" height="450" src="${url}?autoplay=1" frameborder="0" allowfullscreen></iframe>`;
            else content.innerHTML = `<div style="background:#222; padding:30px;"><audio controls autoplay src="${url}" style="width:100%"></audio></div>`;
        }
        window.closePlayer = function() { document.getElementById('modal-player').style.display = 'none'; document.getElementById('player-content').innerHTML = ''; }
        window.closePdfPreview = function() { document.getElementById('pdf-preview-modal').style.display = 'none'; document.getElementById('pdf-frame').src = ''; }
        
        window.openAddModal = function() { document.getElementById('modal-add-gallery').style.display = 'flex'; }
        
        window.switchTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).style.display = 'block';
            if(event) event.currentTarget.classList.add('active');
        }
        window.openModalDoc = function(t) { document.getElementById('doc-title').innerText=t; document.getElementById('modal-doc').style.display='flex'; }
        window.downloadFile = function(f) { alert("Download: "+f); }
        window.prosesLogout = function() { if(confirm("Logout?")) { localStorage.clear(); window.location.href='index.html'; } }
        window.backToAdminDashboard = function() { if(confirm("Kembali ke Admin?")) { localStorage.setItem('userRole','admin'); localStorage.setItem('userName','Super Admin'); localStorage.setItem('userLink','admin-dashboard.html'); window.location.href='admin-dashboard.html'; } }
    </script>
</body>
</html>
