<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMIPRO - Home</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- NAVBAR -->
    <nav class="top-nav">
        <a href="index.html" class="logo-container">
            <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/Logo_Stretart.png" alt="Logo" class="logo-img" style="height: 50px;">
            <span class="logo-text">SMIPRO</span>
        </a>
        <div class="menu" style="display:flex; align-items:center;">
             <a href="about.html" style="color:#E50914; text-decoration:none; margin-right:15px; font-size:1.2rem;" title="Tentang SMIPRO">
                <i class="fa-solid fa-circle-info"></i>
            </a>
            <!-- WADAH TOMBOL LOGIN/USER (ID PENTING) -->
            <div id="nav-btn-area">
                <a href="login.html" class="btn-mitra">
                    <i class="fa-solid fa-user-gear"></i> Mitra (Login/Daftar)
                </a>
            </div>
        </div>
    </nav>

    <!-- HEADER + NARASI -->
    <header class="hero">
        <div class="hero-content">
            <span class="brand-badge">LIVE 2025</span>
            <h1 style="margin:10px 0;">SMIPRO</h1>
            <div class="prolog-box">
                "Memodernisasi sektor seni pertunjukan "jalanan" adalah upaya perbaikan tatakelola zona legal ekonomi kreatif untuk sebuah misi pertumbuhan ekonomi inklusif dan berkelanjutan"
            </div>
        </div>
    </header>

    <div class="container">

        <!-- === JADWAL UTAMA === -->
        <div id="home-schedule-container">
            <div class="main-schedule-card">
                <div class="msc-info" style="text-align:center;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Memuat Jadwal...
                </div>
            </div>
        </div>

        <!-- === RADIO CARD === -->
        <div id="home-radio-container">
            <div class="main-schedule-card cyan-theme">
                <div class="msc-info" style="text-align:center;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Memuat Radio...
                </div>
            </div>
        </div>

        <!-- === JADWAL TOUR (CAFE LIVE) === -->
        <div id="home-tour-container">
            <div class="main-schedule-card">
                <div class="msc-info" style="text-align:center;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Memuat Jadwal Tour...
                </div>
            </div>
        </div>
                 
        <!-- 1. LIST ANGKRINGAN -->
        <div class="section-title"><i class="fa-solid fa-map-location-dot"></i> 5 Angkringan Live</div>
        <div id="venue-list-container">
            <p style="text-align:center; color:#888; padding:20px;">
                <i class="fa-solid fa-spinner fa-spin"></i> Memuat Lokasi...
            </p>
        </div>

       <!-- 2. TOP 5 PERFORMER -->
        <div class="section-title"><i class="fa-solid fa-guitar"></i> Top 5 Performers (Profil)</div>
        <div class="performer-wrap" id="top-performer-container">
            <p style="text-align:center; width:100%; color:#888;">Memuat Artis...</p>
        </div>

        <!-- 3. BENGKEL PERFORM -->
        <div class="training-banner" onclick="location.href='training.html'">
            <div>
                <h3 style="margin:0;">Bengkel Perform SMIPRO</h3>
                <small style="color:#ccc;">Klik untuk melihat Tim Pelatih</small>
            </div>
            <i class="fa-solid fa-graduation-cap" style="font-size:2rem; color:var(--accent);"></i>
        </div>
                
        <!-- 4. PODCAST HIGHLIGHT -->
        <div class="section-title" style="margin-top: 50px;">
            <div class="podcast-card" onclick="location.href='podcast.html'">
                <div style="position:relative;">
                    <img src="https://images.unsplash.com/photo-1559523161-0fc0d8b38a7a?q=80&w=400" class="podcast-thumb">
                    <i class="fa-solid fa-circle-play play-btn-center"></i>
                </div>
                <div class="podcast-info">
                    <h4>Eps 2: Kisah Sukses Warung Bu Sri</h4>
                    <span><i class="fa-regular fa-clock"></i> 30 Menit â€¢ Host: Yuni</span>
                </div>
            </div>
        </div>

        <!-- 5. DUKUNG KAMI (REVISI) -->
        <div class="support-section">
            <h3 style="margin:0; color:white;">Dukung SMIPRO.Street.Art</h3>
            <p style="font-size:0.9rem; color:#888;">Follow akun resmi kami untuk update terbaru.</p>
            
            <div class="social-icons">
                <!-- 1. YOUTUBE (Link Aktif) -->
                <a href="https://www.youtube.com/@SmiproStreetart" target="_blank" style="color:red;" title="YouTube SMIPRO">
                    <i class="fa-brands fa-youtube"></i>
                </a>

                <!-- 2. TIKTOK (Ganti tanda # dengan link nanti) -->
                <a href="#" target="_blank" style="color:#00f2ea;" title="TikTok">
                    <i class="fa-brands fa-tiktok"></i>
                </a>

                <!-- 3. INSTAGRAM (Ganti tanda # dengan link nanti) -->
                <a href="#" target="_blank" style="color:#C13584;" title="Instagram">
                    <i class="fa-brands fa-instagram"></i>
                </a>

                <!-- 4. FACEBOOK (Ganti tanda # dengan link nanti) -->
                <a href="#" target="_blank" style="color:#1877F2;" title="Facebook">
                    <i class="fa-brands fa-facebook-f"></i>
                </a>
            </div>
            
            <!-- Tombol Donasi sudah dihapus -->
        </div>

        <!-- 6. BERITA -->
        <div class="section-title"><i class="fa-regular fa-newspaper"></i> Berita Terbaru</div>
        <div id="home-news-container">
            <div class="news-card"><div>Memuat Berita...</div></div>
        </div>

        <br><br>
        <center><small style="color:#444;">&copy; 2025 Yayasan Sekolah Konang Indonesia</small></center>
    </div>

    <!-- SCRIPT TUNGGAL (GABUNGAN LOGIC & DATA) -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { 
    collection, getDocs, query, orderBy, limit, addDoc, updateDoc, doc, onSnapshot, where 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // 1. CEK STATUS LOGIN (INIT PERTAMA KALI)
        // ==========================================
        function checkAuthStatus() {
            const isLoggedIn = localStorage.getItem('userLoggedIn');
            const userName = localStorage.getItem('userName');
            const userRole = localStorage.getItem('userRole'); 
            
            // Logika Fallback Link Dashboard
            let userLink = localStorage.getItem('userLink');
            if (!userLink || userLink === 'null') {
                if (userRole === 'mitra') userLink = 'mitra-dashboard.html';
                else if (userRole === 'performer') userLink = 'performer-dashboard.html';
                else if (userRole === 'mentor') userLink = 'mentor-dashboard.html';
                else if (userRole === 'admin') userLink = 'admin-dashboard.html';
                else userLink = '#';
            }

            const navArea = document.getElementById('nav-btn-area');
            if (navArea) {
                if (isLoggedIn === 'true') {
                    // TENTUKAN IKON & WARNA
                    let icon = 'fa-user'; 
                    let color = '#E50914'; 
                    
                    if (userRole === 'mitra') icon = 'fa-store';
                    if (userRole === 'performer') icon = 'fa-guitar';
                    if (userRole === 'mentor') icon = 'fa-graduation-cap';
                    
                    if (userRole === 'admin') {
                        icon = 'fa-user-shield';
                        color = '#ff0000'; 
                    }

                    // TAMPILKAN NAMA USER (KLIK MASUK DASHBOARD)
                    navArea.innerHTML = `
                        <a href="${userLink}" style="text-decoration:none; display:flex; align-items:center; gap:8px; color:${color}; font-weight:800; font-size:1rem;">
                            <i class="fa-solid ${icon}"></i> ${userName}
                        </a>
                    `;
                } else {
                    // BELUM LOGIN
                    navArea.innerHTML = `
                        <a href="login.html" class="btn-mitra">
                            <i class="fa-solid fa-user-gear"></i> Mitra (Login/Daftar)
                        </a>
                    `;
                }
            }
        }

        // ==========================================
        // 2. FUNGSI LOAD DATA
        // ==========================================
        
        // JADWAL
        async function loadMainSchedule() {
            const container = document.getElementById('home-schedule-container');
            const q = query(collection(db, "events"), orderBy("date", "asc")); 
            const querySnapshot = await getDocs(q);

            let foundMain = false;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.type === 'main' && !foundMain) { 
                    foundMain = true;
                    let artistNames = data.performers ? data.performers.map(p => p.name).join(", ") : "Artis Pilihan";
                    const dateParts = data.displayDate.split(' '); 
                    const hari = dateParts[0].replace(',','').toUpperCase();
                    const tgl = dateParts[1];
                    const blnThn = dateParts[2].substr(0,3).toUpperCase() + " " + dateParts[3];

                    container.innerHTML = `
                    <div class="main-schedule-card" onclick="location.href='schedule.html'">
                        <div class="msc-date">
                            <span style="font-size:0.8rem; letter-spacing:2px;">${hari}</span>
                            <span style="font-size:2.5rem; font-weight:800; line-height:1;">${tgl}</span>
                            <span style="font-size:0.9rem; font-weight:bold;">${blnThn}</span>
                        </div>
                        <div class="msc-info">
                            <div class="msc-badge">MINGGU INI</div>
                            <h3 style="margin:5px 0 5px 0; color:white;">Live Performance</h3>
                            <p style="color:#ccc; font-size:0.9rem; margin:0;">
                                <i class="fa-solid fa-microphone-lines" style="color:var(--primary);"></i> ${artistNames}
                            </p>
                            <small style="color:var(--accent); margin-top:5px; display:block;">
                                <i class="fa-solid fa-hand-pointer"></i> Klik untuk detail & jadwal bulan depan
                            </small>
                        </div>
                    </div>`;
                }
            });

            if(!foundMain) container.innerHTML = `<div class="main-schedule-card"><div class="msc-info">Belum ada jadwal minggu ini.</div></div>`;
        }

        // RADIO
        async function loadMainRadio() {
            const container = document.getElementById('home-radio-container');
            const q = query(collection(db, "broadcasts"), orderBy("order", "desc"));
            const querySnapshot = await getDocs(q);
            
            let dataToShow = null;
            querySnapshot.forEach(doc => {
                const d = doc.data();
                if(d.isLive) dataToShow = d; 
            });
            if(!dataToShow && !querySnapshot.empty) dataToShow = querySnapshot.docs[0].data();

            if(dataToShow) {
                const liveBadge = dataToShow.isLive ? 'border:1px solid #00d2ff; background:#00d2ff; color:black;' : 'border:1px solid #00d2ff; background:transparent; color:#00d2ff;';
                const liveText = dataToShow.isLive ? 'LIVE SEKARANG' : 'SEGERA TAYANG';
                
                container.innerHTML = `
                <div class="main-schedule-card cyan-theme" onclick="location.href='radio.html'">
                    <div class="msc-date cyan-bg">
                        <span style="font-size:0.8rem; letter-spacing:2px;">${dataToShow.sessionName || 'RADIO'}</span>
                        <span style="font-size:2.5rem; font-weight:800; line-height:1;">${dataToShow.time.split(':')[0]}</span>
                        <span style="font-size:0.9rem; font-weight:bold;">WIB</span>
                    </div>
                    <div class="msc-info">
                        <div class="msc-badge cyan-theme" style="${liveBadge}">${liveText}</div>
                        <h3 style="margin:5px 0 5px 0; color:white;">${dataToShow.title}</h3>
                        <p style="color:#ccc; font-size:0.9rem; margin:0;">
                            <i class="fa-brands fa-tiktok cyan-text"></i> Topik: "${dataToShow.topic}"
                        </p>
                        <small style="color:#888; margin-top:5px; display:block;">
                            <i class="fa-solid fa-paper-plane cyan-text"></i> Klik untuk Titip Salam & Request Lagu
                        </small>
                    </div>
                </div>`;
            }
        }

        // JADWAL TOUR (CAFE)
        async function loadTourSchedule() {
            const container = document.getElementById('home-tour-container');
            // Ambil event dengan tipe 'tour', urutkan tanggal, ambil 1 saja
            const q = query(collection(db, "events"), where("type", "==", "tour"), orderBy("date", "asc"), limit(1));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // Jika tidak ada jadwal tour, container kita kosongkan atau sembunyikan
                container.innerHTML = ''; 
                return;
            }

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                // Pecah format tanggal (Contoh: "SABTU, 12 JAN")
                const dateParts = data.displayDate.split(' '); 
                const hari = dateParts[0].replace(',','').toUpperCase();
                const tgl = dateParts[1];

                // Render Kartu (Tema Oranye #ff9800)
                container.innerHTML = `
                <div class="main-schedule-card" onclick="location.href='cafe-live.html?loc=${encodeURIComponent(data.location)}'" style="cursor:pointer; border-left: 1px solid #ff9800;">
                    <div class="msc-date" style="background:#ff9800; color:black;">
                        <span style="font-size:0.8rem; letter-spacing:2px;">${hari}</span>
                        <span style="font-size:2.5rem; font-weight:800; line-height:1;">${tgl}</span>
                    </div>
                    <div class="msc-info">
                        <div class="msc-badge" style="background:#ff9800; color:black; border:none;">ON TOUR</div>
                        <h3 style="margin:5px 0 5px 0; color:white;">${data.location}</h3>
                        <p style="color:#ccc; font-size:0.9rem; margin:0;">
                            <i class="fa-solid fa-music" style="color:#ff9800;"></i> ${data.performers ? data.performers[0].name : 'Special Guest'}
                        </p>
                        <small style="color:#888; margin-top:5px; display:block;">
                            <i class="fa-solid fa-arrow-right"></i> Klik untuk Request & Sawer
                        </small>
                    </div>
                </div>`;
            });
        }

        // VENUES (DENGAN PERBAIKAN ADMIN AKSES)
        async function loadVenues() {
            const container = document.getElementById('venue-list-container');
            const userRole = localStorage.getItem('userRole');
            
            // Cek apakah Admin
            const isAdmin = userRole === 'admin';

            const q = query(collection(db, "venues"), orderBy("order", "asc"));
            
            onSnapshot(q, (snapshot) => {
                if(snapshot.empty) {
                    if(isAdmin) {
                        container.innerHTML = `
                        <div style="text-align:center; padding:20px; border:1px dashed red; border-radius:10px;">
                            <p style="color:red;">Data Lokasi Belum Ada!</p>
                            <button onclick="window.seedVenuesDirect()" style="background:red; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">GENERATE LOKASI</button>
                        </div>`;
                    } else {
                        container.innerHTML = `<p style="text-align:center;color:#666;">Lokasi belum tersedia.</p>`;
                    }
                    return;
                }

                container.innerHTML = '';
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const isOpen = data.status === 'open';
                    const badgeClass = isOpen ? 'active' : 'soon';
                    const badgeText = isOpen ? 'BUKA' : 'TUTUP';
                    
                    // --- PERBAIKAN DI SINI ---
                    // 1. Tentukan Aksi Klik Kartu
                    // Admin SELALU bisa masuk (walau tutup). User biasa hanya bisa masuk jika BUKA.
                    let cardAction = "";
                    if (isAdmin) {
                        cardAction = `location.href='venue-stadion.html'`; 
                    } else {
                        cardAction = isOpen ? `location.href='venue-stadion.html'` : `alert('Maaf, lokasi ini sedang tutup/belum beroperasi.')`;
                    }

                    // 2. Tombol Saklar Admin (PENTING: Tambah event.stopPropagation)
                    let adminSwitchHTML = "";
                    if (isAdmin) {
                        const toggleColor = isOpen ? '#00ff00' : '#333';
                        const toggleIcon = isOpen ? 'fa-toggle-on' : 'fa-toggle-off';
                        
                        // Perhatikan: onclick="event.stopPropagation(); window.toggleVenueStatus..."
                        // Ini mencegah agar saat klik saklar, tidak ikut masuk ke halaman venue.
                        adminSwitchHTML = `
                        <div style="margin-left:10px; text-align:center; z-index:100; cursor:pointer;" 
                             onclick="event.stopPropagation(); window.toggleVenueStatus('${docSnap.id}', '${data.status}')">
                            <i class="fa-solid ${toggleIcon}" style="color:${toggleColor}; font-size:2rem; transition:0.3s;"></i>
                            <div style="font-size:0.6rem; color:#888;">ADMIN</div>
                        </div>`;
                    }

                    container.innerHTML += `
                    <div class="venue-card ${isOpen ? '' : 'disabled'}" onclick="${cardAction}" style="display:flex; align-items:center; cursor:pointer;">
                        <div class="icon-box"><i class="fa-solid ${data.icon}"></i></div>
                        <div style="flex:1;">
                            <h3 style="margin:0;">${data.name} <span class="badge ${badgeClass}">${badgeText}</span></h3>
                            <small style="color:#888;">${data.desc}</small>
                        </div>
                        ${adminSwitchHTML}
                    </div>`;
                });
            });
        }

        // TOP PERFORMERS
        async function loadTopPerformers() {
            const container = document.getElementById('top-performer-container');
            const q = query(collection(db, "performers"), orderBy("rating", "desc"), limit(5));
            const querySnapshot = await getDocs(q);

            if(querySnapshot.empty) {
                container.innerHTML = '<p style="text-align:center; width:100%; color:#666;">Belum ada performer.</p>';
                return;
            }

            container.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const defaultImg = "https://via.placeholder.com/150";
                container.innerHTML += `
                <div class="artist-card" onclick="location.href='profile.html?id=${doc.id}'">
                    <img src="${data.img || defaultImg}" class="artist-img">
                    <div>${data.name}</div>
                </div>`;
            });
        }

        // BERITA
        async function loadNews() {
            const container = document.getElementById('home-news-container');
            const q = query(collection(db, "news"), orderBy("date", "desc"), limit(1));
            const querySnapshot = await getDocs(q);

            if(querySnapshot.empty) {
                container.innerHTML = '<div class="news-card"><div>Belum ada berita.</div></div>';
                return;
            }
            container.innerHTML = '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                let clickAction = data.type === 'external' ? `window.open('${data.url}', '_blank')` : `location.href='news-read.html?id=${doc.id}'`;
                container.innerHTML += `
                <div class="news-card" onclick="${clickAction}" style="cursor:pointer;">
                    <img src="${data.thumb}" class="news-thumb">
                    <div>
                        <span style="color:var(--primary); font-size:0.7rem; font-weight:bold;">${data.tag}</span>
                        <h4 style="margin:5px 0;">${data.title}</h4>
                        <p style="margin:0; font-size:0.7rem; color:#888;">${data.date}</p>
                    </div>
                </div>`;
            });
        }

        // ==========================================
        // 3. FUNGSI GLOBAL (ADMIN ONLY)
        // ==========================================
        window.toggleVenueStatus = async function(id, currentStatus) {
            event.stopPropagation(); 
            const newStatus = currentStatus === 'open' ? 'closed' : 'open';
            if(confirm(`Ubah status menjadi ${newStatus.toUpperCase()}?`)) {
                await updateDoc(doc(db, "venues", id), { status: newStatus });
            }
        }

        window.seedVenuesDirect = async function() {
            const venuesData = [
                { name: "Stadion Bayuangga Zone", status: "open", icon: "fa-door-open", order: 1, desc: "Pusat Kuliner & Seni Utama" },
                { name: "Angkringan TWSL", status: "closed", icon: "fa-tree", order: 2, desc: "Taman Wisata Studi Lingkungan" },
                { name: "Angkringan Siaman", status: "closed", icon: "fa-mug-hot", order: 3, desc: "Suasana Klasik Kota" },
                { name: "Angkringan A. Yani", status: "closed", icon: "fa-road", order: 4, desc: "Pinggir Jalan Protokol" },
                { name: "Angkringan GOR Mastrip", status: "closed", icon: "fa-volleyball", order: 5, desc: "Area Olahraga & Santai" }
            ];
            if(confirm("Generate data lokasi sekarang?")) {
                for (const v of venuesData) { await addDoc(collection(db, "venues"), v); }
                alert("Selesai! Lokasi akan muncul otomatis.");
            }
        }

        // ==========================================
        // 4. EKSEKUSI
        // ==========================================
        checkAuthStatus(); // Cek Login Dulu
        loadMainSchedule();
        loadTourSchedule();
        loadMainRadio();
        loadVenues();
        loadTopPerformers();
        loadNews();

    </script>
</body>
</html>
