<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMIPRO - Home</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- NAVBAR -->
    <nav class="top-nav">
        <a href="index.html" class="logo-container">
            <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/Logo_Stretart.png" alt="Logo" class="logo-img" style="height: 50px;">
            <span class="logo-text">SMIPRO</span>
        </a>
        <div class="menu" style="display:flex; align-items:center;">
             <a href="about.html" style="color:#E50914; text-decoration:none; margin-right:15px; font-size:1.2rem;" title="Tentang SMIPRO">
                <i class="fa-solid fa-circle-info"></i>
            </a>
            <div id="nav-btn-area">
                <a href="login.html" class="btn-mitra">
                    <i class="fa-solid fa-user-gear"></i> Mitra (Login/Daftar)
                </a>
            </div>
        </div>
    </nav>

    <!-- HEADER + NARASI -->
    <header class="hero">
        <div class="hero-content">
            <span class="brand-badge">LIVE 2025</span>
            <h1 style="margin:10px 0;">SMIPRO</h1>
            <div class="prolog-box">
                "Memodernisasi sektor seni pertunjukan "jalanan" adalah upaya perbaikan tatakelola zona legal ekonomi kreatif untuk sebuah misi pertumbuhan ekonomi inklusif dan berkelanjutan"
            </div>
        </div>
    </header>

    <div class="container">

        <!-- === JADWAL UTAMA (DINAMIS DARI FIREBASE) === -->
        <div id="home-schedule-container">
            <!-- Loading State -->
            <div class="main-schedule-card">
                <div class="msc-info" style="text-align:center;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Memuat Jadwal...
                </div>
            </div>
        </div>

        <!-- === RADIO CARD (DINAMIS DARI FIREBASE) === -->
        <div id="home-radio-container">
            <!-- Loading State -->
            <div class="main-schedule-card cyan-theme">
                <div class="msc-info" style="text-align:center;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Memuat Radio...
                </div>
            </div>
        </div>
                 
      <!-- 1. LIST ANGKRINGAN (DINAMIS) -->
        <div class="section-title"><i class="fa-solid fa-map-location-dot"></i> 5 Angkringan Live</div>
        
        <!-- WADAH YANG AKAN DIISI JAVASCRIPT -->
        <div id="venue-list-container">
            <p style="text-align:center; color:#888;"><i class="fa-solid fa-spinner fa-spin"></i> Memuat Lokasi...</p>
        </div>
            <i class="fa-solid fa-chevron-right"></i>
        </a>

        <!-- Lainnya (Non-Aktif) -->
        <div class="venue-card disabled" onclick="alert('Lokasi ini Segera Hadir!')">
            <div class="icon-box"><i class="fa-solid fa-lock"></i></div>
            <div><h3 style="margin:0;">Alun-Alun Kota <span class="badge soon">SOON</span></h3></div>
        </div>
        <div class="venue-card disabled" onclick="alert('Lokasi ini Segera Hadir!')">
            <div class="icon-box"><i class="fa-solid fa-lock"></i></div>
            <div><h3 style="margin:0;">Benteng Mayangan <span class="badge soon">SOON</span></h3></div>
        </div>
        <div class="venue-card disabled" onclick="alert('Lokasi ini Segera Hadir!')">
            <div class="icon-box"><i class="fa-solid fa-lock"></i></div>
            <div><h3 style="margin:0;">Museum Probolinggo <span class="badge soon">SOON</span></h3></div>
        </div>
        <div class="venue-card disabled" onclick="alert('Lokasi ini Segera Hadir!')">
            <div class="icon-box"><i class="fa-solid fa-lock"></i></div>
            <div><h3 style="margin:0;">BJBR Mangrove <span class="badge soon">SOON</span></h3></div>
        </div>

        <!-- 2. TOP 5 PERFORMER -->
        <div class="section-title"><i class="fa-solid fa-guitar"></i> Top 5 Performers (Profil)</div>
        
        <div class="performer-wrap">
            <div class="artist-card" onclick="location.href='profile.html?id=1'">
                <img src="https://images.unsplash.com/photo-1516280440614-6697288d5d38?q=80&w=150" class="artist-img">
                <div>Rina Violin</div>
            </div>
            <div class="artist-card" onclick="location.href='profile.html?id=2'">
                <img src="https://images.unsplash.com/photo-1570295999919-56ceb5ecca61?q=80&w=150" class="artist-img">
                <div>Acoustic Boys</div>
            </div>
            <div class="artist-card" onclick="location.href='profile.html?id=3'">
                <img src="https://images.unsplash.com/photo-1526218626217-dc65b9d6e630?q=80&w=150" class="artist-img">
                <div>Rock Ballad</div>
            </div>
            <div class="artist-card" onclick="location.href='profile.html?id=4'">
                <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?q=80&w=150" class="artist-img">
                <div>Siti Keroncong</div>
            </div>
            <div class="artist-card" onclick="location.href='profile.html?id=5'">
                <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=150" class="artist-img">
                <div>Solo Hudi</div>
            </div>
        </div>

        <!-- 3. PELATIHAN -->
        <div class="training-banner" onclick="location.href='training.html'">
            <div>
                <h3 style="margin:0;">Pelatihan Attitude</h3>
                <small style="color:#ccc;">Klik untuk melihat Tim Pelatih</small>
            </div>
            <i class="fa-solid fa-graduation-cap" style="font-size:2rem; color:var(--accent);"></i>
        </div>
                
        <!-- 4. PODCAST HIGHLIGHT -->
        <div class="section-title" style="margin-top: 50px;">
        <div class="podcast-card" onclick="location.href='podcast.html'">
                <div style="position:relative;">
                    <img src="https://images.unsplash.com/photo-1559523161-0fc0d8b38a7a?q=80&w=400" class="podcast-thumb">
                    <i class="fa-solid fa-circle-play play-btn-center"></i>
                </div>
                <div class="podcast-info">
                    <h4>Eps 2: Kisah Sukses Warung Bu Sri</h4>
                    <span><i class="fa-regular fa-clock"></i> 30 Menit â€¢ Host: Yuni</span>
                </div>
            </div>
        </div>

        <!-- 5. DUKUNG KAMI -->
        <div class="support-section">
            <h3 style="margin:0; color:white;">Dukung Gerakan SMIPRO!</h3>
            <p style="font-size:0.9rem; color:#888;">Follow akun resmi kami untuk update terbaru.</p>
            
            <div class="social-icons">
                <a href="#" style="color:red;"><i class="fa-brands fa-youtube"></i></a>
                <a href="#" style="color:#00f2ea;"><i class="fa-brands fa-tiktok"></i></a>
                <a href="#" style="color:#C13584;"><i class="fa-brands fa-instagram"></i></a>
                <a href="#" style="color:#1877F2;"><i class="fa-brands fa-facebook-f"></i></a>
            </div>
            
            <button class="btn-dukung" onclick="alert('Terima kasih!')">Donasi Pengembangan</button>
        </div>

        <!-- 6. BERITA (DINAMIS) -->
        <div class="section-title"><i class="fa-regular fa-newspaper"></i> Berita Terbaru</div>
        <div id="home-news-container">
            <!-- Loading -->
            <div class="news-card">
                <div>Memuat Berita...</div>
            </div>
        </div>

        <br><br>
        <center><small style="color:#444;">&copy; 2025 Yayasan Sekolah Konang Indonesia</small></center>
    </div>

    <!-- SCRIPT DATA DINAMIS -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs, query, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === 1. LOAD JADWAL UTAMA ===
        async function loadMainSchedule() {
            const container = document.getElementById('home-schedule-container');
            // Ambil 1 event 'main' terbaru (berdasarkan tanggal)
            const q = query(collection(db, "events"), orderBy("date", "asc")); 
            const querySnapshot = await getDocs(q);

            let foundMain = false;

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.type === 'main' && !foundMain) { // Ambil yang pertama ketemu
                    foundMain = true;
                    
                    // Ambil nama performer dari Array
                    let artistNames = "Berbagai Artis Pilihan";
                    if(data.performers && data.performers.length > 0) {
                        artistNames = data.performers.map(p => p.name).join(", ");
                    }

                    // TANGGAL SPLIT (Sabtu 03 Jan)
                    // Kita asumsikan format displayDate admin adalah: "Hari, Tanggal Bulan Tahun"
                    // Untuk Index, kita parsing manual atau tampilkan apa adanya. 
                    // Agar rapi, kita pakai data mentah displayDate saja.
                    
                    const dateParts = data.displayDate.split(' '); // [Sabtu,, 03, Januari, 2026]
                    const hari = dateParts[0].replace(',','').toUpperCase();
                    const tgl = dateParts[1];
                    const blnThn = dateParts[2].substr(0,3).toUpperCase() + " " + dateParts[3];

                    container.innerHTML = `
                    <div class="main-schedule-card" onclick="location.href='schedule.html'">
                        <div class="msc-date">
                            <span style="font-size:0.8rem; letter-spacing:2px;">${hari}</span>
                            <span style="font-size:2.5rem; font-weight:800; line-height:1;">${tgl}</span>
                            <span style="font-size:0.9rem; font-weight:bold;">${blnThn}</span>
                        </div>
                        <div class="msc-info">
                            <div class="msc-badge">MINGGU INI</div>
                            <h3 style="margin:5px 0 5px 0; color:white;">Live Performance</h3>
                            <p style="color:#ccc; font-size:0.9rem; margin:0;">
                                <i class="fa-solid fa-microphone-lines" style="color:var(--primary);"></i> 
                                ${artistNames}
                            </p>
                            <small style="color:var(--accent); margin-top:5px; display:block;">
                                <i class="fa-solid fa-hand-pointer"></i> Klik untuk detail & jadwal bulan depan
                            </small>
                        </div>
                    </div>`;
                }
            });

            if(!foundMain) {
                container.innerHTML = `<div class="main-schedule-card"><div class="msc-info">Belum ada jadwal minggu ini.</div></div>`;
            }
        }

        // === 2. LOAD RADIO UTAMA ===
        async function loadMainRadio() {
            const container = document.getElementById('home-radio-container');
            // Ambil Radio sesi Malam (order 3) atau yang sedang LIVE
            const q = query(collection(db, "broadcasts"), orderBy("order", "desc")); // Biasanya malam ordernya tinggi
            const querySnapshot = await getDocs(q);
            
            let dataToShow = null;
            querySnapshot.forEach(doc => {
                const d = doc.data();
                if(d.isLive) dataToShow = d; // Prioritas yang Live
            });
            // Kalau gak ada yang live, ambil yang terakhir (Malam)
            if(!dataToShow && !querySnapshot.empty) {
                dataToShow = querySnapshot.docs[0].data();
            }

            if(dataToShow) {
                const liveBadge = dataToShow.isLive ? 'border:1px solid #00d2ff; background:#00d2ff; color:black;' : 'border:1px solid #00d2ff; background:transparent; color:#00d2ff;';
                const liveText = dataToShow.isLive ? 'LIVE SEKARANG' : 'SEGERA TAYANG';
                
                container.innerHTML = `
                <div class="main-schedule-card cyan-theme" onclick="location.href='radio.html'">
                    <div class="msc-date cyan-bg">
                        <span style="font-size:0.8rem; letter-spacing:2px;">${dataToShow.sessionName || 'RADIO'}</span>
                        <span style="font-size:2.5rem; font-weight:800; line-height:1;">${dataToShow.time.split(':')[0]}</span>
                        <span style="font-size:0.9rem; font-weight:bold;">WIB</span>
                    </div>
                    <div class="msc-info">
                        <div class="msc-badge cyan-theme" style="${liveBadge}">${liveText}</div>
                        <h3 style="margin:5px 0 5px 0; color:white;">${dataToShow.title}</h3>
                        <p style="color:#ccc; font-size:0.9rem; margin:0;">
                            <i class="fa-brands fa-tiktok cyan-text"></i> 
                            Topik: "${dataToShow.topic}"
                        </p>
                        <small style="color:#888; margin-top:5px; display:block;">
                            <i class="fa-solid fa-paper-plane cyan-text"></i> Klik untuk Titip Salam & Request Lagu
                        </small>
                    </div>
                </div>`;
            }
        }

        // === 3. LOAD BERITA (SEEDING JIKA KOSONG) ===
        async function loadNews() {
            const container = document.getElementById('home-news-container');
            const q = query(collection(db, "news"), orderBy("date", "desc"), limit(1));
            const querySnapshot = await getDocs(q);

            if(querySnapshot.empty) {
                await seedNews(); // Isi data berita pertama kali
                return loadNews();
            }

            container.innerHTML = '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                container.innerHTML = `
                <div class="news-card">
                    <img src="${data.thumb}" class="news-thumb">
                    <div>
                        <span style="color:var(--primary); font-size:0.7rem; font-weight:bold;">${data.tag}</span>
                        <h4 style="margin:5px 0;">${data.title}</h4>
                        <p style="margin:0; font-size:0.7rem; color:#888;">${data.date}</p>
                    </div>
                </div>`;
            });
        }

        async function seedNews() {
            await addDoc(collection(db, "news"), {
                title: "Festival Musik 2025 Segera Hadir",
                date: "2 Jam yang lalu",
                tag: "EVENT",
                thumb: "https://images.unsplash.com/photo-1514525253440-b393452e3383?q=80&w=100"
            });
        }

        // START ALL
        loadMainSchedule();
        loadMainRadio();
        loadNews();

        // --- TAMBAHKAN IMPORT UPDATE DOC DI PALING ATAS SCRIPT ---
        import { updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === 4. LOAD VENUE (SUPER ADMIN MODE) ===
        async function loadVenues() {
            const container = document.getElementById('venue-list-container');
            
            // Cek apakah yang login adalah Admin?
            const isAdmin = localStorage.getItem('userRole') === 'admin';

            const q = query(collection(db, "venues"), orderBy("order", "asc"));
            
            // Realtime Listener (Agar saat saklar digeser, HP lain langsung berubah)
            onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const isOpen = data.status === 'open';
                    
                    // Tentukan Warna & Teks Badge
                    const badgeClass = isOpen ? 'active' : 'soon';
                    const badgeText = isOpen ? 'BUKA' : 'SOON';
                    
                    // Tentukan Aksi Klik Kartu (User Biasa)
                    // Sementara semua diarahkan ke venue-stadion.html (Nanti bisa diubah per ID)
                    let cardAction = isOpen ? `location.href='venue-stadion.html'` : `alert('${data.name} Segera Hadir!')`;
                    
                    // Jika Admin, matikan klik kartu agar tidak pindah saat mau geser saklar
                    if(isAdmin) cardAction = ""; 

                    // --- FITUR ADMIN: TOMBOL SAKLAR (SWITCH) ---
                    let adminSwitchHTML = "";
                    if (isAdmin) {
                        // Tombol Toggle On/Off
                        const toggleColor = isOpen ? '#00ff00' : '#333';
                        const toggleIcon = isOpen ? 'fa-toggle-on' : 'fa-toggle-off';
                        
                        adminSwitchHTML = `
                        <div style="margin-left:10px; text-align:center; z-index:100;" onclick="toggleVenueStatus('${docSnap.id}', '${data.status}')">
                            <i class="fa-solid ${toggleIcon}" style="color:${toggleColor}; font-size:2rem; cursor:pointer; transition:0.3s;"></i>
                            <div style="font-size:0.6rem; color:#888;">ADMIN</div>
                        </div>`;
                    }

                    // Render HTML
                    container.innerHTML += `
                    <div class="venue-card ${isOpen ? '' : 'disabled'}" onclick="${cardAction}" style="display:flex; align-items:center;">
                        <div class="icon-box"><i class="fa-solid ${data.icon}"></i></div>
                        <div style="flex:1;">
                            <h3 style="margin:0;">${data.name} <span class="badge ${badgeClass}">${badgeText}</span></h3>
                            <small style="color:#888;">${data.desc}</small>
                        </div>
                        ${adminSwitchHTML} <!-- Saklar Admin Muncul Disini -->
                        ${!isAdmin ? '<i class="fa-solid fa-chevron-right"></i>' : ''}
                    </div>`;
                });
            });
        }

        // FUNGSI GANTI STATUS (Admin Only)
        // Kita tempel ke window agar bisa dipanggil onclick
        window.toggleVenueStatus = async function(id, currentStatus) {
            // Cegah event bubbling (agar kartu tidak terklik)
            event.stopPropagation(); 
            
            const newStatus = currentStatus === 'open' ? 'closed' : 'open';
            if(confirm(`Ubah status menjadi ${newStatus.toUpperCase()}?`)) {
                await updateDoc(doc(db, "venues", id), {
                    status: newStatus
                });
            }
        }

        // Panggil fungsi
        loadVenues();
    </script>

  <!-- Script Cek Login (VERSI FIX ANTI-ERROR 404) -->
   <script>
        window.onload = function() {
            const isLoggedIn = localStorage.getItem('userLoggedIn');
            const userName = localStorage.getItem('userName');
            const userRole = localStorage.getItem('userRole'); 
            
            // --- BAGIAN PERBAIKAN (FALLBACK LINK) ---
            // Jika Link di memori kosong, kita paksa isi manual sesuai Role
            let userLink = localStorage.getItem('userLink');
            
            if (!userLink || userLink === 'null' || userLink === '') {
                if (userRole === 'mitra') userLink = 'mitra-dashboard.html';
                else if (userRole === 'performer') userLink = 'performer-dashboard.html';
                else if (userRole === 'mentor') userLink = 'mentor-dashboard.html';
                else if (userRole === 'admin') userLink = 'admin-dashboard.html';
                else userLink = '#'; // Safety net
            }
            // ----------------------------------------

            const navArea = document.getElementById('nav-btn-area');

            if (navArea) {
                if (isLoggedIn === 'true') {
                    // TENTUKAN IKON & WARNA BERDASARKAN ROLE
                    let icon = 'fa-user'; 
                    let color = '#E50914'; // Default Merah
                    
                    if (userRole === 'mitra') icon = 'fa-store';
                    if (userRole === 'performer') icon = 'fa-guitar';
                    if (userRole === 'mentor') icon = 'fa-graduation-cap';
                    
                    // KHUSUS ADMIN
                    if (userRole === 'admin') {
                        icon = 'fa-user-shield';
                        color = '#ff0000'; 
                    }

                    // TAMPILKAN DI NAVBAR
                    navArea.innerHTML = `
                        <a href="${userLink}" style="text-decoration:none; display:flex; align-items:center; gap:8px; color:${color}; font-weight:800; font-size:1rem;">
                            <i class="fa-solid ${icon}"></i> ${userName}
                        </a>
                    `;
                } else {
                    // JIKA BELUM LOGIN
                    navArea.innerHTML = `
                        <a href="login.html" class="btn-mitra">
                            <i class="fa-solid fa-user-gear"></i> Mitra (Login/Daftar)
                        </a>
                    `;
                }
            }
        };
    </script>
    

</body>
</html>
