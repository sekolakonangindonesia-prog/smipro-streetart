<!-- SCRIPT DATA DINAMIS (FULL GABUNGAN) -->
    <script type="module">
        // 1. IMPORT (Pastikan baris ini ada di paling atas)
        import { db } from './firebase-config.js';
        import { 
            collection, getDocs, query, orderBy, limit, addDoc, updateDoc, doc, onSnapshot 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === 1. LOAD JADWAL UTAMA ===
        async function loadMainSchedule() {
            const container = document.getElementById('home-schedule-container');
            const q = query(collection(db, "events"), orderBy("date", "asc")); 
            const querySnapshot = await getDocs(q);

            let foundMain = false;

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.type === 'main' && !foundMain) { 
                    foundMain = true;
                    
                    let artistNames = "Berbagai Artis Pilihan";
                    if(data.performers && data.performers.length > 0) {
                        artistNames = data.performers.map(p => p.name).join(", ");
                    }
                    
                    const dateParts = data.displayDate.split(' '); 
                    const hari = dateParts[0].replace(',','').toUpperCase();
                    const tgl = dateParts[1];
                    const blnThn = dateParts[2].substr(0,3).toUpperCase() + " " + dateParts[3];

                    container.innerHTML = `
                    <div class="main-schedule-card" onclick="location.href='schedule.html'">
                        <div class="msc-date">
                            <span style="font-size:0.8rem; letter-spacing:2px;">${hari}</span>
                            <span style="font-size:2.5rem; font-weight:800; line-height:1;">${tgl}</span>
                            <span style="font-size:0.9rem; font-weight:bold;">${blnThn}</span>
                        </div>
                        <div class="msc-info">
                            <div class="msc-badge">MINGGU INI</div>
                            <h3 style="margin:5px 0 5px 0; color:white;">Live Performance</h3>
                            <p style="color:#ccc; font-size:0.9rem; margin:0;">
                                <i class="fa-solid fa-microphone-lines" style="color:var(--primary);"></i> 
                                ${artistNames}
                            </p>
                            <small style="color:var(--accent); margin-top:5px; display:block;">
                                <i class="fa-solid fa-hand-pointer"></i> Klik untuk detail & jadwal bulan depan
                            </small>
                        </div>
                    </div>`;
                }
            });

            if(!foundMain) {
                container.innerHTML = `<div class="main-schedule-card"><div class="msc-info">Belum ada jadwal minggu ini.</div></div>`;
            }
        }

        // === 2. LOAD RADIO UTAMA ===
        async function loadMainRadio() {
            const container = document.getElementById('home-radio-container');
            const q = query(collection(db, "broadcasts"), orderBy("order", "desc"));
            const querySnapshot = await getDocs(q);
            
            let dataToShow = null;
            querySnapshot.forEach(doc => {
                const d = doc.data();
                if(d.isLive) dataToShow = d; 
            });
            if(!dataToShow && !querySnapshot.empty) {
                dataToShow = querySnapshot.docs[0].data();
            }

            if(dataToShow) {
                const liveBadge = dataToShow.isLive ? 'border:1px solid #00d2ff; background:#00d2ff; color:black;' : 'border:1px solid #00d2ff; background:transparent; color:#00d2ff;';
                const liveText = dataToShow.isLive ? 'LIVE SEKARANG' : 'SEGERA TAYANG';
                
                container.innerHTML = `
                <div class="main-schedule-card cyan-theme" onclick="location.href='radio.html'">
                    <div class="msc-date cyan-bg">
                        <span style="font-size:0.8rem; letter-spacing:2px;">${dataToShow.sessionName || 'RADIO'}</span>
                        <span style="font-size:2.5rem; font-weight:800; line-height:1;">${dataToShow.time.split(':')[0]}</span>
                        <span style="font-size:0.9rem; font-weight:bold;">WIB</span>
                    </div>
                    <div class="msc-info">
                        <div class="msc-badge cyan-theme" style="${liveBadge}">${liveText}</div>
                        <h3 style="margin:5px 0 5px 0; color:white;">${dataToShow.title}</h3>
                        <p style="color:#ccc; font-size:0.9rem; margin:0;">
                            <i class="fa-brands fa-tiktok cyan-text"></i> 
                            Topik: "${dataToShow.topic}"
                        </p>
                        <small style="color:#888; margin-top:5px; display:block;">
                            <i class="fa-solid fa-paper-plane cyan-text"></i> Klik untuk Titip Salam & Request Lagu
                        </small>
                    </div>
                </div>`;
            }
        }

        // === 3. LOAD BERITA ===
        async function loadNews() {
            const container = document.getElementById('home-news-container');
            const q = query(collection(db, "news"), orderBy("date", "desc"), limit(1));
            const querySnapshot = await getDocs(q);

            if(querySnapshot.empty) {
                container.innerHTML = '<div class="news-card"><div>Belum ada berita.</div></div>';
                return;
            }

            container.innerHTML = '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                
                let clickAction = "";
                if (data.type === 'external') {
                    clickAction = `window.open('${data.url}', '_blank')`;
                } else {
                    clickAction = `location.href='news-read.html?id=${doc.id}'`;
                }

                container.innerHTML = `
                <div class="news-card" onclick="${clickAction}" style="cursor:pointer;">
                    <img src="${data.thumb}" class="news-thumb">
                    <div>
                        <span style="color:var(--primary); font-size:0.7rem; font-weight:bold;">${data.tag}</span>
                        <h4 style="margin:5px 0;">${data.title}</h4>
                        <p style="margin:0; font-size:0.7rem; color:#888;">${data.date}</p>
                    </div>
                </div>`;
            });
        }

        // === 4. LOAD VENUE (AUTO-SEED FIX) ===
        async function loadVenues() {
            const container = document.getElementById('venue-list-container');
            const isAdmin = localStorage.getItem('userRole') === 'admin';

            const q = query(collection(db, "venues"), orderBy("order", "asc"));
            
            onSnapshot(q, (snapshot) => {
                if(snapshot.empty) {
                    if(isAdmin) {
                        container.innerHTML = `
                        <div style="text-align:center; padding:20px; border:1px dashed red; border-radius:10px;">
                            <p style="color:red;">Data Lokasi Belum Ada!</p>
                            <button onclick="window.seedVenuesDirect()" style="background:red; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
                                GENERATE 5 LOKASI AWAL
                            </button>
                        </div>`;
                    } else {
                        container.innerHTML = `<p style="text-align:center;color:#666;">Lokasi belum tersedia.</p>`;
                    }
                    return;
                }

                container.innerHTML = '';
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const isOpen = data.status === 'open';
                    const badgeClass = isOpen ? 'active' : 'soon';
                    const badgeText = isOpen ? 'BUKA' : 'SOON';
                    
                    let cardAction = isOpen ? `location.href='venue-stadion.html'` : `alert('${data.name} Segera Hadir!')`;
                    if(isAdmin) cardAction = ""; 

                    let adminSwitchHTML = "";
                    if (isAdmin) {
                        const toggleColor = isOpen ? '#00ff00' : '#333';
                        const toggleIcon = isOpen ? 'fa-toggle-on' : 'fa-toggle-off';
                        
                        adminSwitchHTML = `
                        <div style="margin-left:10px; text-align:center; z-index:100;" onclick="window.toggleVenueStatus('${docSnap.id}', '${data.status}')">
                            <i class="fa-solid ${toggleIcon}" style="color:${toggleColor}; font-size:2rem; cursor:pointer; transition:0.3s;"></i>
                            <div style="font-size:0.6rem; color:#888;">ADMIN</div>
                        </div>`;
                    }

                    container.innerHTML += `
                    <div class="venue-card ${isOpen ? '' : 'disabled'}" onclick="${cardAction}" style="display:flex; align-items:center;">
                        <div class="icon-box"><i class="fa-solid ${data.icon}"></i></div>
                        <div style="flex:1;">
                            <h3 style="margin:0;">${data.name} <span class="badge ${badgeClass}">${badgeText}</span></h3>
                            <small style="color:#888;">${data.desc}</small>
                        </div>
                        ${adminSwitchHTML}
                    </div>`;
                });
            });
        }

        // === 5. LOAD TOP 5 PERFORMER (INI YANG KEMARIN HILANG/SALAH TEMPAT) ===
        async function loadTopPerformers() {
            const container = document.getElementById('top-performer-container');
            
            // Ambil data performers, urutkan berdasarkan rating (descending), limit 5
            const q = query(collection(db, "performers"), orderBy("rating", "desc"), limit(5));
            const querySnapshot = await getDocs(q);

            if(querySnapshot.empty) {
                container.innerHTML = '<p style="text-align:center; width:100%; color:#666;">Belum ada performer terdaftar.</p>';
                return;
            }

            container.innerHTML = '';
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const defaultImg = "https://via.placeholder.com/150";
                
                // Link ke profil detail dengan ID Artis
                container.innerHTML += `
                <div class="artist-card" onclick="location.href='profile.html?id=${doc.id}'">
                    <img src="${data.img || defaultImg}" class="artist-img">
                    <div>${data.name}</div>
                </div>`;
            });
        }

        // === FUNGSI BANTUAN (GLOBAL WINDOW) ===
        window.toggleVenueStatus = async function(id, currentStatus) {
            event.stopPropagation(); 
            const newStatus = currentStatus === 'open' ? 'closed' : 'open';
            if(confirm(`Ubah status menjadi ${newStatus.toUpperCase()}?`)) {
                await updateDoc(doc(db, "venues", id), { status: newStatus });
            }
        }

        window.seedVenuesDirect = async function() {
            const venuesData = [
                { name: "Stadion Bayuangga Zone", status: "open", icon: "fa-door-open", order: 1, desc: "Pusat Kuliner & Seni Utama" },
                { name: "Angkringan TWSL", status: "closed", icon: "fa-tree", order: 2, desc: "Taman Wisata Studi Lingkungan" },
                { name: "Angkringan Siaman", status: "closed", icon: "fa-mug-hot", order: 3, desc: "Suasana Klasik Kota" },
                { name: "Angkringan A. Yani", status: "closed", icon: "fa-road", order: 4, desc: "Pinggir Jalan Protokol" },
                { name: "Angkringan GOR Mastrip", status: "closed", icon: "fa-volleyball", order: 5, desc: "Area Olahraga & Santai" }
            ];
            if(confirm("Generate data lokasi sekarang?")) {
                for (const v of venuesData) {
                    await addDoc(collection(db, "venues"), v);
                }
                alert("Selesai! Lokasi akan muncul otomatis.");
            }
        }

        // === JALANKAN SEMUA FUNGSI (START ALL) ===
        loadMainSchedule();
        loadMainRadio();
        loadNews();
        loadVenues();
        loadTopPerformers(); // << INI PENTING: DIPANGGIL DI SINI
    </script>
