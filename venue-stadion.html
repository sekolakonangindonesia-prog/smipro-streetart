<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stadion Bayuangga - SMIPRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
         /* CSS STANDARD */
        :root { --primary: #E50914; --accent: #FFD700; --bg: #121212; --card: #1E1E1E; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; padding-bottom: 50px; }
        
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #000; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 999; }
        .btn-back { background: none; border: none; color: white; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .split-view { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 768px) { .split-view { grid-template-columns: 1.5fr 1fr; } }

        .live-frame { position: relative; width: 100%; height: 350px; background: url('https://images.unsplash.com/photo-1501612780327-450456b106f8?q=80&w=600') center/cover; border-radius: 15px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; }
        .play-btn-big { font-size: 4rem; color: rgba(255,255,255,0.9); }

        .live-panel { background: #151515; border: 1px solid #333; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; height: 350px; }
        .perf-item { display: flex; gap: 10px; background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; align-items: center; justify-content: space-between; }
        
        .btn-req { width: 100%; background: #E50914; color: white; padding: 12px; border: none; border-radius: 5px; margin-top: auto; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* WARUNG GRID */
        .section-title { color: #FFD700; margin: 40px 0 15px; font-size: 1.2rem; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .warung-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .warung-card { background: #1a1a1a; border-radius: 10px; border: 1px solid #333; overflow: hidden; text-align: center; transition: 0.3s; }
        
        /* HOVER AGAR USER TAU BISA DIKLIK */
        .warung-img { width: 100%; height: 100px; object-fit: cover; background: #333; cursor: pointer; }
        .warung-name { font-size: 1rem; font-weight: 800; color: white; margin-bottom: 5px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; text-decoration: underline; text-decoration-color: transparent; transition: 0.3s; }
        .warung-name:hover { text-decoration-color: var(--primary); color: var(--primary); }
        
        .warung-body { padding: 12px; }
        .warung-stats { font-size: 0.8rem; margin-bottom: 10px; display: block; }
        
        .btn-book-ss3 { background: #E50914; color: white; border: none; padding: 8px 0; width: 100%; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-full-ss3 { background: #555; color: #aaa; border: none; padding: 8px 0; width: 100%; border-radius: 20px; font-weight: bold; cursor: not-allowed; }

        .review-box { background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-top: 40px; }
        .venue-photo-review { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; border: 2px solid #555; }
        
        /* MODAL POPUP */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #1e1e1e; width: 100%; max-width: 350px; padding: 25px; border-radius: 10px; border: 1px solid #444; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-logo { width: 80px; display: block; margin: 0 auto 15px auto; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
        
        .input-request { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-small { border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        .close-icon { position: absolute; top: 15px; right: 15px; color: #888; cursor: pointer; font-size: 1.2rem; }

        .stars-input i { color: #444; cursor: pointer; font-size: 1.5rem; transition: 0.2s; }
        .stars-input i.active { color: gold; }

        @media (max-width: 600px) {
            .review-top-area { flex-direction: column; align-items: center; text-align: center; }
            .venue-photo-review { width: 100%; height: 150px; margin-bottom: 15px; }
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="index.html" class="logo-container" style="display:flex; align-items:center; text-decoration:none; gap:10px;">
            <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/Logo_Stretart.png" style="width:35px; height:35px; border-radius:50%; border:2px solid #E50914;">
            <span style="font-weight:800; color:#E50914; font-size:1.1rem;">SMIPRO</span>
        </a>
        <button onclick="location.href='index.html'" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Dashboard</button>
    </nav>

    <div class="container">
        
        <!-- BAGIAN ATAS: LIVE & REQUEST -->
        <div class="split-view">
            <div class="live-frame"id="main-stage-container">                                
                <i class="fa-solid fa-spinner fa-spin fa-2x"></i><br>
                Memuat Siaran...
                <div style="position:absolute; bottom:15px; left:15px;">
                    <h3 style="margin:0; text-shadow:0 0 10px black;">Panggung Utama Live</h3>
                </div>
            </div>

            <div class="live-panel" style="min-height:350px; display:flex; flex-direction:column;">
                
                <!-- WADAH JADWAL DINAMIS (Akan diisi otomatis oleh JS) -->
                <div id="schedule-placeholder" style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                    <!-- Tampilan Default Jika Tidak Ada Jadwal -->
                    <div style="text-align:center;">
                        <i class="fa-solid fa-music" style="font-size:3rem; color:#333; margin-bottom:10px;"></i>
                        <h3 style="margin:0; color:#E50914;">Dukung Performer</h3>
                        <p style="color:#888; font-size:0.9rem;">Kirim salam & request lagu sekarang.</p>
                    </div>
                </div>

                <!-- TOMBOL REQUEST (Selalu Muncul di Bawah) -->
                <button class="btn-req" onclick="window.openRequestModal()" style="margin-top:auto;">
                    <i class="fa-solid fa-music"></i> Request Lagu & Sawer
                </button>
            </div>
                             
        <hr style="border:0; border-top:1px dashed #444; margin:30px 0;">

        <!-- DAFTAR WARUNG -->
        <div class="section-title">PILIH WARUNG & BOOKING MEJA</div>
        
        <!-- PENTING: ID ini digunakan untuk menampilkan list -->
        <div id="warung-grid-ss3" class="warung-grid">
            <p style="grid-column:1/-1; text-align:center; padding:20px; color:#888;">
                <i class="fa-solid fa-circle-notch fa-spin"></i> Menyiapkan Data Warung...
            </p>
        </div>
        
        <!-- REVIEW LOKASI -->
        <div class="review-box">
            <div class="review-top-area" style="display:flex; gap:20px;">
                <div style="text-align:center; min-width:120px;">
                    <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/Stadion%20Bayuangga.jpg" class="venue-photo-review">
                    <div>
                        <div style="color:gold; font-size:1.2rem;" id="avg-stars">★★★★★</div>
                        <span style="font-weight:bold; color:white;" id="avg-score">0.0 / 5.0</span>
                    </div>
                </div>
                <div style="flex:1;">
                    <h3 style="margin-top:0;">Ulasan Tempat</h3>
                    <input type="text" id="venue-reviewer-name" class="input-request" placeholder="Nama Anda (Wajib)">
                    <textarea id="venue-comment" class="input-request" style="height:60px;" placeholder="Bagaimana suasana di Stadion?"></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="stars-input" id="venue-stars">
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 1)"></i>
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 2)"></i>
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 3)"></i>
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 4)"></i>
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 5)"></i>
                        </div>
                        <button class="btn-book-ss3" style="width:100px;" onclick="submitVenueRating()">Kirim</button>
                    </div>
                </div>
            </div>
            <div style="border-top:1px dashed #444; margin-top:20px; padding-top:15px;">
                <h4 style="margin:0 0 10px 0; color:#888;">Apa Kata Mereka?</h4>
                <div id="venue-reviews-list" style="max-height:300px; overflow-y:auto;">
                    <p style="text-align:center; color:#555;">Belum ada ulasan.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL REQUEST -->
    <div id="request-modal" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-xmark close-icon" onclick="closeModal('request-modal')"></i>
            <h3 style="margin-top:0; color:#E50914;">Request Lagu & Sawer</h3>
            
            <label style="color:#aaa; font-size:0.8rem;">Judul Lagu</label>
            <input type="text" id="req-song" class="input-request">
            
            <label style="color:#aaa; font-size:0.8rem;">Pesan / Salam</label>
            <input type="text" id="req-msg" class="input-request">
            
            <label style="color:#aaa; font-size:0.8rem;">Target Performer</label>
            <select id="req-target" class="input-request">
                <option value="Rina Violin">Rina Violin</option>
                <option value="Acoustic Boys">Acoustic Boys</option>
                <option value="Band Lainnya">Band Lainnya</option>
            </select>

            <label style="color:#aaa; font-size:0.8rem;">Nominal Sawer (Rp)</label>
            <input type="number" id="req-amount" class="input-request" placeholder="Min. 10.000">

            <label style="color:#aaa; font-size:0.8rem;">Nama Pengirim (Validasi Admin)</label>
            <input type="text" id="req-sender" class="input-request" style="border:1px solid gold;">

            <!-- QRIS SECTION -->
            <div style="text-align:center; background:white; padding:10px; border-radius:10px; margin:10px 0;">
                <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/qris.png" style="width:150px;">
                <br>
                <a href="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/qris.png" download="QRIS_SMIPRO.png" class="btn-small" style="background:#333; color:white; display:inline-block; margin-top:5px; text-decoration:none;">
                    <i class="fa-solid fa-download"></i> Download QR
                </a>
            </div>

            <button class="btn-book-ss3" onclick="sendRequest()">SUDAH TRANSFER (KIRIM)</button>
        </div>
    </div>

    <!-- MODAL BOOKING (REVISI: TANPA JAM DATANG) -->
    <div id="booking-modal" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-xmark close-icon" onclick="closeModal('booking-modal')"></i>
            <h3 style="margin:0; text-align:center;">Form Booking</h3>
            <p id="modal-warung-name" style="text-align:center; color:#FFD700; margin-bottom:15px; font-weight:bold;">-</p>
            
            <label style="color:#aaa; font-size:0.8rem;">Nama Pemesan</label>
            <input type="text" id="book-name" class="input-request">
            
            <label style="color:#aaa; font-size:0.8rem;">WhatsApp</label>
            <input type="number" id="book-wa" class="input-request" placeholder="08xxxxxxxx">

            <label style="color:#aaa; font-size:0.8rem;">Tanggal Booking</label>
            <input type="date" id="book-date" class="input-request" style="color-scheme: dark;">  
            
            <!-- INPUT JAM DIHAPUS DARI SINI -->
            
            <label style="color:#aaa; font-size:0.8rem;">Jumlah Orang</label>
            <input type="number" id="book-pax" class="input-request" placeholder="Total Orang" oninput="hitungMeja()">
            
            <label style="color:#aaa; font-size:0.8rem;">Kebutuhan Meja (1 Meja = 4 Org)</label>
            <input type="text" id="book-qty" class="input-request" readonly style="color:#E50914; font-weight:bold; background:#333;" value="0 Meja">
            
            <div style="background:#332b00; padding:10px; border-radius:5px; margin-bottom:15px; font-size:0.8rem; color:#ffeb3b; border:1px dashed #ffeb3b;">
                <i class="fa-solid fa-clock"></i> <b>ATURAN WAKTU:</b><br>
                Batas Check-in (Hangus) pukul <b>17:30 WIB</b>.
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-small" style="background:#444; color:white; flex:1;" onclick="closeModal('booking-modal')">Batal</button>
                <button class="btn-small" style="background:var(--green); color:black; flex:1;" onclick="confirmBooking()">Booking</button>
            </div>
        </div>
    </div>

    <!-- MODAL RATING PERFORMER -->
    <div id="rate-perf-modal" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-xmark close-icon" onclick="closeModal('rate-perf-modal')"></i>
            <h3 style="margin:0; color:#E50914; text-align:center;">Nilai Penampilan</h3>
            <p id="rate-target-name" style="font-weight:bold; color:white; text-align:center; margin-bottom:15px;">-</p>
            <input type="text" id="perf-reviewer-name" class="input-request" placeholder="Nama Anda (Wajib)">
            <div class="stars-input" id="perf-stars" style="text-align:center; margin-bottom:20px;">
                <i class="fa-solid fa-star" onclick="rateStar('perf', 1)"></i>
                <i class="fa-solid fa-star" onclick="rateStar('perf', 2)"></i>
                <i class="fa-solid fa-star" onclick="rateStar('perf', 3)"></i>
                <i class="fa-solid fa-star" onclick="rateStar('perf', 4)"></i>
                <i class="fa-solid fa-star" onclick="rateStar('perf', 5)"></i>
            </div>
            <textarea id="perf-comment" class="input-request" placeholder="Komentar Anda..."></textarea>
            <button onclick="submitPerfRating()" class="btn-small" style="background:#E50914; color:white;">Kirim Penilaian</button>
        </div>
    </div>

    <!-- SCRIPT LOGIC (FIX: UPDATE STOK MEJA & NOMOR MEJA DI WA) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
   <!-- SCRIPT LOGIC BARU (FULL FEATURE: BOOKING, WA, LIVE, REVIEW) -->
<script type="module">
    import { db } from './firebase-config.js';
    import { 
        collection, doc, getDoc, getDocs, query, where, orderBy, addDoc, onSnapshot, updateDoc, increment 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- 1. INISIALISASI & DETEKSI LOKASI ---
    const urlParams = new URLSearchParams(window.location.search);
    const venueId = urlParams.get('id');
    let venueNameGlobal = ""; 

    if (!venueId) {
        alert("Lokasi tidak ditemukan! Kembali ke Home.");
        window.location.href = 'index.html';
    }

  // 2. LOAD DATA VENUE
    async function loadVenueDetails() {
        try {
            const docRef = doc(db, "venues", venueId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                venueNameGlobal = data.name;
                document.title = data.name + " - SMIPRO";

                // A. Load Video Live
                const videoContainer = document.getElementById('main-stage-container');
                if (data.youtubeId && data.liveLink) {
                    videoContainer.innerHTML = `
                        <iframe width="100%" height="100%" 
                            src="https://www.youtube.com/embed/${data.youtubeId}?autoplay=1&mute=0&rel=0" 
                            title="Live" frameborder="0" allowfullscreen style="border-radius:15px;">
                        </iframe>`;
                } else {
                    videoContainer.innerHTML = `
                        <div style="text-align:center; color:#555;">
                            <i class="fa-solid fa-video-slash fa-3x"></i><br>
                            <h3 style="margin:10px 0 0; color:#E50914;">${data.name}</h3>
                            <p>Siaran Offline / Belum Dimulai</p>
                        </div>`;
                }

                // B. Panggil Data Lain (HANYA DI SINI)
                loadWarungs(data.name);
                loadVenueReviews(venueId);
                loadEventSchedule(data.name); // Pastikan nama fungsi ini sesuai

            } else {
                alert("Data Venue Tidak Ditemukan!");
                window.location.href = 'index.html';
            }
        } catch (e) { console.error("Gagal load venue:", e); }
    }

    // --- 3. LOAD WARUNG (FILTER SESUAI LOKASI) ---
    function loadWarungs(vName) {
        const container = document.getElementById('warung-grid-ss3');
        const q = query(collection(db, "warungs"), where("venueName", "==", vName));

        onSnapshot(q, (snapshot) => {
            container.innerHTML = '';
            if (snapshot.empty) {
                container.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#555;">Belum ada warung buka di ${vName}.</p>`;
                return;
            }

            snapshot.forEach(docSnap => {
                const w = docSnap.data();
                // Hitung sisa meja (Total - Terpakai)
                const available = (parseInt(w.totalTables)||0) - (parseInt(w.bookedTables)||0); 
                const isFull = available <= 0;
                
                let btnHtml = isFull ? 
                    `<button class="btn-full-ss3">Penuh</button>` : 
                    `<button class="btn-book-ss3" onclick="window.openBooking('${w.name}', '${docSnap.id}')">Booking</button>`;
                
                const imgUrl = w.img || "https://via.placeholder.com/200?text=Warung";

                container.innerHTML += `
                <div class="warung-card">
                    <img src="${imgUrl}" class="warung-img">
                    <div class="warung-body">
                        <span class="warung-name">${w.name}</span>
                        <span class="warung-stats" style="color:${isFull ? 'red':'#00ff00'}">
                            ${isFull ? 'Full' : available + ' Meja Kosong'}
                        </span>
                        ${btnHtml}
                    </div>
                </div>`;
            });
        });
    }

    // --- 4. SISTEM BOOKING (UPDATE MEJA & WA) ---
    
    // Buka Modal
    window.openBooking = function(name, id) {
        document.getElementById('modal-warung-name').innerText = name;
        window.selectedWarungId = id; // Simpan ID di window agar bisa dibaca fungsi confirm
        
        // Reset form
        document.getElementById('book-name').value = '';
        document.getElementById('book-wa').value = '';
        document.getElementById('book-qty').value = '0 Meja';
        
        document.getElementById('booking-modal').style.display = 'flex';
    }

    // Konfirmasi Booking
    window.confirmBooking = async function() {
        const warungId = window.selectedWarungId;
        const warungName = document.getElementById('modal-warung-name').innerText;
        const name = document.getElementById('book-name').value;
        const wa = document.getElementById('book-wa').value;
        const dateVal = document.getElementById('book-date').value;
        const pax = parseInt(document.getElementById('book-pax').value) || 0;

        if(!name || !wa || !dateVal || pax < 1) return alert("Mohon lengkapi semua data!");

        const qty = Math.ceil(pax / 4); // 1 Meja = 4 Orang
        const now = new Date();
        const jamBooking = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');
        const kode = 'TIKET-' + Math.floor(1000 + Math.random() * 9000);

        try {
            // A. Cek Ketersediaan (Double Check)
            const wRef = doc(db, "warungs", warungId);
            const wSnap = await getDoc(wRef);
            const wData = wSnap.data();
            
            const currentBooked = parseInt(wData.bookedTables) || 0;
            const maxTables = parseInt(wData.totalTables) || 0;

            if (currentBooked + qty > maxTables) {
                return alert("Maaf, meja baru saja penuh! Sisa: " + (maxTables - currentBooked));
            }

            // B. Simpan Booking
            await addDoc(collection(db, "bookings"), {
                warungName: warungName,
                venueName: venueNameGlobal, // PENTING: Agar keuangan terpisah per venue
                customerName: name,
                customerWA: wa,
                pax: pax,
                tablesNeeded: qty,
                bookingDate: dateVal,
                arrivalTime: jamBooking,
                bookingCode: kode,
                status: 'booked', // Masuk ke status Booked
                timestamp: new Date()
            });

            // C. Update Stok Meja (Increment)
            await updateDoc(wRef, {
                bookedTables: increment(qty)
            });

            // D. Tutup & Kirim WA
            window.closeModal('booking-modal');
            
            const pesan = `Halo ${name},\nBooking Sukses di *${warungName}* (${venueNameGlobal}).\n` +
                          `Kode: *${kode}*\nJumlah: ${pax} Org (${qty} Meja)\nDatang: ${jamBooking}\n\n` +
                          `Tunjukkan chat ini saat kedatangan.`;
            
            if(confirm("Booking Berhasil! Kirim Tiket ke WA?")) {
                window.open(`https://wa.me/${wa}?text=${encodeURIComponent(pesan)}`, '_blank');
            }

        } catch (e) {
            console.error(e);
            alert("Gagal booking: " + e.message);
        }
    }

    // 5. LOAD JADWAL & TOMBOL BINTANG (INTEGRASI PERFORMER)
    function loadEventSchedule(vName) {
        const placeholder = document.getElementById('schedule-placeholder');
        if(!placeholder) return;

        // Query: Cari Event yang lokasinya SAMA dengan Venue ini
        const q = query(collection(db, "events"), 
            where("location", "==", vName), 
            orderBy("date", "desc"), 
            limit(1)
        );

        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) return; // Jika kosong, biarkan tampilan default

            const evt = snapshot.docs[0].data();
            let htmlList = '';

            // Loop Artis & Buat Tombol Bintang
            if(evt.performers && evt.performers.length > 0) {
                evt.performers.forEach(p => {
                    htmlList += `
                    <div class="perf-item" style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; margin-bottom:5px; border-radius:5px;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div style="background:#333; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                <i class="fa-solid fa-microphone" style="color:#E50914;"></i>
                            </div>
                            <div>
                                <b style="color:white;">${p.name}</b><br>
                                <small style="color:gold;">${p.time || 'Live Now'}</small>
                            </div>
                        </div>
                        
                        <!-- TOMBOL RATING (MENGHUBUNGKAN KE DASHBOARD PERFORMER) -->
                        <button onclick="window.openRatePerformer('${p.name}')" 
                            style="background:none; border:1px solid #555; color:gold; border-radius:50%; width:30px; height:30px; cursor:pointer;">
                            <i class="fa-regular fa-star"></i>
                        </button>
                    </div>`;
                });
            }

            // Update Tampilan Panel
            placeholder.innerHTML = `
                <div style="margin-bottom:15px; border-bottom:1px dashed #444; padding-bottom:10px; text-align:center;">
                    <h3 style="margin:0; color:#E50914;">${evt.displayDate || 'Live Event'}</h3>
                    <span style="background:red; color:white; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">ON AIR</span>
                </div>
                ${htmlList}
            `;
        });
    }

    // --- 5. SISTEM REQUEST SAWER ---
    window.openRequestModal = function() { document.getElementById('request-modal').style.display = 'flex'; }
    
    window.sendRequest = async function() {
        const song = document.getElementById('req-song').value;
        const msg = document.getElementById('req-msg').value;
        const target = document.getElementById('req-target').value;
        const amount = document.getElementById('req-amount').value;
        const sender = document.getElementById('req-sender').value;

        if(!song || !amount || !sender) return alert("Mohon isi Lagu, Nominal, dan Nama!");

        try {
            await addDoc(collection(db, "requests"), {
                song: song, message: msg, performer: target, 
                amount: parseInt(amount), sender: sender,
                status: 'pending',
                location: venueNameGlobal, // PENTING: Masuk ke laporan keuangan venue ini
                timestamp: new Date()
            });
            alert("Request Terkirim! Mohon tunggu konfirmasi Admin.");
            window.closeModal('request-modal');
        } catch(e) {
            alert("Gagal kirim: " + e.message);
        }
    }

    // --- 6. SISTEM REVIEW ---
    window.currentVenueRating = 0;
    
    window.rateStar = function(type, n) {
        if(type === 'venue') {
            window.currentVenueRating = n;
            document.querySelectorAll('#venue-stars i').forEach((s, i) => s.classList.toggle('active', i < n));
        }
    }

    window.submitVenueRating = async function() {
        const name = document.getElementById('venue-reviewer-name').value;
        const comment = document.getElementById('venue-comment').value;
        
        if(!name || window.currentVenueRating === 0) return alert("Beri bintang dan nama!");

        await addDoc(collection(db, "venue_reviews"), {
            venueId: venueId, // Review terikat ke ID Venue
            name: name,
            rating: window.currentVenueRating,
            comment: comment,
            timestamp: new Date()
        });
        alert("Terima kasih ulasannya!");
        document.getElementById('venue-comment').value = '';
    }

    function loadVenueReviews(vId) {
        const list = document.getElementById('venue-reviews-list');
        const q = query(collection(db, "venue_reviews"), where("venueId", "==", vId), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            list.innerHTML = '';
            if(snapshot.empty) {
                list.innerHTML = '<p style="text-align:center; color:#555;">Belum ada ulasan.</p>';
                return;
            }
            snapshot.forEach(doc => {
                const r = doc.data();
                let stars = "★".repeat(r.rating) + "☆".repeat(5 - r.rating);
                list.innerHTML += `
                <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px; border-left:3px solid #E50914">
                    <b>${r.name}</b> <small style="color:gold">${stars}</small>
                    <p style="margin:5px 0 0; font-size:0.9rem; color:#ccc">"${r.comment}"</p>
                </div>`;
            });
        });
    }

    // --- UTILS ---
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.hitungMeja = () => {
        let orang = parseInt(document.getElementById('book-pax').value) || 0;
        let qty = Math.ceil(orang / 4);
        document.getElementById('book-qty').value = qty + " Meja";
    }

    // --- EKSEKUSI ---
    loadVenueDetails();
   

</script>
</body>
</html>
