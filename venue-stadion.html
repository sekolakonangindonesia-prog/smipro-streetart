<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stadion Bayuangga - SMIPRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
         /* CSS STANDARD */
        :root { --primary: #E50914; --accent: #FFD700; --bg: #121212; --card: #1E1E1E; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; padding-bottom: 50px; }
        
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #000; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 999; }
        .btn-back { background: none; border: none; color: white; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .split-view { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 768px) { .split-view { grid-template-columns: 1.5fr 1fr; } }

        .live-frame { position: relative; width: 100%; height: 350px; background: url('https://images.unsplash.com/photo-1501612780327-450456b106f8?q=80&w=600') center/cover; border-radius: 15px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; }
        .play-btn-big { font-size: 4rem; color: rgba(255,255,255,0.9); }

        .live-panel { background: #151515; border: 1px solid #333; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; height: 350px; }
        .perf-item { display: flex; gap: 10px; background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; align-items: center; justify-content: space-between; }
        
        .btn-req { width: 100%; background: #E50914; color: white; padding: 12px; border: none; border-radius: 5px; margin-top: auto; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* WARUNG GRID */
        .section-title { color: #FFD700; margin: 40px 0 15px; font-size: 1.2rem; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .warung-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .warung-card { background: #1a1a1a; border-radius: 10px; border: 1px solid #333; overflow: hidden; text-align: center; transition: 0.3s; }
        
        /* HOVER AGAR USER TAU BISA DIKLIK */
        .warung-img { width: 100%; height: 100px; object-fit: cover; background: #333; cursor: pointer; }
        .warung-name { font-size: 1rem; font-weight: 800; color: white; margin-bottom: 5px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; text-decoration: underline; text-decoration-color: transparent; transition: 0.3s; }
        .warung-name:hover { text-decoration-color: var(--primary); color: var(--primary); }
        
        .warung-body { padding: 12px; }
        .warung-stats { font-size: 0.8rem; margin-bottom: 10px; display: block; }
        
        .btn-book-ss3 { background: #E50914; color: white; border: none; padding: 8px 0; width: 100%; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-full-ss3 { background: #555; color: #aaa; border: none; padding: 8px 0; width: 100%; border-radius: 20px; font-weight: bold; cursor: not-allowed; }

        .review-box { background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-top: 40px; }
        .venue-photo-review { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; border: 2px solid #555; }
        
        /* MODAL POPUP */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #1e1e1e; width: 100%; max-width: 350px; padding: 25px; border-radius: 10px; border: 1px solid #444; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-logo { width: 80px; display: block; margin: 0 auto 15px auto; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
        
        .input-request { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-small { border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        .close-icon { position: absolute; top: 15px; right: 15px; color: #888; cursor: pointer; font-size: 1.2rem; }

        .stars-input i { color: #444; cursor: pointer; font-size: 1.5rem; transition: 0.2s; }
        .stars-input i.active { color: gold; }

        @media (max-width: 600px) {
            .review-top-area { flex-direction: column; align-items: center; text-align: center; }
            .venue-photo-review { width: 100%; height: 150px; margin-bottom: 15px; }
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="index.html" class="logo-container" style="display:flex; align-items:center; text-decoration:none; gap:10px;">
            <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/Logo_Stretart.png" style="width:35px; height:35px; border-radius:50%; border:2px solid #E50914;">
            <span style="font-weight:800; color:#E50914; font-size:1.1rem;">SMIPRO</span>
        </a>
        <button onclick="location.href='index.html'" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Dashboard</button>
    </nav>

    <div class="container">
        
        <!-- BAGIAN ATAS: LIVE & REQUEST -->
        <div class="split-view">
            <div class="live-frame"id="main-stage-container">                                
                <i class="fa-solid fa-spinner fa-spin fa-2x"></i><br>
                Memuat Siaran...
                <div style="position:absolute; bottom:15px; left:15px;">
                    <h3 style="margin:0; text-shadow:0 0 10px black;">Panggung Utama Live</h3>
                </div>
            </div>

            <div class="live-panel" style="min-height:350px; display:flex; flex-direction:column;">
                
                <!-- WADAH JADWAL DINAMIS (Akan diisi otomatis oleh JS) -->
                <div id="schedule-placeholder" style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                    <!-- Tampilan Default Jika Tidak Ada Jadwal -->
                    <div style="text-align:center;">
                        <i class="fa-solid fa-music" style="font-size:3rem; color:#333; margin-bottom:10px;"></i>
                        <h3 style="margin:0; color:#E50914;">Dukung Performer</h3>
                        <p style="color:#888; font-size:0.9rem;">Kirim salam & request lagu sekarang.</p>
                    </div>
                </div>

                <!-- TOMBOL REQUEST (Selalu Muncul di Bawah) -->
                <button class="btn-req" onclick="window.openRequestModal()" style="margin-top:auto;">
                    <i class="fa-solid fa-music"></i> Request Lagu & Sawer
                </button>
            </div>
                             
        <hr style="border:0; border-top:1px dashed #444; margin:30px 0;">

        <!-- DAFTAR WARUNG -->
        <div class="section-title">PILIH WARUNG & BOOKING MEJA</div>
        
        <!-- PENTING: ID ini digunakan untuk menampilkan list -->
        <div id="warung-grid-ss3" class="warung-grid">
            <p style="grid-column:1/-1; text-align:center; padding:20px; color:#888;">
                <i class="fa-solid fa-circle-notch fa-spin"></i> Menyiapkan Data Warung...
            </p>
        </div>
        
        <!-- REVIEW LOKASI -->
        <div class="review-box">
            <div class="review-top-area" style="display:flex; gap:20px;">
                <div style="text-align:center; min-width:120px;">
                    <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/Stadion%20Bayuangga.jpg" class="venue-photo-review">
                    <div>
                        <div style="color:gold; font-size:1.2rem;" id="avg-stars">â˜…â˜…â˜…â˜…â˜…</div>
                        <span style="font-weight:bold; color:white;" id="avg-score">0.0 / 5.0</span>
                    </div>
                </div>
                <div style="flex:1;">
                    <h3 style="margin-top:0;">Ulasan Tempat</h3>
                    <input type="text" id="venue-reviewer-name" class="input-request" placeholder="Nama Anda (Wajib)">
                    <textarea id="venue-comment" class="input-request" style="height:60px;" placeholder="Bagaimana suasana di Stadion?"></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="stars-input" id="venue-stars">
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 1)"></i>
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 2)"></i>
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 3)"></i>
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 4)"></i>
                            <i class="fa-solid fa-star" onclick="rateStar('venue', 5)"></i>
                        </div>
                        <button class="btn-book-ss3" style="width:100px;" onclick="submitVenueRating()">Kirim</button>
                    </div>
                </div>
            </div>
            <div style="border-top:1px dashed #444; margin-top:20px; padding-top:15px;">
                <h4 style="margin:0 0 10px 0; color:#888;">Apa Kata Mereka?</h4>
                <div id="venue-reviews-list" style="max-height:300px; overflow-y:auto;">
                    <p style="text-align:center; color:#555;">Belum ada ulasan.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL REQUEST -->
    <div id="request-modal" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-xmark close-icon" onclick="closeModal('request-modal')"></i>
            <h3 style="margin-top:0; color:#E50914;">Request Lagu & Sawer</h3>
            
            <label style="color:#aaa; font-size:0.8rem;">Judul Lagu</label>
            <input type="text" id="req-song" class="input-request">
            
            <label style="color:#aaa; font-size:0.8rem;">Pesan / Salam</label>
            <input type="text" id="req-msg" class="input-request">
            
            <label style="color:#aaa; font-size:0.8rem;">Target Performer</label>
            <select id="req-target" class="input-request">
                <option value="">-- Pilih Artis yg Tampil --</option>
            </select>

            <label style="color:#aaa; font-size:0.8rem;">Nominal Sawer (Rp)</label>
            <input type="number" id="req-amount" class="input-request" placeholder="Min. 10.000">

            <label style="color:#aaa; font-size:0.8rem;">Nama Pengirim (Validasi Admin)</label>
            <input type="text" id="req-sender" class="input-request" style="border:1px solid gold;">

            <!-- QRIS SECTION -->
            <div style="text-align:center; background:white; padding:10px; border-radius:10px; margin:10px 0;">
                <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/qris.png" style="width:150px;">
                <br>
                <a href="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/qris.png" download="QRIS_SMIPRO.png" class="btn-small" style="background:#333; color:white; display:inline-block; margin-top:5px; text-decoration:none;">
                    <i class="fa-solid fa-download"></i> Download QR
                </a>
            </div>

            <button class="btn-book-ss3" onclick="window.sendRequest()">SUDAH TRANSFER (KIRIM)</button>
        </div>
    </div>

    <!-- MODAL BOOKING (REVISI: TANPA JAM DATANG) -->
    <div id="booking-modal" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-xmark close-icon" onclick="closeModal('booking-modal')"></i>
            <h3 style="margin:0; text-align:center;">Form Booking</h3>
            <p id="modal-warung-name" style="text-align:center; color:#FFD700; margin-bottom:15px; font-weight:bold;">-</p>
            
            <label style="color:#aaa; font-size:0.8rem;">Nama Pemesan</label>
            <input type="text" id="book-name" class="input-request">
            
            <label style="color:#aaa; font-size:0.8rem;">WhatsApp</label>
            <input type="number" id="book-wa" class="input-request" placeholder="08xxxxxxxx">

            <label style="color:#aaa; font-size:0.8rem;">Tanggal Booking</label>
            <input type="date" id="book-date" class="input-request" style="color-scheme: dark;">  
            
            <!-- INPUT JAM DIHAPUS DARI SINI -->
            
            <label style="color:#aaa; font-size:0.8rem;">Jumlah Orang</label>
            <input type="number" id="book-pax" class="input-request" placeholder="Total Orang" oninput="hitungMeja()">
            
            <label style="color:#aaa; font-size:0.8rem;">Kebutuhan Meja (1 Meja = 4 Org)</label>
            <input type="text" id="book-qty" class="input-request" readonly style="color:#E50914; font-weight:bold; background:#333;" value="0 Meja">
            
            <div style="background:#332b00; padding:10px; border-radius:5px; margin-bottom:15px; font-size:0.8rem; color:#ffeb3b; border:1px dashed #ffeb3b;">
                <i class="fa-solid fa-clock"></i> <b>ATURAN WAKTU:</b><br>
                Batas Check-in (Hangus) pukul <b>17:30 WIB</b>.
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-small" style="background:#444; color:white; flex:1;" onclick="closeModal('booking-modal')">Batal</button>
                <button class="btn-small" style="background:var(--green); color:black; flex:1;" onclick="confirmBooking()">Booking</button>
            </div>
        </div>
    </div>

    <!-- MODAL RATING PERFORMER -->
    <div id="rate-perf-modal" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-xmark close-icon" onclick="closeModal('rate-perf-modal')"></i>
            <h3 style="margin:0; color:#E50914; text-align:center;">Nilai Penampilan</h3>
            <p id="rate-target-name" style="font-weight:bold; color:white; text-align:center; margin-bottom:15px;">-</p>
            <input type="text" id="perf-reviewer-name" class="input-request" placeholder="Nama Anda (Wajib)">
            <div class="stars-input" id="perf-stars" style="text-align:center; margin-bottom:20px;">
                <i class="fa-solid fa-star" onclick="rateStar('perf', 1)"></i>
                <i class="fa-solid fa-star" onclick="rateStar('perf', 2)"></i>
                <i class="fa-solid fa-star" onclick="rateStar('perf', 3)"></i>
                <i class="fa-solid fa-star" onclick="rateStar('perf', 4)"></i>
                <i class="fa-solid fa-star" onclick="rateStar('perf', 5)"></i>
            </div>
            <textarea id="perf-comment" class="input-request" placeholder="Komentar Anda..."></textarea>
            <button onclick="submitPerfRating()" class="btn-small" style="background:#E50914; color:white;">Kirim Penilaian</button>
        </div>
    </div>

    <!-- SCRIPT LOGIC (FIX: UPDATE STOK MEJA & NOMOR MEJA DI WA) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
   <!-- SCRIPT LOGIC BARU (FULL FEATURE: BOOKING, WA, LIVE, REVIEW) -->
<script type="module">
    import { db } from './firebase-config.js';
    import { 
        collection, doc, getDoc, getDocs, query, where, orderBy, addDoc, onSnapshot, updateDoc, increment 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- 1. INISIALISASI & DETEKSI LOKASI ---
    const urlParams = new URLSearchParams(window.location.search);
    const venueId = urlParams.get('id');
    let venueNameGlobal = ""; 

    if (!venueId) {
        alert("Lokasi tidak ditemukan! Kembali ke Home.");
        window.location.href = 'index.html';
    }

  // 2. LOAD DATA VENUE
    async function loadVenueDetails() {
        try {
            const docRef = doc(db, "venues", venueId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                venueNameGlobal = data.name;
                document.title = data.name + " - SMIPRO";

                // --- UPDATE TAMPILAN REVIEW (Supaya Gambarnya Sesuai Lokasi) ---
                const reviewImg = document.querySelector('.venue-photo-review');
                if (reviewImg) {
                    // Pakai foto venue, kalau tidak ada pakai placeholder
                    reviewImg.src = data.img || "https://via.placeholder.com/150";
                }

                // A. Load Video Live
                const videoContainer = document.getElementById('main-stage-container');
                if (data.youtubeId && data.liveLink) {
                    videoContainer.innerHTML = `
                        <iframe width="100%" height="100%" 
                            src="https://www.youtube.com/embed/${data.youtubeId}?autoplay=1&mute=0&rel=0" 
                            title="Live" frameborder="0" allowfullscreen style="border-radius:15px;">
                        </iframe>`;
                } else {
                    videoContainer.innerHTML = `
                        <div style="text-align:center; color:#555;">
                            <i class="fa-solid fa-video-slash fa-3x"></i><br>
                            <h3 style="margin:10px 0 0; color:#E50914;">${data.name}</h3>
                            <p>Siaran Offline / Belum Dimulai</p>
                        </div>`;
                }

                // B. Panggil Data Lain (HANYA DI SINI)
                loadWarungs(data.name);
                loadVenueReviews(venueId);
                loadEventSchedule(data.name); // Pastikan nama fungsi ini sesuai

            } else {
                alert("Data Venue Tidak Ditemukan!");
                window.location.href = 'index.html';
            }
        } catch (e) { console.error("Gagal load venue:", e); }
    }

    // --- 3. LOAD WARUNG (FILTER SESUAI LOKASI) ---
    function loadWarungs(vName) {
        const container = document.getElementById('warung-grid-ss3');
        const q = query(collection(db, "warungs"), where("venueName", "==", vName));

        onSnapshot(q, (snapshot) => {
            container.innerHTML = '';
            if (snapshot.empty) {
                container.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#555;">Belum ada warung buka di ${vName}.</p>`;
                return;
            }

            snapshot.forEach(docSnap => {
                const w = docSnap.data();
                // Hitung sisa meja (Total - Terpakai)
                const available = (parseInt(w.totalTables)||0) - (parseInt(w.bookedTables)||0); 
                const isFull = available <= 0;
                
                let btnHtml = isFull ? 
                    `<button class="btn-full-ss3">Penuh</button>` : 
                    `<button class="btn-book-ss3" onclick="window.openBooking('${w.name}', '${docSnap.id}')">Booking</button>`;
                
                const imgUrl = w.img || "https://via.placeholder.com/200?text=Warung";

                container.innerHTML += `
                <div class="warung-card">
                    <img src="${imgUrl}" class="warung-img">
                    <div class="warung-body">
                        <span class="warung-name">${w.name}</span>
                        <span class="warung-stats" style="color:${isFull ? 'red':'#00ff00'}">
                            ${isFull ? 'Full' : available + ' Meja Kosong'}
                        </span>
                        ${btnHtml}
                    </div>
                </div>`;
            });
        });
    }

    // --- 4. SISTEM BOOKING (UPDATE MEJA & WA) ---
     window.selectedWarungId = null;
    // Buka Modal
    window.openBooking = function(name, id) {
         console.log("Membuka booking untuk:", name, "ID:", id);
        document.getElementById('modal-warung-name').innerText = name;
        window.selectedWarungId = id; // Simpan ID di window agar bisa dibaca fungsi confirm
        
        // Reset form
        document.getElementById('book-name').value = '';
        document.getElementById('book-wa').value = '';
        document.getElementById('book-qty').value = '0 Meja';
        
        document.getElementById('booking-modal').style.display = 'flex';
    }

    
    // Konfirmasi Booking
   // --- FUNGSI BOOKING REVISI (FIX ERROR db.collection) ---
    window.confirmBooking = async function() {
        const warungId = window.selectedWarungId;
        
        const warungName = document.getElementById('modal-warung-name').innerText;
        const name = document.getElementById('book-name').value;
        let wa = document.getElementById('book-wa').value;
        const dateVal = document.getElementById('book-date').value;
                       
         // Cek Pax
        const paxInput = document.getElementById('book-pax').value;
        const pax = parseInt(paxInput) || 0;

        // Validasi
        if(!warungId) return alert("Error: ID Warung tidak terdeteksi. Silakan refresh halaman.");
        if(!name || !wa || !dateVal || pax < 1) return alert("Mohon lengkapi semua data!");

        // Hitung Meja
        const qty = Math.ceil(pax / 4); 
        const now = new Date();
        const jamBooking = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');
        const kode = 'TIKET-' + Math.floor(1000 + Math.random() * 9000);
        const fullExpiredTime = `${dateVal}T17:30`;
        
        // FIX WA
        if (wa.startsWith('0')) wa = '62' + wa.slice(1);

        const warungName = document.getElementById('modal-warung-name').innerText;
        const kode = 'TIKET-' + Math.floor(1000 + Math.random() * 9000);
        const fullExpiredTime = `${dateVal}T17:30`; 

        try {
            // 1. CARI MEJA KOSONG
            const qBooking = query(collection(db, "bookings"), 
                where("warungId", "==", warungId), // Pakai ID biar akurat
                where("status", "in", ["active", "booked"])
            );
            const snapshot = await getDocs(qBooking);

            let usedTables = [];
            snapshot.forEach(doc => {
                const d = doc.data();
                if(Array.isArray(d.tableNum)) usedTables.push(...d.tableNum);
                else if(d.tableNum) usedTables.push(d.tableNum);
            });

            let usedTables = [];
            snapshot.forEach(doc => {
                const d = doc.data();
                if(Array.isArray(d.tableNum)) usedTables.push(...d.tableNum);
                else if (d.tableNum) usedTables.push(d.tableNum);
            });

            let assignedTables = [];
            for(let i = 1; i <= 15; i++) {
                if(!usedTables.includes(i)) {
                    assignedTables.push(i);
                    if(assignedTables.length === qty) break;
                }
            }

            if(assignedTables.length < qty) {
                return alert(`Mohon maaf, meja penuh! Tersisa ${assignedTables.length} meja.`);
            }

            const mejaString = assignedTables.join(", "); 

            // === B. SIMPAN KE DATABASE (Gaya Baru) ===
            await addDoc(collection(db, "bookings"), {
                warungId: warungId,
                warungName: warungName,
                venueName: venueNameGlobal, 
                customerName: name,
                customerWA: wa,
                pax: pax,
                tablesNeeded: qty,
                tableNum: assignedTables,
                bookingDate: dateVal,
                arrivalTime: jamBooking,
                bookingCode: kode,
                expiredTime: fullExpiredTime,
                status: 'booked',
                revenue: 0,
                timestamp: new Date()
            });

            // 3. UPDATE STOK WARUNG
            const wRef = doc(db, "warungs", warungId);
            await updateDoc(wRef, {
                bookedTables: increment(qty) // Pastikan fieldnya bookedTables
                // Kalau di database bapak namanya 'bookedCount', ganti jadi 'bookedCount'
            });

            window.closeModal('booking-modal');

            // --- D. FORMAT WA ---
            const pesan = `Halo ${name},\n\n` +
                          `Terima kasih sudah memesan tempat di *${warungName}* pada jam ${jamBooking}\n` +
                          `Berikut detail pesanan Anda:\n` +
                          `Tanggal: ${dateVal}\n` +
                          `Jumlah: ${pax} Orang\n` +
                          `Kode Tiket: *${kode}*\n` +
                          `MEJA RESERVASI: No. ${mejaString}\n` +
                          `Scan QR yang ada di meja no tersebut untuk check-in\n\n` +
                          `PENTING: Harap Check-In sebelum Pukul *17:30 WIB*.\n` +
                          `Lewat dari jam tersebut, harap hubungi *${warungName}*`;
            
            if(confirm(`Booking Berhasil! Meja No: ${mejaString}\nKirim Tiket ke WA?`)) {
                window.open(`https://wa.me/${wa}?text=${encodeURIComponent(pesan)}`, '_blank');
            }

            // Reset Form
            document.getElementById('book-name').value = '';
            document.getElementById('book-wa').value = '';
            document.getElementById('book-pax').value = '';
            document.getElementById('book-qty').value = '0 Meja';

        } catch (e) {
            console.error(e);
            alert("Gagal booking: " + e.message); // Pesan error asli
        }
    }
    

 // 5. LOAD JADWAL (VERSI FINAL - ANTI ERROR INDEX & LIMIT)
    function loadEventSchedule(vName) {
        const placeholder = document.getElementById('schedule-placeholder');
        if(!placeholder) return;

        console.log("ðŸ”¥ MEMULAI PENCARIAN JADWAL (SAFE MODE)...");

        // 1. QUERY POLOS (Hanya ambil collection, tanpa sort/limit di database)
        // Ini untuk menghindari Error "Index" dan "limit is not defined"
        const q = query(collection(db, "events"));

        onSnapshot(q, (snapshot) => {
            let allEvents = [];

            // 2. AMBIL SEMUA DATA
            snapshot.forEach(doc => {
                allEvents.push(doc.data());
            });

            // 3. SORTING DI JAVASCRIPT (Mengurutkan tanggal dari yang terbaru)
            allEvents.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA; // Yang paling baru di atas
            });

            // 4. CARI YANG COCOK DENGAN LOKASI INI
            let matchedEvent = null;
            
            // Bersihkan nama lokasi halaman ini (hapus spasi & huruf kecil)
            const currentLocation = String(vName || "").toLowerCase().trim();

            for (let evt of allEvents) {
                const dbLocation = String(evt.location || "").toLowerCase().trim();
                
                // Cek kecocokan (menggunakan includes agar lebih fleksibel)
                if (dbLocation.includes(currentLocation) || currentLocation.includes(dbLocation)) {
                    matchedEvent = evt;
                    break; // Ketemu satu, langsung stop
                }
            }

            // 5. RENDER TAMPILAN
            if (matchedEvent) {
                console.log("âœ… Jadwal Ditemukan!", matchedEvent);
                
                let htmlList = '';
                if(matchedEvent.performers && matchedEvent.performers.length > 0) {
                    matchedEvent.performers.forEach(p => {
                        htmlList += `
                        <div class="perf-item" style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; margin-bottom:5px; border-radius:5px;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div style="background:#333; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                    <i class="fa-solid fa-microphone" style="color:#E50914;"></i>
                                </div>
                                <div>
                                    <b style="color:white;">${p.name}</b><br>
                                    <small style="color:gold;">${p.time || 'Live Now'}</small>
                                </div>
                            </div>
                            
                            <button onclick="window.openRatePerformer('${p.name}')" 
                                style="background:none; border:1px solid #555; color:gold; border-radius:50%; width:30px; height:30px; cursor:pointer;">
                                <i class="fa-regular fa-star"></i>
                            </button>
                        </div>`;
                    });
                }

                // 1. Render HTML Jadwal Dulu (TUTUP BACKTICK DI SINI)
            placeholder.innerHTML = `
                <div style="margin-bottom:15px; border-bottom:1px dashed #444; padding-bottom:10px; text-align:center;">
                    <h3 style="margin:0; color:#E50914;">${matchedEvent.displayDate || 'Live Event'}</h3>
                    <span style="background:red; color:white; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">ON SCHEDULE</span>
                </div>
                ${htmlList}
            `; 
            // ^^^ Perhatikan: Tanda petik miring penutup (backtick) ada di sini!

            // 2. BARU JALANKAN LOGIC JS DI BAWAHNYA (DI LUAR HTML)
            const reqSelect = document.getElementById('req-target');
            
            if (reqSelect && matchedEvent.performers) {
                // Reset Pilihan
                reqSelect.innerHTML = '<option value="">-- Pilih Artis yg Tampil --</option>';
                
                // Masukkan Nama Artis
                matchedEvent.performers.forEach(p => {
                    reqSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
                });
                
                // Tambah Opsi Umum
                reqSelect.innerHTML += `<option value="Venue">Sawer Venue / Crew</option>`;
            }
                
            } else {
                console.log("âš ï¸ Tidak ada jadwal untuk lokasi ini.");
                // Tampilan Default (Biarkan saja)
            }
        });
    }

    // --- 5. SISTEM REQUEST SAWER ---
    window.openRequestModal = function() { document.getElementById('request-modal').style.display = 'flex'; }
    
    window.sendRequest = async function() {
        const songEl = document.getElementById('req-song');
        const msgEl = document.getElementById('req-msg');
        const targetEl = document.getElementById('req-target');
        const amountEl = document.getElementById('req-amount');
        const senderEl = document.getElementById('req-sender');

        const song = songEl.value;
        const msg = msgEl.value;
        const target = targetEl.value;
        const amount = amountEl.value;
        const sender = senderEl.value;

        if(!song || !amount || !sender) return alert("Mohon isi Lagu, Nominal, dan Nama!");

        try {
            await addDoc(collection(db, "requests"), {
                song: song, message: msg, performer: target, 
                amount: parseInt(amount), sender: sender,
                status: 'pending',
                location: venueNameGlobal, // PENTING: Masuk ke laporan keuangan venue ini
                timestamp: new Date()
            });
            alert("Request Terkirim! Mohon tunggu konfirmasi Admin.");

            // --- TUTUP & RESET ---
            document.getElementById('request-modal').style.display = 'none'; // Tutup Modal

            // Kosongkan Input
            songEl.value = "";
            msgEl.value = "";
            amountEl.value = "";
            senderEl.value = "";
                        
        } catch(e) {
            console.error(e);
            alert("Gagal kirim: " + e.message);
        }
    }

    // --- 6. SISTEM RATING PERFORMER (POPUP BINTANG) ---
    
    let targetPerformerName = ""; // Variabel global untuk simpan nama artis
    let currentPerfRating = 0;

    // A. Buka Modal Rating
    window.openRatePerformer = function(name) {
        targetPerformerName = name;
        // Update Judul Modal
        const titleEl = document.getElementById('rate-target-name');
        if(titleEl) titleEl.innerText = name;
        
        currentPerfRating = 0;
        // Reset Bintang
        document.querySelectorAll('#perf-stars i').forEach(s => s.classList.remove('active'));
        
        // Tampilkan Modal
        document.getElementById('rate-perf-modal').style.display = 'flex';
    }

    // B. Klik Bintang (Bisa dipakai untuk Venue & Performer)
    window.rateStar = function(type, n) {
        if(type === 'perf') {
            currentPerfRating = n;
            document.querySelectorAll('#perf-stars i').forEach((s, i) => s.classList.toggle('active', i < n));
        } else if (type === 'venue') {
            window.currentVenueRating = n;
            document.querySelectorAll('#venue-stars i').forEach((s, i) => s.classList.toggle('active', i < n));
        }
    }

    // C. Kirim Penilaian ke Firebase
    window.submitPerfRating = async function() {
        const name = document.getElementById('perf-reviewer-name').value;
        const comment = document.getElementById('perf-comment').value;

        if (!name || currentPerfRating === 0) return alert("Mohon isi nama & bintang!");

        try {
            await addDoc(collection(db, "performer_reviews"), {
                performerName: targetPerformerName,
                reviewer: name,
                rating: currentPerfRating,
                comment: comment,
                venue: venueNameGlobal, // Info tambahan
                timestamp: new Date()
            });
            
            alert(`Terima kasih! Penilaian untuk ${targetPerformerName} terkirim.`);
            window.closeModal('rate-perf-modal');
            
            // Reset Form
            document.getElementById('perf-reviewer-name').value = "";
            document.getElementById('perf-comment').value = "";
            
        } catch(e) {
            console.error(e);
            alert("Gagal mengirim: " + e.message);
        }
    }

    // --- 6. SISTEM REVIEW ---
    window.currentVenueRating = 0;
    
    window.rateStar = function(type, n) {
        if(type === 'venue') {
            window.currentVenueRating = n;
            document.querySelectorAll('#venue-stars i').forEach((s, i) => s.classList.toggle('active', i < n));
        }
    }

    window.submitVenueRating = async function() {
        const name = document.getElementById('venue-reviewer-name').value;
        const comment = document.getElementById('venue-comment').value;
        
        if(!name || window.currentVenueRating === 0) return alert("Beri bintang dan nama!");

        try {
            await addDoc(collection(db, "venue_reviews"), {
                venueId: venueId, // <--- KUNCI PENTING: ID LOKASI
                venueName: venueNameGlobal, // Opsional: Biar admin tau nama lokasinya
                name: name,
                rating: window.currentVenueRating,
                comment: comment,
                timestamp: new Date()
            });
            
            alert("Terima kasih ulasannya!");
            document.getElementById('venue-comment').value = '';
            document.getElementById('venue-reviewer-name').value = '';
            // Reset Bintang
            window.rateStar('venue', 0);
            
        } catch(e) {
            console.error(e);
            alert("Gagal kirim ulasan: " + e.message);
        }
    }

    function loadVenueReviews(vId) {
        const list = document.getElementById('venue-reviews-list');
        const q = query(collection(db, "venue_reviews"), 
            where("venueId", "==", vId), 
            orderBy("timestamp", "desc")
        );
        
        onSnapshot(q, (snapshot) => {
            list.innerHTML = '';
            if(snapshot.empty) {
                list.innerHTML = '<p style="text-align:center; color:#555;">Belum ada ulasan.</p>';
                return;
            }
            snapshot.forEach(doc => {
                const r = doc.data();
                let stars = "â˜…".repeat(r.rating) + "â˜†".repeat(5 - r.rating);
                list.innerHTML += `
                <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px; border-left:3px solid #E50914">
                    <b>${r.name}</b> <small style="color:gold">${stars}</small>
                    <p style="margin:5px 0 0; font-size:0.9rem; color:#ccc">"${r.comment}"</p>
                </div>`;
            });
        });
    }

    // --- UTILS ---
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.hitungMeja = () => {
        let orang = parseInt(document.getElementById('book-pax').value) || 0;
        let qty = Math.ceil(orang / 4);
        document.getElementById('book-qty').value = qty + " Meja";
    }

    // --- EKSEKUSI ---
    loadVenueDetails();
   

</script>
</body>
</html>
