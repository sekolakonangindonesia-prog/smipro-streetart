<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Warung - SMIPRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #121212; color: white; padding-bottom: 80px; }
        .profile-header {
            height: 200px;
            background: url('https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/refs/heads/main/Bener%20Dasboard3.jpg') center/cover;
            position: relative;
        }
        .header-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, #121212); }
        .warung-info-box { text-align: center; margin-top: -50px; position: relative; z-index: 10; padding: 0 20px; }
        .warung-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            border: 3px solid var(--primary); object-fit: cover; background: #000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
        .menu-card { background: #1e1e1e; border-radius: 10px; overflow: hidden; border: 1px solid #333; transition: 0.3s; }
        .menu-img { width: 100%; height: 120px; object-fit: cover; }
        .menu-info { padding: 10px; }
        .menu-title { font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        .menu-price { color: gold; font-size: 0.9rem; }
        .bottom-action {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1a1a1a; border-top: 1px solid #333;
            padding: 15px; box-sizing: border-box; display: flex; gap: 10px; z-index: 100;
        }
        .btn-status { flex: 1; text-align: center; padding: 12px; font-weight: bold; border-radius: 5px; background: #333; color: #aaa; cursor: default; }
        .btn-book-action { flex: 2; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-book-action:disabled { background: #555; cursor: not-allowed; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #1e1e1e; width: 100%; max-width: 350px; padding: 25px; border-radius: 10px; border: 1px solid #444; position: relative; max-height: 90vh; overflow-y: auto; }
        .input-request { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-small { border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        .close-icon { position: absolute; top: 15px; right: 15px; color: #888; cursor: pointer; font-size: 1.2rem; }
        /* --- TAMBAHAN GAYA BARU --- */
        
        /* 1. Logo Pojok Kiri */
        .corner-logo {
            position: absolute; top: 15px; left: 15px; width: 45px; height: 45px; 
            border-radius: 50%; border: 2px solid #E50914; object-fit: cover; z-index: 30;
            background: #000; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* 2. Tombol Kembali (Disesuaikan posisinya di bawah logo) */
        .btn-back-custom {
            position: absolute; top: 70px; left: 15px; /* Turun ke bawah logo */
            background: rgba(0,0,0,0.6); border: 1px solid #555; color: white; 
            padding: 5px 12px; border-radius: 20px; cursor: pointer; z-index: 20;
            font-size: 0.8rem; display: flex; align-items: center; gap: 5px;
            backdrop-filter: blur(5px);
        }

        /* 3. Rating Bintang */
        .warung-rating { margin-bottom: 10px; color: gold; font-size: 0.9rem; }
        .warung-rating span { color: #aaa; font-size: 0.8rem; margin-left: 5px; }
        
        /* GAYA UNTUK ULASAN WARUNG */
        .review-section { margin-top: 30px; border-top: 1px dashed #333; padding-top: 20px; }
        .stars-input i { font-size: 1.5rem; color: #444; cursor: pointer; transition: 0.2s; margin-right: 5px; }
        .stars-input i.active { color: gold; }
        .review-card { background: #1e1e1e; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--primary); }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .review-stars { color: gold; font-size: 0.8rem; }

        
    </style>
</head>
<body>

    <!-- HEADER GAMBAR -->
    <div class="profile-header">
        
        <!-- 1. LOGO KECIL (BARU) -->
        <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/Logo_Stretart.png" class="corner-logo">

        <!-- 2. TOMBOL KEMBALI (POSISI DIPERBAIKI) -->
        <button onclick="history.back()" class="btn-back-custom">
            <i class="fa-solid fa-arrow-left"></i> Kembali
        </button>

        <div class="header-overlay"></div>
    </div>

    <!-- INFO WARUNG -->
    <div class="warung-info-box">
        <img src="" id="w-img" class="warung-avatar" onerror="this.src='https://via.placeholder.com/150'">
        
        <h2 style="margin:10px 0 5px 0;" id="w-name">Memuat...</h2>
        
        <!-- 3. RATING BINTANG (BARU) -->
        <div class="warung-rating">
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star-half-stroke"></i>
            <span>4.8 / 5.0</span>
        </div>

        <span id="w-status" style="background:#333; padding:3px 10px; border-radius:10px; font-size:0.8rem;">...</span>
    </div>

    <div class="container">
        <!-- ... (Kode selebihnya biarkan sama) ... -->

    <div class="container">
        <h3 style="border-bottom:1px solid #333; padding-bottom:10px; margin-top:30px; color:var(--accent);">Daftar Menu</h3>
        <div id="menu-grid" class="menu-grid">
            <p style="grid-column:1/-1; text-align:center; color:#666;">
                <i class="fa-solid fa-circle-notch fa-spin"></i> Memuat Menu...
            </p>
        </div>
    </div>

        <!-- FORMULIR ULASAN -->
        <div class="review-section">
            <h3 style="color:var(--accent);">Ulasan Pelanggan</h3>
            
            <div style="background:#1a1a1a; padding:15px; border-radius:10px; border:1px solid #333; margin-bottom:20px;">
                <input type="text" id="review-name" class="input-request" placeholder="Nama Anda">
                <textarea id="review-comment" class="input-request" style="height:60px;" placeholder="Tulis pengalaman makan disini..."></textarea>
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <!-- Bintang yang bisa diklik -->
                    <div class="stars-input" id="warung-stars-input">
                        <i class="fa-solid fa-star" onclick="rateWarung(1)"></i>
                        <i class="fa-solid fa-star" onclick="rateWarung(2)"></i>
                        <i class="fa-solid fa-star" onclick="rateWarung(3)"></i>
                        <i class="fa-solid fa-star" onclick="rateWarung(4)"></i>
                        <i class="fa-solid fa-star" onclick="rateWarung(5)"></i>
                    </div>
                    <button class="btn-small" style="width:100px; background:var(--primary); color:white;" onclick="submitWarungReview()">Kirim</button>
                </div>
            </div>

            <!-- TEMPAT MUNCULNYA KOMENTAR -->
            <div id="warung-reviews-list">
                <p style="text-align:center; color:#555;">Belum ada ulasan.</p>
            </div>
        </div>
        
    <div class="bottom-action">
        <div class="btn-status" id="table-status-display">Cek Status...</div>
        <button id="btn-booking-trigger" class="btn-book-action" onclick="openBookingModal()" disabled>Loading...</button>
    </div>

    <div id="booking-modal" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-xmark close-icon" onclick="closeModal()"></i>
            <h3 style="margin:0; text-align:center;">Booking Meja</h3>
            <p id="modal-warung-title" style="text-align:center; color:#FFD700; margin-bottom:15px; font-weight:bold;">-</p>
            
            <label style="color:#aaa; font-size:0.8rem;">Nama Pemesan</label>
            <input type="text" id="book-name" class="input-request">
            
            <label style="color:#aaa; font-size:0.8rem;">WhatsApp (Untuk Tiket)</label>
            <input type="number" id="book-wa" class="input-request" placeholder="08xxxxxxxx">
            
            <label style="color:#aaa; font-size:0.8rem;">Tanggal Booking</label>
            <input type="date" id="book-date" class="input-request" style="color-scheme: dark;"> 

            <label style="color:#aaa; font-size:0.8rem;">Jumlah Orang</label>
            <input type="number" id="book-pax" class="input-request" placeholder="Total Orang" oninput="hitungMeja()">
            
            <label style="color:#aaa; font-size:0.8rem;">Kebutuhan Meja</label>
            <input type="text" id="book-qty" class="input-request" readonly style="color:#E50914; font-weight:bold; background:#333;" value="0 Meja">

            <div style="background:#332b00; padding:10px; border-radius:5px; margin-bottom:15px; font-size:0.8rem; color:#ffeb3b; border:1px dashed #ffeb3b;">
                <i class="fa-solid fa-clock"></i> <b>ATURAN WAKTU:</b><br>
                Batas Check-in (Hangus) pukul <b>17:30 WIB</b>.
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-small" style="background:#444; color:white; flex:1;" onclick="closeModal()">Batal</button>
                <button class="btn-small" style="background:var(--green); color:black; flex:1;" onclick="confirmBooking()">Pesan Sekarang</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT UPDATE: PERBAIKAN IMPORT & LOGIKA RATING -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { 
            doc, getDoc, collection, query, where, onSnapshot, getDocs, addDoc, updateDoc, increment, orderBy 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const params = new URLSearchParams(window.location.search);
        const warungId = params.get('id');
        
        let currentWarungName = "";
        let venueNameGlobal = ""; 
        let totalTables = 0;
        // Variabel untuk menyimpan rating saat ini agar hitungannya akurat
        let currentRatingScore = 0; 
        let currentReviewCount = 0;

        if(warungId) {
            // 1. DATA WARUNG (REALTIME)
            onSnapshot(doc(db, "warungs", warungId), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    currentWarungName = data.name;
                    venueNameGlobal = data.venueName || "Stadion Bayuangga"; 
                    totalTables = data.totalTables;
                    
                    // Simpan data rating lama untuk perhitungan update nanti
                    currentRatingScore = data.rating || 0; // Misal 4.5
                    currentReviewCount = data.reviewCount || 0; // Misal 10 ulasan

                    document.getElementById('w-name').innerText = data.name;
                    if(data.img) document.getElementById('w-img').src = data.img;

                    // TAMPILKAN RATING DARI DATABASE PUSAT (Agar sinkron dengan SS2)
                    const ratingBox = document.querySelector('.warung-rating');
                    if(ratingBox) {
                        const scoreTampil = currentRatingScore.toFixed(1); // 4.8
                        ratingBox.innerHTML = `
                            <i class="fa-solid fa-star"></i> 
                            <span style="font-size:1.2rem; font-weight:bold; color:white;">${scoreTampil}</span> 
                            <span style="font-size:0.8rem;">(${currentReviewCount} Ulasan)</span>
                        `;
                    }
                    
                    // LOGIKA STATUS MEJA
                    const available = (parseInt(data.totalTables)||0) - (parseInt(data.bookedCount)||0);
                    const isFull = available <= 0;
                    
                    const btnStatus = document.getElementById('table-status-display');
                    const btnBook = document.getElementById('btn-booking-trigger');

                    if (data.status === 'closed') {
                        document.getElementById('w-status').innerText = "SEDANG TUTUP";
                        document.getElementById('w-status').style.color = "red";
                        btnStatus.innerText = "WARUNG TUTUP";
                        btnBook.innerText = "TIDAK MENERIMA PESANAN";
                        btnBook.disabled = true;
                        btnBook.style.background = "#555";
                    } else if (isFull) {
                        document.getElementById('w-status').innerText = "BUKA - PENUH";
                        document.getElementById('w-status').style.color = "orange";
                        btnStatus.innerText = "0 Meja";
                        btnBook.innerText = "FULL BOOKED";
                        btnBook.disabled = true;
                        btnBook.style.background = "#555";
                    } else {
                        document.getElementById('w-status').innerText = "BUKA";
                        document.getElementById('w-status').style.color = "#00ff00";
                        btnStatus.innerText = `${available} Meja Tersedia`;
                        btnBook.innerText = "BOOKING SEKARANG";
                        btnBook.disabled = false;
                        btnBook.style.background = "#E50914";
                    }
                }
            });

            // 2. DATA MENU
            const qMenu = query(collection(db, "menus"), where("warungId", "==", warungId));
            onSnapshot(qMenu, (snapshot) => {
                const grid = document.getElementById('menu-grid');
                grid.innerHTML = '';
                if(snapshot.empty) {
                    grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">Belum ada menu.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const m = docSnap.data();
                    grid.innerHTML += `
                    <div class="menu-card">
                        <img src="${m.img || 'https://via.placeholder.com/150'}" class="menu-img">
                        <div class="menu-info">
                            <span class="menu-title">${m.name}</span>
                            <span class="menu-price">Rp ${parseInt(m.price).toLocaleString()}</span>
                        </div>
                    </div>`;
                });
            });
            
            // 3. LOAD REVIEW LIST (TAPI HITUNGAN RATA-RATA DIAMBIL DARI DATA WARUNG DIATAS)
            const qReview = query(collection(db, "warung_reviews"), 
                where("warungId", "==", warungId),
                orderBy("timestamp", "desc") // SEKARANG SUDAH BISA JALAN
            );

            onSnapshot(qReview, (snapshot) => {
                const list = document.getElementById('warung-reviews-list');
                list.innerHTML = ''; 
                
                if(snapshot.empty) {
                    list.innerHTML = '<p style="text-align:center; color:#555;">Belum ada ulasan. Jadilah yang pertama!</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const r = doc.data();
                    let starsHtml = "★".repeat(r.rating) + "☆".repeat(5 - r.rating);
                    list.innerHTML += `
                    <div class="review-card">
                        <div class="review-header">
                            <b style="color:white;">${r.name}</b>
                            <span class="review-stars">${starsHtml}</span>
                        </div>
                        <p style="margin:0; color:#ccc; font-size:0.9rem;">"${r.comment}"</p>
                    </div>`;
                });
            });

        } else {
            alert("Warung tidak ditemukan!");
            window.location.href = 'index.html';
        }

        // --- FUNGSI GLOBAL (WINDOW) ---

        // 1. LOGIK BINTANG DIKLIK
        let selectedRating = 0;
        window.rateWarung = function(n) {
            selectedRating = n;
            document.querySelectorAll('#warung-stars-input i').forEach((s, i) => {
                // i dimulai dari 0, jadi jika n=3 (bintang ke-3), kita highlight index 0,1,2
                if (i < n) s.classList.add('active');
                else s.classList.remove('active');
            });
        }

        // 2. KIRIM REVIEW (DAN UPDATE RATING PUSAT)
        window.submitWarungReview = async function() {
            const name = document.getElementById('review-name').value;
            const comment = document.getElementById('review-comment').value;

            if(!name || selectedRating === 0) return alert("Mohon isi Nama dan pilih Bintang!");

            try {
                // A. Simpan Ulasan ke tabel 'warung_reviews'
                await addDoc(collection(db, "warung_reviews"), {
                    warungId: warungId,
                    warungName: currentWarungName,
                    name: name,
                    rating: selectedRating,
                    comment: comment,
                    timestamp: new Date()
                });

                // B. HITUNG RATA-RATA BARU UNTUK UPDATE DATA INDUK
                // Rumus: ((Rata2 Lama * Jml Lama) + Nilai Baru) / (Jml Lama + 1)
                const oldTotalScore = currentRatingScore * currentReviewCount;
                const newTotalScore = oldTotalScore + selectedRating;
                const newCount = currentReviewCount + 1;
                const newAverage = newTotalScore / newCount;

                // C. Update Data Warung Utama (Supaya Halaman Depan/SS2 ikut berubah)
                await updateDoc(doc(db, "warungs", warungId), {
                    rating: newAverage,
                    reviewCount: newCount // Kita update jumlah ulasannya juga
                });

                alert("Terima kasih! Ulasan Anda berhasil dikirim.");
                
                // Reset Form
                document.getElementById('review-name').value = '';
                document.getElementById('review-comment').value = '';
                window.rateWarung(0); 

            } catch (e) {
                console.error(e);
                alert("Gagal kirim ulasan: " + e.message);
            }
        }

        // 3. BOOKING MODAL & LOGIC
        window.openBookingModal = function() {
            document.getElementById('modal-warung-title').innerText = currentWarungName;
            document.getElementById('book-name').value = '';
            document.getElementById('book-wa').value = '';
            document.getElementById('book-date').value = '';
            document.getElementById('book-pax').value = '';
            document.getElementById('book-qty').value = '0 Meja';
            document.getElementById('booking-modal').style.display = 'flex';
        }

        window.hitungMeja = function() {
            let orang = parseInt(document.getElementById('book-pax').value) || 0;
            let qty = orang < 1 ? 0 : Math.ceil(orang / 4);
            document.getElementById('book-qty').value = qty + " Meja";
        }

        window.closeModal = function() { document.getElementById('booking-modal').style.display = 'none'; }

        // LOGIKA BOOKING (Sesuai kode lama dulu, nanti kita perbaiki di langkah selanjutnya)
        window.confirmBooking = async function() {
            const name = document.getElementById('book-name').value;
            let wa = document.getElementById('book-wa').value;
            const dateVal = document.getElementById('book-date').value; 
            const pax = parseInt(document.getElementById('book-pax').value) || 0;
            const qty = Math.ceil(pax / 4); 

            if(!name || !wa || !dateVal || pax < 1) return alert("Mohon lengkapi data!");
            if (wa.startsWith('0')) wa = '62' + wa.slice(1);

            const now = new Date();
            const jamBooking = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');
            const kode = 'TIKET-' + Math.floor(1000 + Math.random() * 9000);

            // Cek Ketersediaan
            const q = query(collection(db, "bookings"), 
                where("warungId", "==", warungId), 
                where("status", "in", ["active", "booked"])
            );
            const snapshot = await getDocs(q);

            let usedTables = [];
            snapshot.forEach(doc => {
                const d = doc.data();
                if (Array.isArray(d.tableNum)) usedTables.push(...d.tableNum);
                else usedTables.push(d.tableNum);
            });

            let assignedTables = [];
            for (let i = 1; i <= totalTables; i++) {
                if (!usedTables.includes(i)) {
                    assignedTables.push(i);
                    if (assignedTables.length === qty) break; 
                }
            }

            if (assignedTables.length < qty) return alert("Maaf, meja tidak cukup saat ini.");

            try {
                await addDoc(collection(db, "bookings"), {
                    warungId: warungId,           
                    warungName: currentWarungName,
                    venueName: venueNameGlobal,   
                    customerName: name, 
                    customerWA: wa,
                    pax: pax, 
                    tablesNeeded: qty,
                    tableNum: assignedTables, 
                    bookingDate: dateVal,
                    arrivalTime: jamBooking, 
                    expiredTime: `${dateVal}T17:30`,
                    bookingCode: kode, 
                    status: 'booked', 
                    revenue: 0,
                    timestamp: new Date()
                });

                await updateDoc(doc(db, "warungs", warungId), {
                    bookedCount: increment(qty)
                });

                window.closeModal();

                const mejaString = assignedTables.join(", ");
                const pesan = `Halo ${name}, Booking ${currentWarungName} Sukses! Tiket: ${kode}, Meja: ${mejaString}`;
                if(confirm(`Booking Sukses!\nMeja Anda: ${mejaString}\n\nKirim tiket ke WA?`)) {
                    window.open(`https://wa.me/${wa}?text=${encodeURIComponent(pesan)}`, '_blank');
                }
            } catch (e) {
                console.error(e);
                alert("Gagal Booking: " + e.message);
            }
        }
    </script>
</body>
</html>
