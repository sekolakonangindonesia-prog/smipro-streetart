<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Event - SMIPRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS KHUSUS FILTER */
        .filter-container {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-label { color: #aaa; font-size: 0.9rem; white-space: nowrap; }
        .filter-select {
            width: 100%;
            padding: 10px;
            background: #000;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }
        .filter-select:focus { border-color: var(--primary); outline: none; }

        /* CSS KARTU LAMA (TETAP SAMA) */
        .schedule-card-main {
            background: linear-gradient(135deg, #222 0%, #111 100%);
            border: 1px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(229, 9, 20, 0.2);
            animation: fadeIn 0.5s;
        }
        .schedule-card-main h2 { margin-top: 0; color: var(--accent); }
        
        .performer-list-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--green);
        }
        
        .upcoming-item {
            display: flex; gap: 15px; align-items: center;
            padding: 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            animation: fadeIn 0.5s;
        }
        .date-badge {
            background: #333; color: white; padding: 10px;
            border-radius: 8px; text-align: center; min-width: 60px;
            border: 1px solid #555;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="top-nav">
        <button onclick="location.href='index.html'" class="btn-back">
            <i class="fa-solid fa-arrow-left"></i> Kembali ke Dashboard
        </button>
        <span style="font-weight:bold;">Agenda Event</span>
    </nav>

    <div class="container">
        
        <!-- FITUR BARU: FILTER LOKASI -->
        <div class="filter-container">
            <i class="fa-solid fa-filter" style="color:var(--primary);"></i>
            <select id="location-filter" class="filter-select">
                <option value="all">-- Tampilkan Semua Lokasi --</option>
                <!-- Opsi Lokasi akan diisi otomatis oleh JS -->
            </select>
        </div>

        <!-- SECTION 1: MINGGU INI -->
        <div class="section-title"><i class="fa-solid fa-fire"></i> Minggu Ini</div>
        
        <div id="main-event-container">
            <div style="text-align:center; padding:50px; color:#888;">
                <i class="fa-solid fa-spinner fa-spin"></i> Memuat jadwal...
            </div>
        </div>

        <!-- SECTION 2: JADWAL MENDATANG -->
        <div class="section-title"><i class="fa-regular fa-calendar"></i> Jadwal Berikutnya (Upcoming)</div>

        <div id="upcoming-event-list">
             <p style="text-align:center; color:#555;">Memuat data...</p>
        </div>

        <br><br>
        <center><small style="color:#666;">Jadwal dapat berubah sewaktu-waktu.</small></center>
    </div>

    <!-- SCRIPT LOGIKA -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. FUNGSI ISI DROPDOWN DARI DATABASE
        async function loadVenueOptions() {
            const select = document.getElementById('location-filter');
            // Ambil data lokasi dari koleksi 'venues'
            const q = query(collection(db, "venues"), orderBy("order", "asc"));
            const snapshot = await getDocs(q);

            snapshot.forEach(doc => {
                const data = doc.data();
                // Buat opsi baru
                const option = document.createElement("option");
                option.value = data.name; // Value sesuai nama lokasi (misal: "Angkringan TWSL")
                option.text = data.name;
                select.appendChild(option);
            });

            // Tambahkan Event Listener: Kalau diganti, load ulang jadwal
            select.addEventListener('change', () => {
                loadSchedule(select.value);
            });
        }

        // 2. FUNGSI LOAD JADWAL (DENGAN FILTER YANG BENAR)
        async function loadSchedule(filterLoc = 'all') {
            const mainContainer = document.getElementById('main-event-container');
            const upcomingContainer = document.getElementById('upcoming-event-list');
            
            // Tampilkan Loading
            mainContainer.innerHTML = '<p style="text-align:center; color:#888;"><i class="fa-solid fa-circle-notch fa-spin"></i> Memuat...</p>';
            upcomingContainer.innerHTML = ''; 
            
            // Ambil semua event urut tanggal
            const q = query(collection(db, "events"), orderBy("date", "asc"));
            const querySnapshot = await getDocs(q);

            // Bersihkan Loading
            mainContainer.innerHTML = '';
            
            // Variabel penanda apakah ada data yang cocok
            let foundAny = false;

            querySnapshot.forEach((doc) => {
                const data = doc.data();

                // === LOGIKA FILTER (BAGIAN PENTING) ===
                // Jika dropdown bukan 'all', DAN lokasi data tidak mengandung kata kunci filter
                // Maka SKIP (jangan tampilkan)
                if (filterLoc !== 'all' && !data.location.includes(filterLoc)) {
                    return; 
                }

                // Jika lolos filter, tandai bahwa data ditemukan
                foundAny = true;

                // TAMPILKAN MAIN EVENT (Jadwal Utama)
                if (data.type === 'main') {
                    let performersHtml = '';
                    if (data.performers && Array.isArray(data.performers)) {
                        data.performers.forEach(p => {
                            performersHtml += `
                            <div class="performer-list-item">
                                <img src="https://via.placeholder.com/50" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                                <div>
                                    <h4 style="margin:0;">${p.name}</h4>
                                    <span style="color:var(--accent); font-size:0.9rem;">${p.time || 'TBA'}</span>
                                    <p style="margin:0; font-size:0.8rem; color:#aaa;">${p.genre || 'Live Music'}</p>
                                </div>
                            </div>`;
                        });
                    }

                    mainContainer.innerHTML += `
                    <div class="schedule-card-main">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div>
                                <h2>${data.displayDate}</h2>
                                <p style="color:#ccc; margin-top:-10px;"><i class="fa-solid fa-location-dot"></i> <b>${data.location}</b></p>
                            </div>
                            <span class="badge active" style="font-size:0.9rem; padding:5px 10px;">ON SCHEDULE</span>
                        </div>
                        <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
                        ${performersHtml}
                    </div>`;
                } 
                
                // TAMPILKAN TOUR (CAFE) DI BAGIAN BAWAH
                else if (data.type === 'tour') {
                    let artName = data.performers && data.performers[0] ? data.performers[0].name : "Guest Star";
                    
                    upcomingContainer.innerHTML += `
                    <div class="upcoming-item" onclick="location.href='cafe-live.html?loc=${encodeURIComponent(data.location)}'" style="cursor:pointer;">
                        <div class="date-badge" style="background:#ff9800; color:black; border:none; min-width:80px;">
                            TOUR
                        </div>
                        <div>
                            <h4 style="margin:0;">${data.location}</h4>
                            <p style="margin:5px 0; font-size:0.8rem; color:#ccc;">Feat: <b style="color:#ff9800;">${artName}</b></p>
                            <span class="badge soon" style="background:#333; color:#aaa;">${data.displayDate}</span>
                        </div>
                    </div>`;
                }
            });

            // JIKA TIDAK ADA DATA YANG COCOK SETELAH FILTER
            if (!foundAny) {
                mainContainer.innerHTML = `
                <div style="text-align:center; padding:50px; border:1px dashed #444; border-radius:10px;">
                    <i class="fa-solid fa-calendar-xmark fa-3x" style="color:#444; margin-bottom:15px;"></i>
                    <h3 style="color:#666;">Belum Ada Jadwal</h3>
                    <p style="color:#888;">Tidak ada event di lokasi <b>${filterLoc === 'all' ? 'manapun' : filterLoc}</b> saat ini.</p>
                </div>`;
            }
        }

        // INIT
        loadVenueOptions(); // Isi dropdown dulu
        loadSchedule('all'); // Load semua jadwal pertama kali
    </script>
</body>
</html>
