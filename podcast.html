<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMIPRO Media Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === BASE STYLE (DARK THEME) === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; }
        
        /* NAVBAR */
        .top-nav { padding: 12px 15px; display: flex; align-items: center; background: #000; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        .btn-back { background: none; border: none; color: white; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        
        /* AREA PLAYER (STAGE) */
        #player-stage { background: #0a0a0a; min-height: 220px; display: flex; align-items: center; justify-content: center; position: relative; border-bottom: 1px solid #333; }
        .video-wrapper { width: 100%; max-width: 800px; aspect-ratio: 16/9; display: none; background: black; }
        .video-wrapper.active { display: block; }
        iframe { width: 100%; height: 100%; border: none; }

        .audio-wrapper { width: 100%; max-width: 600px; padding: 25px 15px; display: none; flex-direction: column; text-align: center; align-items: center; gap: 15px; }
        .audio-wrapper.active { display: flex; }
        .audio-cover { width: 140px; height: 140px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,255,0,0.2); }
        .audio-title { font-size: 1.1rem; font-weight: bold; margin: 0; line-height: 1.3; }
        .audio-artist { font-size: 0.9rem; color: #888; margin: 0; }
        .btn-play-audio { width: 50px; height: 50px; border-radius: 50%; background: #1DB954; color: black; border: none; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* FILTER TAB STICKY */
        .filter-bar { padding: 15px 10px; display: flex; gap: 10px; justify-content: center; position: sticky; top: 55px; background: rgba(0,0,0,0.95); z-index: 90; border-bottom: 1px solid #111; }
        .filter-btn { background: #222; color: #888; border: 1px solid #333; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
        .filter-btn.active { background: white; color: black; font-weight: bold; border-color: white; }

        /* SECTION DIVIDER (GARIS TIPIS) */
        .section-divider { display: flex; align-items: center; margin: 30px 10px 15px 10px; color: #aaa; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        .section-divider::after { content: ""; flex: 1; height: 1px; background: #222; margin-left: 15px; }

        /* CONTENT LISTS */
        #content-list { padding: 0 10px; max-width: 1000px; margin: 0 auto; }
        
        /* GRID STYLE (STREET STAGE) */
        .grid-layout { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; }
        .card-video { background: #111; border-radius: 10px; overflow: hidden; border: 1px solid #222; }
        .cv-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .cv-info { padding: 12px; display: flex; gap: 10px; }
        .cv-avatar { width: 35px; height: 35px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; color: #555; }
        .cv-title { margin: 0 0 4px 0; font-size: 0.95rem; line-height: 1.3; font-weight: 500; }
        .cv-sub { color: #888; font-size: 0.75rem; }

        /* LIST STYLE (SMIPRO TUNES) */
        .list-layout { display: flex; flex-direction: column; gap: 5px; }
        .row-audio { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 8px; border-bottom: 1px solid #111; }
        .ra-img { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; }
        .ra-info { flex: 1; overflow: hidden; }
        .ra-title { font-size: 0.95rem; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ra-artist { font-size: 0.8rem; color: #888; display: flex; align-items: center; gap: 5px; }
        .ra-play-icon { color: #1DB954; font-size: 1.3rem; }

        /* RESPONSIVE TABLET/PC */
        @media (min-width: 600px) {
            .grid-layout { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .audio-wrapper { flex-direction: row; text-align: left; padding: 40px; }
        }
    </style>
</head>
<body>

    <!-- NAVBAR DENGAN LOGO -->
    <nav class="top-nav">
        <button onclick="location.href='index.html'" class="btn-back">
            <i class="fa-solid fa-arrow-left"></i> Kembali
        </button>
        <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
            <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/Logo_Stretart.png" style="height:32px;">
            <span style="font-weight:bold; font-size:0.9rem; letter-spacing:1px;">SMIPRO MEDIA</span>
        </div>
    </nav>

    <!-- PLAYER STAGE -->
    <div id="player-stage">
        <div id="player-placeholder" style="text-align:center; color:#444;">
            <i class="fa-solid fa-play-circle" style="font-size:3rem; margin-bottom:10px;"></i>
            <p style="font-size:0.8rem; margin:0;">Pilih Stage atau Tunes di bawah</p>
        </div>

        <!-- VIDEO PLAYER -->
        <div id="video-player" class="video-wrapper">
            <iframe id="yt-frame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>

        <!-- AUDIO PLAYER -->
        <div id="audio-player" class="audio-wrapper">
            <img id="ap-cover" src="" class="audio-cover">
            <div class="audio-info">
                <div id="ap-title" class="audio-title">-</div>
                <div id="ap-artist" class="audio-artist">-</div>
                <div style="display:flex; align-items:center; gap:15px; margin-top:15px; justify-content:center;">
                    <button class="btn-play-audio" onclick="toggleAudio()">
                        <i class="fa-solid fa-play" id="ap-icon"></i>
                    </button>
                    <audio id="real-audio" style="display:none;"></audio>
                    <div style="flex:1; max-width:200px; height:3px; background:#222; border-radius:2px; position:relative;">
                        <div style="width:0%; height:100%; background:#1DB954; transition:0.5s;" id="audio-fake-progress"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTER KATEGORI -->
    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterContent('all', this)">Semua</button>
        <button class="filter-btn" onclick="filterContent('video', this)">Street Stage</button>
        <button class="filter-btn" onclick="filterContent('audio', this)">Smipro Tunes</button>
    </div>

    <!-- CONTENT LIST (DYNAMIC HYBRID) -->
    <div id="content-list">
        <!-- JS akan mengisi di sini -->
    </div>

    <!-- FOOTER MARKER -->
    <div style="text-align:center; padding:40px 10px; color:#444; font-size:0.75rem; border-top:1px solid #111; margin-top:30px;">
        &copy; 2025 Yayasan Sekolah Konang Indonesia - SMIPRO StreetArt.ID
    </div>

    <!-- SCRIPT UTAMA -->
    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let allData = [];

        async function loadContent() {
            const listContainer = document.getElementById('content-list');
            listContainer.innerHTML = '<p style="text-align:center; color:#555; padding:50px;">Memuat koleksi...</p>';
            
            try {
                const snapshot = await getDocs(query(collection(db, "podcasts")));
                allData = [];
                snapshot.forEach(doc => { allData.push({ id: doc.id, ...doc.data() }); });

                // Sortir Manual berdasarkan timestamp terbaru
                allData.sort((a, b) => {
                    let tA = a.timestamp ? a.timestamp.seconds : 0;
                    let tB = b.timestamp ? b.timestamp.seconds : 0;
                    return tB - tA;
                });

                renderHybridList('all');

            } catch (e) {
                listContainer.innerHTML = '<p style="text-align:center; color:red;">Gagal memuat data.</p>';
            }
        }

        window.filterContent = function(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderHybridList(type);
        }

        function renderHybridList(filterType) {
            const container = document.getElementById('content-list');
            container.innerHTML = '';

            // 1. FILTER & RENDER VIDEO (STREET STAGE)
            if (filterType === 'all' || filterType === 'video') {
                const videos = allData.filter(d => d.mediaType === 'video');
                if (videos.length > 0) {
                    container.innerHTML += `<div class="section-divider">ðŸŽ¬ STREET STAGE</div>`;
                    const grid = document.createElement('div');
                    grid.className = 'grid-layout';
                    
                    videos.forEach(v => {
                        grid.innerHTML += `
                        <div class="card-video" onclick="playMedia('video', '${v.link}', '${v.youtubeId}', '${v.title.replace(/'/g,"\\'")}', '${v.host.replace(/'/g,"\\'")}', '${v.thumb}')">
                            <img src="${v.thumb}" class="cv-thumb">
                            <div class="cv-info">
                                <div class="cv-avatar"><i class="fa-solid fa-video"></i></div>
                                <div class="cv-text">
                                    <h4 class="cv-title">${v.title}</h4>
                                    <div class="cv-sub">${v.host} â€¢ Video</div>
                                </div>
                            </div>
                        </div>`;
                    });
                    container.appendChild(grid);
                }
            }

            // 2. FILTER & RENDER AUDIO (SMIPRO TUNES)
            if (filterType === 'all' || filterType === 'audio') {
                const audios = allData.filter(d => d.mediaType === 'audio');
                if (audios.length > 0) {
                    container.innerHTML += `<div class="section-divider">ðŸŽ§ SMIPRO TUNES</div>`;
                    const list = document.createElement('div');
                    list.className = 'list-layout';

                    audios.forEach(a => {
                        list.innerHTML += `
                        <div class="row-audio" onclick="playMedia('audio', '${a.link}', '', '${a.title.replace(/'/g,"\\'")}', '${a.host.replace(/'/g,"\\'")}', '${a.thumb}')">
                            <img src="${a.thumb}" class="ra-img">
                            <div class="ra-info">
                                <h4 class="ra-title">${a.title}</h4>
                                <div class="ra-artist"><i class="fa-solid fa-music" style="color:#1DB954; font-size:0.7rem;"></i> ${a.host}</div>
                            </div>
                            <i class="fa-solid fa-play-circle ra-play-icon"></i>
                        </div>`;
                    });
                    container.appendChild(list);
                }
            }
        }

        window.playMedia = function(type, link, ytId, title, artist, cover) {
    // === KODE AJAIB PENGUBAH LINK GOOGLE DRIVE ===
    function getDirectLink(url) {
        if (url.includes('drive.google.com')) {
            let fileId = "";
            if (url.includes('/file/d/')) {
                fileId = url.split('/file/d/')[1].split('/')[0];
            } else if (url.includes('id=')) {
                fileId = url.split('id=')[1].split('&')[0];
            }
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
        }
        return url; // Jika bukan drive, biarkan apa adanya
    }
    // =============================================

    const bgm = document.getElementById('bgm-player');
    if (bgm) bgm.pause();

    document.getElementById('player-placeholder').style.display = 'none';
    const vidPlayer = document.getElementById('video-player');
    const audPlayer = document.getElementById('audio-player');
    const ytFrame = document.getElementById('yt-frame');
    const realAudio = document.getElementById('real-audio');

    ytFrame.src = ""; 
    realAudio.pause();
    document.getElementById('audio-fake-progress').style.width = '0%';

    if (type === 'video') {
        audPlayer.classList.remove('active');
        vidPlayer.classList.add('active');
        ytFrame.src = `https://www.youtube.com/embed/${ytId}?autoplay=1`;
    } else {
        vidPlayer.classList.remove('active');
        audPlayer.classList.add('active');
        document.getElementById('ap-cover').src = cover;
        document.getElementById('ap-title').innerText = title;
        document.getElementById('ap-artist').innerText = artist;

        // --- PAKAI LINK YANG SUDAH DISULAP ---
        realAudio.src = getDirectLink(link); 
        realAudio.play().catch(e => alert("File tidak bisa diputar. Pastikan akses Google Drive sudah disetel ke 'Siapa saja yang memiliki link'"));
        
        document.getElementById('ap-icon').className = "fa-solid fa-pause";
        setTimeout(() => { document.getElementById('audio-fake-progress').style.width = '40%'; }, 500);
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

        loadContent();
    </script>
</body>
</html>
