<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMIPRO Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === BASE STYLE (DARK THEME) === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        
        /* NAVBAR */
        .top-nav { padding: 15px; display: flex; align-items: center; gap: 15px; background: #000; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        .btn-back { background: none; border: none; color: white; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        
        /* === AREA PLAYER (STAGE) === */
        #player-stage {
            background: #111;
            padding: 0;
            border-bottom: 1px solid #333;
            min-height: 220px; /* Standar HP */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* 1. TAMPILAN VIDEO PLAYER */
        .video-wrapper { width: 100%; max-width: 800px; aspect-ratio: 16/9; display: none; margin: 0 auto; background: black; }
        .video-wrapper.active { display: block; }
        iframe { width: 100%; height: 100%; border: none; }

        /* 2. TAMPILAN MUSIC PLAYER (SPOTIFY STYLE) */
        .audio-wrapper { 
            width: 100%; max-width: 600px; padding: 20px; 
            display: none; flex-direction: row; gap: 20px; align-items: center; 
        }
        .audio-wrapper.active { display: flex; }
        
        .audio-cover { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,255,0,0.2); }
        .audio-info { flex: 1; }
        .audio-title { font-size: 1.1rem; font-weight: bold; margin: 0 0 5px 0; color: white; line-height: 1.3; }
        .audio-artist { font-size: 0.9rem; color: #b3b3b3; margin: 0 0 15px 0; }
        
        .custom-audio-ctrl { display: flex; align-items: center; gap: 10px; }
        .btn-play-audio { 
            width: 45px; height: 45px; border-radius: 50%; background: #1DB954; color: black; 
            border: none; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.4);
        }

        /* === FILTER TAB (STICKY ON MOBILE) === */
        .filter-bar { 
            padding: 15px 10px; 
            display: flex; gap: 10px; justify-content: center; 
            position: sticky; top: 53px; /* Nempel di bawah Navbar */
            background: rgba(0,0,0,0.95); 
            backdrop-filter: blur(5px);
            z-index: 90; 
            border-bottom: 1px solid #222;
        }
        .filter-btn {
            background: #222; color: #aaa; border: 1px solid #333; 
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: 0.2s;
        }
        .filter-btn.active { background: white; color: black; font-weight: bold; border-color: white; }
        .filter-btn.video-mode.active { background: #ff0000; color: white; border-color: #ff0000; }
        .filter-btn.audio-mode.active { background: #1DB954; color: white; border-color: #1DB954; }

        /* === LIST CONTAINER === */
        #content-list { padding: 10px; max-width: 1000px; margin: 0 auto; }

        /* GAYA 1: YOUTUBE GRID (VIDEO) - Responsif HP */
        .grid-layout { display: grid; grid-template-columns: 1fr; gap: 15px; } /* Default 1 kolom di HP */
        
        .card-video { background: #181818; border-radius: 10px; overflow: hidden; cursor: pointer; transition: 0.2s; border: 1px solid #222; }
        .card-video:active { transform: scale(0.98); } /* Efek klik di HP */
        .cv-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .cv-info { padding: 12px; display: flex; gap: 10px; }
        .cv-avatar { width: 35px; height: 35px; border-radius: 50%; background: #333; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #888; }
        .cv-text { flex: 1; }
        .cv-title { margin: 0 0 4px 0; font-size: 0.95rem; line-height: 1.3; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .cv-sub { color: #aaa; font-size: 0.75rem; }

        /* GAYA 2: SPOTIFY LIST (AUDIO) */
        .list-layout { display: flex; flex-direction: column; gap: 8px; }
        .row-audio { 
            display: flex; align-items: center; gap: 12px; padding: 10px; 
            border-radius: 8px; cursor: pointer; transition: 0.2s; 
            border-bottom: 1px solid #1a1a1a;
        }
        .row-audio:active { background: #222; }
        .ra-img { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; }
        .ra-info { flex: 1; overflow: hidden; } /* Mencegah teks bablas */
        .ra-title { font-size: 0.95rem; color: white; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ra-artist { font-size: 0.8rem; color: #888; display: flex; align-items: center; gap: 5px; }
        .ra-play-icon { color: #1DB954; font-size: 1.5rem; }

        /* === KHUSUS TAMPILAN TABLET/PC (MEDIA QUERY) === */
        @media (min-width: 600px) {
            .grid-layout { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .audio-wrapper { flex-direction: row; text-align: left; }
            .audio-cover { width: 150px; height: 150px; margin: 0; }
        }

        /* === KHUSUS TAMPILAN HP (MEDIA QUERY) === */
        @media (max-width: 599px) {
            /* Player Musik jadi vertikal (Cover di atas) biar cover art kelihatan jelas */
            .audio-wrapper { flex-direction: column; text-align: center; padding: 25px 15px; }
            .audio-cover { width: 140px; height: 140px; margin-bottom: 10px; }
            .audio-info { width: 100%; }
            .custom-audio-ctrl { justify-content: center; margin-top: 10px; }
            
            /* Navbar lebih kecil */
            .top-nav { padding: 12px; }
            
            /* Grid Video tetap 1 kolom tapi margin pas */
            .grid-layout { gap: 20px; }
        }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="top-nav">
        <button onclick="location.href='index.html'" class="btn-back">
            <i class="fa-solid fa-arrow-left"></i> Kembali
        </button>
          <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
            <img src="https://raw.githubusercontent.com/sekolakonangindonesia-prog/smipro-streetart/main/Logo_Stretart.png" style="height:35px;">
        <span style="font-weight:bold; font-size:1rem; margin-left:auto;">SMIPRO Media</span>
        </div>
    </nav>

    <!-- PLAYER STAGE (LAYAR PUTAR) -->
    <div id="player-stage">
        <!-- Placeholder (Kalau belum milih) -->
        <div id="player-placeholder" style="text-align:center; color:#555; padding:20px;">
            <i class="fa-solid fa-play-circle" style="font-size:3rem; margin-bottom:10px; color:#333;"></i>
            <p style="font-size:0.9rem;">Pilih video atau musik di bawah</p>
        </div>

        <!-- 1. VIDEO PLAYER (IFRAME) -->
        <div id="video-player" class="video-wrapper">
            <iframe id="yt-frame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>

        <!-- 2. MUSIC PLAYER (SPOTIFY STYLE) -->
        <div id="audio-player" class="audio-wrapper">
            <img id="ap-cover" src="" class="audio-cover">
            <div class="audio-info">
                <div id="ap-title" class="audio-title">-</div>
                <div id="ap-artist" class="audio-artist">-</div>
                <div class="custom-audio-ctrl">
                    <button class="btn-play-audio" onclick="toggleAudio()">
                        <i class="fa-solid fa-play" id="ap-icon"></i>
                    </button>
                    <!-- Audio Tag Asli (Hidden) -->
                    <audio id="real-audio" controls style="width:100%; height:30px; margin-left:10px; display:none;"></audio>
                    <!-- Progress Bar Manual (Opsional, untuk visual saja bisa ditambah nanti) -->
                    <div style="flex:1; height:4px; background:#333; border-radius:2px; position:relative;">
                        <div style="width:0%; height:100%; background:#1DB954; transition:0.5s;" id="audio-fake-progress"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTER KATEGORI (STICKY) -->
    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterContent('all', this)">Semua</button>
        <button class="filter-btn video-mode" onclick="filterContent('video', this)">Video</button>
        <button class="filter-btn audio-mode" onclick="filterContent('audio', this)">Musik</button>
    </div>

    <!-- CONTENT LIST (HYBRID LAYOUT) -->
    <div id="content-list">
        <p style="text-align:center; color:#666; margin-top:50px;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Memuat koleksi...
        </p>
    </div>

    <!-- FOOTER MARKER -->
    <div style="text-align:center; padding:30px 10px; color:#555; font-size:0.8rem; border-top:1px solid #222; margin-top:20px;">
        &copy; 2025 Yayasan Sekolah Konang Indonesia - SMIPRO StreetArt.ID
    </div>

      <!-- SCRIPT UTAMA (VERSI PERBAIKAN & DIAGNOSA) -->
    <script type="module">
        import { db } from './firebase-config.js';
        // Hapus 'orderBy' sementara untuk tes
        import { collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let allData = [];

        // 1. LOAD DATA DARI FIREBASE
        async function loadContent() {
            const listContainer = document.getElementById('content-list');
            
            try {
                // KITA AMBIL SEMUA DATA DULU (TANPA SORTIR DATABASE)
                // Ini untuk menghindari error "Missing Index" atau "Missing Field"
                const q = query(collection(db, "podcasts"));
                const snapshot = await getDocs(q);

                allData = [];
                snapshot.forEach(doc => {
                    allData.push({ id: doc.id, ...doc.data() });
                });

                // KITA SORTIR MANUAL DI SINI (LEBIH AMAN)
                // Urutkan dari yang terbaru (timestamp besar di atas)
                allData.sort((a, b) => {
                    let timeA = a.timestamp ? a.timestamp.seconds : 0;
                    let timeB = b.timestamp ? b.timestamp.seconds : 0;
                    return timeB - timeA;
                });

                // Render Default (Semua)
                renderList('all');

            } catch (e) {
                // JIKA ERROR, TAMPILKAN DI LAYAR HP AGAR KITA TAHU
                console.error(e);
                listContainer.innerHTML = `
                    <div style="text-align:center; padding:20px; color:#ff5555; border:1px solid #333;">
                        <i class="fa-solid fa-triangle-exclamation"></i> Gagal memuat data.<br>
                        <small>${e.message}</small>
                    </div>`;
            }
        }

        // 2. RENDER LIST (HYBRID LAYOUT)
        window.filterContent = function(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            renderList(type);
        }

        function renderList(filterType) {
            const container = document.getElementById('content-list');
            container.innerHTML = '';

            let useGridLayout = (filterType === 'video');
            
            if (useGridLayout) {
                container.className = 'grid-layout';
            } else {
                container.className = 'list-layout';
            }

            const filteredData = allData.filter(item => filterType === 'all' || item.mediaType === filterType);

            if (filteredData.length === 0) {
                container.innerHTML = '<p style="text-align:center; width:100%; padding:20px; color:#666;">Belum ada konten kategori ini.</p>';
                return;
            }

            filteredData.forEach(d => {
                const isVideo = d.mediaType === 'video';
                const thumb = d.thumb || "https://via.placeholder.com/300";
                const title = d.title || "Tanpa Judul";
                const host = d.host || "Admin";
                
                // DATA STRING SAFE
                const safeTitle = title.replace(/'/g, "\\'");
                const safeHost = host.replace(/'/g, "\\'");
                const safeLink = (d.link || "").replace(/'/g, "\\'");
                const safeThumb = thumb.replace(/'/g, "\\'");
                const ytId = d.youtubeId || "";

                if (useGridLayout) {
                    // TAMPILAN GRID (VIDEO)
                    container.innerHTML += `
                    <div class="card-video" onclick="playMedia('${d.mediaType}', '${safeLink}', '${ytId}', '${safeTitle}', '${safeHost}', '${safeThumb}')">
                        <img src="${thumb}" class="cv-thumb">
                        <div class="cv-info">
                            <div class="cv-avatar"><i class="fa-solid fa-user"></i></div>
                            <div class="cv-text">
                                <h4 class="cv-title">${title}</h4>
                                <div class="cv-sub">${host} â€¢ Video</div>
                            </div>
                        </div>
                    </div>`;
                } else {
                    // TAMPILAN LIST (AUDIO)
                    const iconType = isVideo ? '<i class="fa-brands fa-youtube" style="color:red;"></i>' : '<i class="fa-brands fa-spotify" style="color:#1DB954;"></i>';
                    
                    container.innerHTML += `
                    <div class="row-audio" onclick="playMedia('${d.mediaType}', '${safeLink}', '${ytId}', '${safeTitle}', '${safeHost}', '${safeThumb}')">
                        <img src="${thumb}" class="ra-img">
                        <div class="ra-info">
                            <h4 class="ra-title" style="color:${isVideo ? '#aaa' : 'white'}">${title}</h4>
                            <div class="ra-artist">${iconType} ${host}</div>
                        </div>
                        ${isVideo ? '' : '<i class="fa-solid fa-play-circle ra-play-icon"></i>'}
                    </div>`;
                }
            });
        }

        // 3. FUNGSI PLAY
        window.playMedia = function(type, link, ytId, title, artist, cover) {
            document.getElementById('player-placeholder').style.display = 'none';
            const vidPlayer = document.getElementById('video-player');
            const audPlayer = document.getElementById('audio-player');
            const ytFrame = document.getElementById('yt-frame');
            const realAudio = document.getElementById('real-audio');

            ytFrame.src = "";
            realAudio.pause();
            
            const fakeProg = document.getElementById('audio-fake-progress');
            if(fakeProg) fakeProg.style.width = '0%';

            if (type === 'video') {
                audPlayer.classList.remove('active');
                vidPlayer.classList.add('active');

                let videoId = ytId;
                if(!videoId && link) {
                    if (link.includes("v=")) videoId = link.split("v=")[1].split("&")[0];
                    else if (link.includes("youtu.be/")) videoId = link.split("youtu.be/")[1];
                }
                ytFrame.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;

            } else {
                vidPlayer.classList.remove('active');
                audPlayer.classList.add('active');

                document.getElementById('ap-cover').src = cover;
                document.getElementById('ap-title').innerText = title;
                document.getElementById('ap-artist').innerText = artist;

                realAudio.src = link;
                realAudio.play();
                
                document.getElementById('ap-icon').className = "fa-solid fa-pause";
                
                if(fakeProg) setTimeout(() => { fakeProg.style.width = '30%'; }, 500);
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.toggleAudio = function() {
            const audio = document.getElementById('real-audio');
            const icon = document.getElementById('ap-icon');
            
            if (audio.paused) {
                audio.play();
                icon.className = "fa-solid fa-pause";
            } else {
                audio.pause();
                icon.className = "fa-solid fa-play";
            }
        }
        
        document.getElementById('real-audio').onended = function() {
             document.getElementById('ap-icon').className = "fa-solid fa-play";
             const fakeProg = document.getElementById('audio-fake-progress');
             if(fakeProg) fakeProg.style.width = '0%';
        };

        // Jalankan
        loadContent();

    </script>
</body>
</html>
